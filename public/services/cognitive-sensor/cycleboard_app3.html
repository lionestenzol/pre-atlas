<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CycleBoard - in-PACT Self-Sustaining Bullet Journal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .modal-backdrop { backdrop-filter: blur(2px); }
    .toast { animation: slideIn 0.3s ease-out; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-up { animation: slideUp 0.3s ease-out; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes slideIn {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .progress-ring__circle {
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark body { background-color: #111827; color: #f9fafb; }
    .dark .bg-white { background-color: #1f2937 !important; }
    .dark .text-slate-700 { color: #e5e7eb !important; }
    .dark .text-slate-500 { color: #9ca3af !important; }
    .dark .border { border-color: #374151 !important; }
    .dark .bg-slate-50 { background-color: #374151 !important; }
    .dark .bg-slate-100 { background-color: #4b5563 !important; }
    .dark .hover\:bg-slate-50:hover { background-color: #4b5563 !important; }
    .dark input, .dark textarea, .dark select { 
      background-color: #374151; 
      color: #f9fafb;
      border-color: #4b5563;
    }
  </style>
</head>
<body class="bg-slate-50">
  <!-- COGNITIVE DIRECTIVE BANNER -->
  <div id="cognitive-directive" class="w-full text-white shadow-lg" style="position: sticky; top: 0; z-index: 50; display: none;">
    <div class="max-w-7xl mx-auto p-4">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <div class="text-xs uppercase tracking-wider opacity-75 mb-1">
            <i class="fas fa-brain mr-1"></i> Cognitive Routing System
          </div>
          <div class="flex items-center gap-6">
            <div>
              <div class="text-xs opacity-75">MODE</div>
              <div id="directive-mode" class="text-xl font-bold">--</div>
            </div>
            <div>
              <div class="text-xs opacity-75">RISK</div>
              <div id="directive-risk" class="text-lg font-bold">--</div>
            </div>
            <div>
              <div class="text-xs opacity-75">OPEN LOOPS</div>
              <div id="directive-loops" class="text-lg font-bold">--</div>
            </div>
            <div class="flex-1">
              <div class="text-xs opacity-75">ACTION</div>
              <div id="directive-action" class="text-sm font-medium">Analyzing cognitive state...</div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="openControlPanel()" class="p-2 hover:bg-white/20 rounded-lg transition" title="Open Control Panel">
            <i class="fas fa-sliders-h"></i>
          </button>
          <button onclick="toggleCognitiveBanner()" class="p-2 hover:bg-white/20 rounded-lg transition" title="Minimize">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MINIMIZED COGNITIVE INDICATOR -->
  <div id="cognitive-indicator" class="fixed top-2 right-2 z-50 cursor-pointer" style="display: none;" onclick="toggleCognitiveBanner()">
    <div id="cognitive-indicator-dot" class="w-4 h-4 rounded-full animate-pulse shadow-lg" title="Click to expand cognitive status"></div>
  </div>

  <div id="app" class="min-h-screen flex flex-col md:flex-row">
    <header class="md:hidden flex items-center justify-between p-4 bg-white border-b dark:bg-gray-800 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <button id="mobile-menu-toggle" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700">
          <i class="fas fa-bars"></i>
        </button>
        <div class="text-lg font-bold dark:text-white">CycleBoard</div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700">
          <i class="fas fa-moon dark:text-yellow-300"></i>
        </button>
        <div id="date-display" class="text-sm text-slate-500 dark:text-gray-400"></div>
      </div>
    </header>

    <aside id="sidebar" class="w-64 bg-white border-r p-4 space-y-6 fixed md:static inset-0 z-40 hidden md:block dark:bg-gray-800 dark:border-gray-700 overflow-y-auto">
      <div class="fade-in">
        <div class="text-xs uppercase tracking-wider text-slate-500 dark:text-gray-400 mb-1">
          Plan, execute, and review Aâ€“Z monthly goals
        </div>
        <div class="text-xl font-bold dark:text-white">in-PACT Self-Sustaining Bullet Journal</div>
      </div>
      <nav class="space-y-1" id="nav"></nav>
      
      <div class="mt-8 pt-6 border-t dark:border-gray-700">
        <div class="text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Weekly Progress</div>
        <div class="space-y-2">
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-600 dark:text-gray-400">Tasks Completed</span>
            <span id="weekly-tasks" class="font-semibold dark:text-white">0/0</span>
          </div>
          <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2">
            <div id="weekly-progress-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
          </div>
        </div>
      </div>
      
      <div class="mt-4 space-y-2">
        <button onclick="exportState()" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 dark:text-gray-300 hover:bg-slate-50 dark:hover:bg-gray-700 rounded-lg">
          <i class="fas fa-download"></i>
          <span>Export Data</span>
        </button>
        <button onclick="showImportModal()" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 dark:text-gray-300 hover:bg-slate-50 dark:hover:bg-gray-700 rounded-lg">
          <i class="fas fa-upload"></i>
          <span>Import Data</span>
        </button>
        <button onclick="clearData()" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg">
          <i class="fas fa-trash-alt"></i>
          <span>Clear All Data</span>
        </button>
      </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-auto pb-20 md:pb-8" id="main-content">
      <div class="max-w-6xl mx-auto">
        </div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t dark:bg-gray-800 dark:border-gray-700 flex justify-around py-3">
      <button onclick="navigate('Home')" class="flex flex-col items-center p-2 dark:text-gray-300">
        <i class="fas fa-home text-lg"></i>
        <span class="text-xs mt-1">Home</span>
      </button>
      <button onclick="navigate('Daily')" class="flex flex-col items-center p-2 dark:text-gray-300">
        <i class="fas fa-calendar-day text-lg"></i>
        <span class="text-xs mt-1">Daily</span>
      </button>
      <button onclick="navigate('AtoZ')" class="flex flex-col items-center p-2 dark:text-gray-300">
        <i class="fas fa-tasks text-lg"></i>
        <span class="text-xs mt-1">A-Z</span>
      </button>
      <button onclick="navigate('Journal')" class="flex flex-col items-center p-2 dark:text-gray-300">
        <i class="fas fa-book text-lg"></i>
        <span class="text-xs mt-1">Journal</span>
      </button>
    </nav>
  </div>

  <div id="modal-container"></div>
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

  <script>
    class CycleBoardState {
      constructor() {
        this.saveDebounceTimer = null;
        this.history = [];
        this.historyIndex = -1;
        this.maxHistorySize = 50;
        this.loadFromStorage();
        if (!this.state || !this.state.AZTask) {
          this.state = this.getDefaultState();
          this.saveToStorage();
        }
        this.initializeDates();
        this.pushHistory(); // Initial state
      }
      
      getDefaultState() {
        return {
          version: '2.0',
          screen: 'Home',
          AZTask: [
            { id: 'a1', letter: 'A', task: 'Define Monthly Focus', status: 'Not Started', notes: '', createdAt: new Date().toISOString() },
            { id: 'b1', letter: 'B', task: 'Draft A/B/C day templates', status: 'In Progress', notes: '', createdAt: new Date().toISOString() },
          ],
          DayPlans: {},
          FocusArea: [
            { id: 'fa1', name: 'Production', definition: 'Increase output and efficiency', color: '#3B82F6', tasks: [] },
            { id: 'fa2', name: 'Image', definition: 'Build brand and presentation', color: '#10B981', tasks: [] },
            { id: 'fa3', name: 'Growth', definition: 'Learning and skill development', color: '#8B5CF6', tasks: [] },
            { id: 'fa4', name: 'Personal', definition: 'Well-being and relationships', color: '#F59E0B', tasks: [] },
            { id: 'fa5', name: 'Errands', definition: 'Logistics to reduce friction', color: '#EF4444', tasks: [] },
            { id: 'fa6', name: 'Network', definition: 'Expand and nurture connections', color: '#EC4899', tasks: [] }
          ],
          Routine: {
            Morning: ['Hydrate', 'Weather check', 'Oral care', 'Shower', 'Skincare', 'Dress', 'Pack essentials', 'Breakfast', 'Tidy space', 'Walk/Stretch', 'High-priority task'],
            Commute: ['Grab essentials (keys, phone, wallet)', 'Weather check', 'Lock up and leave', 'Enter car/transport', 'Set navigation/playlist', 'Mental prep for day', 'Arrive 15 min early', 'Intentional downtime (10 min)', 'Gather belongings', 'Strategic downtime (5 min)', 'First task setup'],
            Evening: ['Light tidy', 'Prep bag', 'Plan tomorrow', 'Gratitude entry']
          },
          // Day Type Templates - customizable schedules per day type
          DayTypeTemplates: {
            A: {
              name: 'Optimal Day',
              description: 'Full energy, maximum output',
              timeBlocks: [
                { time: '6:00 AM', title: 'Morning Routine', duration: 60 },
                { time: '7:00 AM', title: 'Commute / Prep', duration: 30 },
                { time: '7:30 AM', title: 'Deep Work Block 1', duration: 90 },
                { time: '9:00 AM', title: 'Break / Recharge', duration: 15 },
                { time: '9:15 AM', title: 'Deep Work Block 2', duration: 90 },
                { time: '10:45 AM', title: 'Admin / Email', duration: 30 },
                { time: '11:15 AM', title: 'Deep Work Block 3', duration: 90 },
                { time: '12:45 PM', title: 'Lunch Break', duration: 45 },
                { time: '1:30 PM', title: 'Deep Work Block 4', duration: 90 },
                { time: '3:00 PM', title: 'Meetings / Collaboration', duration: 60 },
                { time: '4:00 PM', title: 'Wrap-up / Planning', duration: 30 },
                { time: '4:30 PM', title: 'Evening Routine', duration: 30 }
              ],
              routines: ['Morning', 'Commute', 'Evening'],
              goals: { baseline: 'Complete 4 deep work blocks', stretch: 'Clear inbox + bonus task' }
            },
            B: {
              name: 'Low Energy Day',
              description: 'Conserve energy, focus on essentials',
              timeBlocks: [
                { time: '7:00 AM', title: 'Light Morning Routine', duration: 45 },
                { time: '7:45 AM', title: 'Easy Start Task', duration: 45 },
                { time: '8:30 AM', title: 'Focus Block 1', duration: 60 },
                { time: '9:30 AM', title: 'Break / Walk', duration: 20 },
                { time: '9:50 AM', title: 'Focus Block 2', duration: 60 },
                { time: '10:50 AM', title: 'Admin / Light Tasks', duration: 40 },
                { time: '11:30 AM', title: 'Early Lunch', duration: 60 },
                { time: '12:30 PM', title: 'Focus Block 3', duration: 60 },
                { time: '1:30 PM', title: 'Rest / Recharge', duration: 30 },
                { time: '2:00 PM', title: 'Light Work / Wrap-up', duration: 60 },
                { time: '3:00 PM', title: 'Evening Routine', duration: 30 }
              ],
              routines: ['Morning', 'Evening'],
              goals: { baseline: 'Complete 3 focus blocks', stretch: 'One bonus task if energy allows' }
            },
            C: {
              name: 'Chaos Day',
              description: 'Survival mode - one priority only',
              timeBlocks: [
                { time: '8:00 AM', title: 'Minimal Morning', duration: 30 },
                { time: '8:30 AM', title: 'Identify ONE Priority', duration: 15 },
                { time: '8:45 AM', title: 'Priority Task', duration: 90 },
                { time: '10:15 AM', title: 'Break / Assess', duration: 15 },
                { time: '10:30 AM', title: 'Continue Priority or Pivot', duration: 60 },
                { time: '11:30 AM', title: 'Lunch / Reset', duration: 60 },
                { time: '12:30 PM', title: 'Damage Control / Urgent Only', duration: 90 },
                { time: '2:00 PM', title: 'Wrap Minimum Viable Day', duration: 30 },
                { time: '2:30 PM', title: 'Rest / Tomorrow Prep', duration: 30 }
              ],
              routines: ['Evening'],
              goals: { baseline: 'Complete ONE priority task', stretch: 'Survive and reset for tomorrow' }
            }
          },
          Settings: {
            darkMode: false,
            notifications: true,
            autoSave: true,
            defaultDayType: 'A'
          },
          History: {
            completedTasks: [],
            productivityScore: 0,
            streak: 0,
            timeline: []
          },
          Journal: [],
          EightSteps: {}, // Track 8 Steps to Success per day - key: date, value: step completions
          Contingencies: {
            runningLate: { enabled: true, actions: ['Skip non-essentials', 'Prioritize first task', 'Communicate with stakeholders'] },
            lowEnergy: { enabled: true, actions: ['Switch to B-Day mode', 'Focus on baseline only', 'Take frequent breaks'] },
            freeTime: { enabled: true, actions: ['Quick wins from list', 'Prep for tomorrow', 'Recharge if needed'] },
            disruption: { enabled: true, actions: ['Reassess priorities', 'Delegate non-urgent', 'Focus on one task'] }
          },
          Reflections: {
            weekly: [],
            monthly: [],
            quarterly: [],
            yearly: []
          },
          MomentumWins: [] // Daily small wins log
        };
      }
      
      initializeDates() {
        const today = this.getTodayDate();
        if (!this.state.DayPlans[today]) {
          this.state.DayPlans[today] = this.createDefaultDayPlan();
        }
      }
      
      createDefaultDayPlan() {
        return {
          id: this.generateId(),
          date: this.getTodayDate(),
          day_type: this.state.Settings.defaultDayType,
          time_blocks: [
            { id: this.generateId(), time: '06:00', title: 'Morning Routine', completed: false },
            { id: this.generateId(), time: '08:00', title: 'Deep Work Block', completed: false },
            { id: this.generateId(), time: '12:00', title: 'Break / Walk', completed: false },
            { id: this.generateId(), time: '13:00', title: 'Execution Block', completed: false },
            { id: this.generateId(), time: '18:00', title: 'Evening Routine', completed: false }
          ],
          baseline_goal: { text: 'Ship 1 meaningful outcome', completed: false },
          stretch_goal: { text: 'Ship 2 outcomes + review', completed: false },
          focus_areas: [],
          routines_completed: {},
          notes: '',
          rating: 0,
          progress_snapshots: [],
          final_progress: 0
        };
      }
      
      getTodayDate() {
        return new Date().toISOString().slice(0, 10);
      }
      
      generateId() {
        return Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
      }
      
      loadFromStorage() {
        try {
          const saved = localStorage.getItem('cycleboard-state');
          if (saved) {
            this.state = JSON.parse(saved);
            if (!this.state.version) {
              this.migrateFromV1();
            }
            // Ensure History.timeline exists
            if (!this.state.History) {
              this.state.History = this.getDefaultState().History;
            }
            if (!this.state.History.timeline) {
              this.state.History.timeline = [];
            }
            // Ensure Journal exists
            if (!this.state.Journal) {
              this.state.Journal = [];
            }
            // Ensure new state properties exist
            if (!this.state.EightSteps) {
              this.state.EightSteps = {};
            }
            if (!this.state.Contingencies) {
              this.state.Contingencies = this.getDefaultState().Contingencies;
            }
            if (!this.state.Reflections) {
              this.state.Reflections = { weekly: [], monthly: [], quarterly: [], yearly: [] };
            }
            if (!this.state.MomentumWins) {
              this.state.MomentumWins = [];
            }
            // Ensure DayTypeTemplates exist with proper structure
            if (!this.state.DayTypeTemplates ||
                !this.state.DayTypeTemplates.A?.timeBlocks?.length ||
                !this.state.DayTypeTemplates.B?.timeBlocks?.length ||
                !this.state.DayTypeTemplates.C?.timeBlocks?.length) {
              this.state.DayTypeTemplates = this.getDefaultState().DayTypeTemplates;
            }
          }
        } catch (e) {
          console.error('Failed to load state:', e);
          this.state = this.getDefaultState();
        }
      }
      
      migrateFromV1() {
        if (Array.isArray(this.state.DayPlans)) {
          const dayPlansObj = {};
          this.state.DayPlans.forEach(plan => {
            dayPlansObj[plan.date] = plan;
          });
          this.state.DayPlans = dayPlansObj;
        }
        this.state.version = '2.0';
        this.state.Settings = this.getDefaultState().Settings;
        this.state.History = this.getDefaultState().History;
        if (!this.state.History.timeline) {
          this.state.History.timeline = [];
        }
      }
      
      saveToStorage() {
        try {
          localStorage.setItem('cycleboard-state', JSON.stringify(this.state));
        } catch (e) {
          console.error('Failed to save state:', e);

          if (e.name === 'QuotaExceededError') {
            // Storage quota exceeded - clean up old data
            this.cleanupOldData();

            // Try again after cleanup
            try {
              localStorage.setItem('cycleboard-state', JSON.stringify(this.state));
              if (typeof UI !== 'undefined') {
                UI.showToast('Storage Warning', 'Cleaned up old data to save space', 'warning');
              }
            } catch (retryError) {
              if (typeof UI !== 'undefined') {
                UI.showToast('Storage Full', 'Please export and clear old data', 'error');
              }
            }
          } else {
            if (typeof UI !== 'undefined') {
              UI.showToast('Save Error', 'Failed to save data locally', 'error');
            }
          }
        }
      }

      cleanupOldData() {
        // Remove old completed tasks (keep last 50)
        if (this.state.History.completedTasks && this.state.History.completedTasks.length > 50) {
          this.state.History.completedTasks = this.state.History.completedTasks
            .sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt))
            .slice(0, 50);
        }

        // Remove old timeline activities (keep last 100)
        if (this.state.History.timeline && this.state.History.timeline.length > 100) {
          this.state.History.timeline = this.state.History.timeline
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .slice(0, 100);
        }

        // Remove old day plans (keep last 30 days)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const cutoffDate = thirtyDaysAgo.toISOString().slice(0, 10);

        Object.keys(this.state.DayPlans).forEach(date => {
          if (date < cutoffDate) {
            delete this.state.DayPlans[date];
          }
        });
      }
      
      update(updates) {
        Object.assign(this.state, updates);
        this.pushHistory(); // Save state for undo/redo
        if (this.state.Settings.autoSave) {
          this.saveDebounced();
        }
      }

      saveDebounced() {
        clearTimeout(this.saveDebounceTimer);
        this.saveDebounceTimer = setTimeout(() => {
          this.saveToStorage();
        }, 1000); // Save 1 second after last change
      }

      pushHistory() {
        // Remove any states after current index (when undoing and making new changes)
        this.history = this.history.slice(0, this.historyIndex + 1);

        // Add current state as a deep copy
        this.history.push(JSON.parse(JSON.stringify(this.state)));

        // Limit history size
        if (this.history.length > this.maxHistorySize) {
          this.history.shift();
        } else {
          this.historyIndex++;
        }
      }

      undo() {
        if (this.historyIndex > 0) {
          this.historyIndex--;
          this.state = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
          this.saveDebounced();
          return true;
        }
        return false;
      }

      redo() {
        if (this.historyIndex < this.history.length - 1) {
          this.historyIndex++;
          this.state = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
          this.saveDebounced();
          return true;
        }
        return false;
      }

      canUndo() {
        return this.historyIndex > 0;
      }

      canRedo() {
        return this.historyIndex < this.history.length - 1;
      }
      
      getState() {
        return { ...this.state };
      }
    }

    const stateManager = new CycleBoardState();
    let state = stateManager.getState();
    let azFilter = 'all';
    let azSearch = '';

    // Data Validation
    class DataValidator {
      static validateTask(task) {
        const errors = [];

        if (!task.letter || task.letter.length !== 1) {
          errors.push('Task must have a single letter');
        }

        if (!task.task || task.task.trim().length < 2) {
          errors.push('Task description must be at least 2 characters');
        }

        if (task.task && task.task.length > 500) {
          errors.push('Task description too long (max 500 characters)');
        }

        if (task.notes && task.notes.length > 2000) {
          errors.push('Notes too long (max 2000 characters)');
        }

        if (!['Not Started', 'In Progress', 'Completed'].includes(task.status)) {
          errors.push('Invalid task status');
        }

        return errors;
      }

      static validateDayPlan(plan) {
        const errors = [];

        if (!plan.date || !/^\d{4}-\d{2}-\d{2}$/.test(plan.date)) {
          errors.push('Invalid date format (use YYYY-MM-DD)');
        }

        if (!['A', 'B', 'C'].includes(plan.day_type)) {
          errors.push('Invalid day type (must be A, B, or C)');
        }

        if (plan.rating && (plan.rating < 0 || plan.rating > 5)) {
          errors.push('Rating must be between 0 and 5');
        }

        return errors;
      }

      static validateRoutineStep(step) {
        const errors = [];

        if (!step || step.trim().length === 0) {
          errors.push('Routine step cannot be empty');
        }

        if (step && step.length > 200) {
          errors.push('Routine step too long (max 200 characters)');
        }

        return errors;
      }

      static validateImportData(data) {
        const errors = [];

        if (!data || typeof data !== 'object') {
          errors.push('Invalid data format');
          return errors;
        }

        // Required core fields (must exist for valid backup)
        if (!data.version) {
          errors.push('Data version missing');
        }

        if (!data.AZTask || !Array.isArray(data.AZTask)) {
          errors.push('Invalid or missing AZTask array');
        }

        if (!data.DayPlans || typeof data.DayPlans !== 'object') {
          errors.push('Invalid or missing DayPlans');
        }

        if (!data.Routine || typeof data.Routine !== 'object') {
          errors.push('Invalid or missing Routine');
        }

        // Validate AZTask items structure
        if (data.AZTask && Array.isArray(data.AZTask)) {
          data.AZTask.forEach((task, idx) => {
            if (!task.id || !task.letter || !task.task) {
              errors.push(`AZTask[${idx}] missing required fields (id, letter, task)`);
            }
          });
        }

        // Validate FocusArea if present
        if (data.FocusArea && !Array.isArray(data.FocusArea)) {
          errors.push('FocusArea must be an array');
        }

        // Validate DayTypeTemplates structure if present
        if (data.DayTypeTemplates && typeof data.DayTypeTemplates === 'object') {
          ['A', 'B', 'C'].forEach(type => {
            if (data.DayTypeTemplates[type]) {
              const template = data.DayTypeTemplates[type];
              if (template.timeBlocks && !Array.isArray(template.timeBlocks)) {
                errors.push(`DayTypeTemplates.${type}.timeBlocks must be an array`);
              }
              if (template.routines && !Array.isArray(template.routines)) {
                errors.push(`DayTypeTemplates.${type}.routines must be an array`);
              }
            }
          });
        }

        // Validate Settings structure if present
        if (data.Settings && typeof data.Settings !== 'object') {
          errors.push('Settings must be an object');
        }

        // Validate Journal if present
        if (data.Journal && !Array.isArray(data.Journal)) {
          errors.push('Journal must be an array');
        }

        // Validate MomentumWins if present
        if (data.MomentumWins && !Array.isArray(data.MomentumWins)) {
          errors.push('MomentumWins must be an array');
        }

        // Validate Reflections structure if present
        if (data.Reflections && typeof data.Reflections === 'object') {
          ['weekly', 'monthly', 'quarterly', 'yearly'].forEach(period => {
            if (data.Reflections[period] && !Array.isArray(data.Reflections[period])) {
              errors.push(`Reflections.${period} must be an array`);
            }
          });
        }

        return errors;
      }

      static migrateImportData(imported, defaultState) {
        // Deep merge imported data with defaults to fill missing features
        const migrated = { ...imported };

        // Track what was migrated for user feedback
        const migratedFeatures = [];

        // Ensure all top-level features exist
        const featureDefaults = {
          FocusArea: { check: Array.isArray, default: defaultState.FocusArea },
          DayTypeTemplates: { check: (v) => v && typeof v === 'object', default: defaultState.DayTypeTemplates },
          Settings: { check: (v) => v && typeof v === 'object', default: defaultState.Settings },
          History: { check: (v) => v && typeof v === 'object', default: defaultState.History },
          Journal: { check: Array.isArray, default: defaultState.Journal },
          EightSteps: { check: (v) => v && typeof v === 'object', default: defaultState.EightSteps },
          Contingencies: { check: (v) => v && typeof v === 'object', default: defaultState.Contingencies },
          Reflections: { check: (v) => v && typeof v === 'object', default: defaultState.Reflections },
          MomentumWins: { check: Array.isArray, default: defaultState.MomentumWins }
        };

        for (const [feature, config] of Object.entries(featureDefaults)) {
          if (!migrated[feature] || !config.check(migrated[feature])) {
            migrated[feature] = config.default;
            migratedFeatures.push(feature);
          }
        }

        // Merge Settings (preserve user settings, add missing ones)
        if (imported.Settings && typeof imported.Settings === 'object') {
          migrated.Settings = { ...defaultState.Settings, ...imported.Settings };
        }

        // Merge History (preserve user history, add missing fields)
        if (imported.History && typeof imported.History === 'object') {
          migrated.History = {
            completedTasks: imported.History.completedTasks || [],
            productivityScore: imported.History.productivityScore || 0,
            streak: imported.History.streak || 0,
            timeline: imported.History.timeline || []
          };
        }

        // Merge Reflections (preserve existing, add missing periods)
        if (imported.Reflections && typeof imported.Reflections === 'object') {
          migrated.Reflections = {
            weekly: imported.Reflections.weekly || [],
            monthly: imported.Reflections.monthly || [],
            quarterly: imported.Reflections.quarterly || [],
            yearly: imported.Reflections.yearly || []
          };
        }

        // Merge Contingencies (preserve existing, add missing types)
        if (imported.Contingencies && typeof imported.Contingencies === 'object') {
          migrated.Contingencies = { ...defaultState.Contingencies, ...imported.Contingencies };
        }

        // Ensure DayTypeTemplates has all types (A, B, C)
        if (migrated.DayTypeTemplates) {
          ['A', 'B', 'C'].forEach(type => {
            if (!migrated.DayTypeTemplates[type]) {
              migrated.DayTypeTemplates[type] = defaultState.DayTypeTemplates[type];
              if (!migratedFeatures.includes('DayTypeTemplates')) {
                migratedFeatures.push(`DayTypeTemplates.${type}`);
              }
            }
          });
        }

        // Update version to current
        migrated.version = defaultState.version;

        return { migrated, migratedFeatures };
      }
    }

    const UI = {
      // Sanitize HTML to prevent XSS attacks
      sanitize(input) {
        if (input === null || input === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(input);
        return div.innerHTML;
      },

      showToast(title, description, type = 'info') {
        const colors = {
          success: 'bg-green-50 border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-300',
          error: 'bg-red-50 border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-300',
          warning: 'bg-yellow-50 border-yellow-200 text-yellow-800 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-300',
          info: 'bg-blue-50 border-blue-200 text-blue-800 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-300'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast border rounded-lg shadow-lg p-4 min-w-[300px] ${colors[type]}`;
        toast.innerHTML = `
          <div class="flex items-center gap-3">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <div>
              <div class="font-semibold">${UI.sanitize(title)}</div>
              ${description ? `<div class="text-sm opacity-80 mt-1">${UI.sanitize(description)}</div>` : ''}
            </div>
          </div>
        `;
        
        const container = document.getElementById('toast-container');
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(10px)';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      },
      
      showModal(content) {
        const modal = document.createElement('div');
        modal.className = 'modal-backdrop fixed inset-0 z-50 flex items-center justify-center fade-in';
        modal.innerHTML = `
          <div class="fixed inset-0 bg-black/50" onclick="UI.closeModal()"></div>
          <div class="relative z-50 bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-auto slide-up">
            ${content}
          </div>
        `;
        document.getElementById('modal-container').appendChild(modal);
        document.body.style.overflow = 'hidden';
      },
      
      closeModal() {
        const container = document.getElementById('modal-container');
        container.innerHTML = '';
        document.body.style.overflow = '';
      },
      
      renderProgressRing(percentage, size = 40, stroke = 4) {
        const radius = (size - stroke) / 2;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percentage / 100) * circumference;
        
        return `
          <svg width="${size}" height="${size}" class="progress-ring">
            <circle
              class="progress-ring__circle"
              stroke="#e5e7eb"
              stroke-width="${stroke}"
              fill="transparent"
              r="${radius}"
              cx="${size / 2}"
              cy="${size / 2}"
            />
            <circle
              class="progress-ring__circle"
              stroke="${percentage >= 70 ? '#10B981' : percentage >= 40 ? '#F59E0B' : '#EF4444'}"
              stroke-width="${stroke}"
              fill="transparent"
              r="${radius}"
              cx="${size / 2}"
              cy="${size / 2}"
              stroke-dasharray="${circumference}"
              stroke-dashoffset="${offset}"
            />
            <text
              x="50%"
              y="50%"
              text-anchor="middle"
              dy="0.3em"
              class="text-xs font-bold dark:fill-white"
              fill="currentColor"
            >${percentage}%</text>
          </svg>
        `;
      },
      
      updateDateDisplay() {
        const dateEl = document.getElementById('date-display');
        if (dateEl) {
          const now = new Date();
          const options = { weekday: 'short', month: 'short', day: 'numeric' };
          dateEl.textContent = now.toLocaleDateString('en-US', options);
        }
      }
    };

    const Helpers = {
      formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });
      },
      
      calculateCompletionPercentage() {
        const total = state.AZTask.length;
        const done = state.AZTask.filter(t => t.status === 'Completed').length;
        return total ? Math.round((done / total) * 100) : 0;
      },
      
      getDayPlan(date = null) {
        const targetDate = date || stateManager.getTodayDate();
        if (!state.DayPlans[targetDate]) {
          state.DayPlans[targetDate] = stateManager.createDefaultDayPlan();
          stateManager.update({ DayPlans: state.DayPlans });
        }
        return state.DayPlans[targetDate];
      },
      
      getWeeklyStats() {
        const today = new Date();
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay());
        
        let completed = 0;
        let total = 0;
        
        for (let i = 0; i < 7; i++) {
          const date = new Date(weekStart);
          date.setDate(weekStart.getDate() + i);
          const dateStr = date.toISOString().slice(0, 10);
          
          if (state.DayPlans[dateStr]) {
            const plan = state.DayPlans[dateStr];
            if (plan.baseline_goal.completed) completed++;
            total++;
          }
        }
        
        return { completed, total, percentage: total ? Math.round((completed / total) * 100) : 0 };
      },
      
      logActivity(type, description, details = {}) {
        if (!state.History.timeline) state.History.timeline = [];

        const activity = {
          id: stateManager.generateId(),
          type: type,
          description: description,
          details: details,
          timestamp: new Date().toISOString()
        };

        state.History.timeline.push(activity);
        stateManager.update({ History: state.History });
      },

      calculateDailyProgress(date = null) {
        const targetDate = date || stateManager.getTodayDate();
        const dayPlan = state.DayPlans[targetDate];

        if (!dayPlan) {
          return {
            overall: 0,
            timeBlocks: { completed: 0, total: 0, percentage: 0 },
            goals: { completed: 0, total: 0, percentage: 0 },
            routines: { completed: 0, total: 0, percentage: 0 },
            focusAreas: { completed: 0, total: 0, percentage: 0 },
            breakdown: []
          };
        }

        // Time Blocks Progress
        const timeBlocksTotal = dayPlan.time_blocks.length;
        const timeBlocksCompleted = dayPlan.time_blocks.filter(b => b.completed).length;
        const timeBlocksPct = timeBlocksTotal ? Math.round((timeBlocksCompleted / timeBlocksTotal) * 100) : 0;

        // Goals Progress
        let goalsCompleted = 0;
        let goalsTotal = 0;
        if (dayPlan.baseline_goal && dayPlan.baseline_goal.text) {
          goalsTotal++;
          if (dayPlan.baseline_goal.completed) goalsCompleted++;
        }
        if (dayPlan.stretch_goal && dayPlan.stretch_goal.text) {
          goalsTotal++;
          if (dayPlan.stretch_goal.completed) goalsCompleted++;
        }
        const goalsPct = goalsTotal ? Math.round((goalsCompleted / goalsTotal) * 100) : 0;

        // Routines Progress
        const routineTypes = Object.keys(state.Routine);
        let routinesCompleted = 0;
        let routinesTotal = routineTypes.length;

        if (dayPlan.routines_completed) {
          routineTypes.forEach(routineName => {
            if (dayPlan.routines_completed[routineName] && dayPlan.routines_completed[routineName].completed) {
              routinesCompleted++;
            }
          });
        }
        const routinesPct = routinesTotal ? Math.round((routinesCompleted / routinesTotal) * 100) : 0;

        // Focus Areas Progress
        let focusTasksCompleted = 0;
        let focusTasksTotal = 0;
        state.FocusArea.forEach(area => {
          if (area.tasks && area.tasks.length > 0) {
            focusTasksTotal += area.tasks.length;
            focusTasksCompleted += area.tasks.filter(t => t.completed).length;
          }
        });
        const focusPct = focusTasksTotal ? Math.round((focusTasksCompleted / focusTasksTotal) * 100) : 0;

        // Calculate Overall Progress (weighted average)
        // Weight: Time blocks 30%, Goals 30%, Routines 25%, Focus 15%
        let overall = 0;
        let totalWeight = 0;

        if (timeBlocksTotal > 0) {
          overall += timeBlocksPct * 0.30;
          totalWeight += 0.30;
        }
        if (goalsTotal > 0) {
          overall += goalsPct * 0.30;
          totalWeight += 0.30;
        }
        if (routinesTotal > 0) {
          overall += routinesPct * 0.25;
          totalWeight += 0.25;
        }
        if (focusTasksTotal > 0) {
          overall += focusPct * 0.15;
          totalWeight += 0.15;
        }

        overall = totalWeight > 0 ? Math.round(overall / totalWeight) : 0;

        return {
          overall,
          timeBlocks: { completed: timeBlocksCompleted, total: timeBlocksTotal, percentage: timeBlocksPct },
          goals: { completed: goalsCompleted, total: goalsTotal, percentage: goalsPct },
          routines: { completed: routinesCompleted, total: routinesTotal, percentage: routinesPct },
          focusAreas: { completed: focusTasksCompleted, total: focusTasksTotal, percentage: focusPct },
          breakdown: [
            { label: 'Time Blocks', completed: timeBlocksCompleted, total: timeBlocksTotal, percentage: timeBlocksPct, icon: 'fa-clock', color: 'blue' },
            { label: 'Goals', completed: goalsCompleted, total: goalsTotal, percentage: goalsPct, icon: 'fa-bullseye', color: 'green' },
            { label: 'Routines', completed: routinesCompleted, total: routinesTotal, percentage: routinesPct, icon: 'fa-list-check', color: 'purple' },
            { label: 'Focus Areas', completed: focusTasksCompleted, total: focusTasksTotal, percentage: focusPct, icon: 'fa-star', color: 'orange' }
          ]
        };
      },

      saveProgressSnapshot(date = null) {
        const targetDate = date || stateManager.getTodayDate();
        const dayPlan = state.DayPlans[targetDate];
        if (!dayPlan) return;

        if (!dayPlan.progress_snapshots) dayPlan.progress_snapshots = [];

        const progress = this.calculateDailyProgress(targetDate);
        const snapshot = {
          timestamp: new Date().toISOString(),
          overall: progress.overall,
          breakdown: progress.breakdown
        };

        dayPlan.progress_snapshots.push(snapshot);
        dayPlan.final_progress = progress.overall;

        stateManager.update({ DayPlans: state.DayPlans });

        // Check for milestones
        this.checkProgressMilestones(progress.overall);
      },

      checkProgressMilestones(progressPct) {
        const milestones = [
          { threshold: 25, message: 'Great start! 25% complete', icon: 'ðŸŒ±' },
          { threshold: 50, message: 'Halfway there! Keep going', icon: 'âš¡' },
          { threshold: 75, message: 'Almost done! 75% complete', icon: 'ðŸ”¥' },
          { threshold: 100, message: 'Perfect day! 100% complete', icon: 'ðŸŽ‰' }
        ];

        const todayDate = stateManager.getTodayDate();
        const completedMilestones = JSON.parse(localStorage.getItem(`milestones-${todayDate}`) || '[]');

        milestones.forEach(milestone => {
          if (progressPct >= milestone.threshold && !completedMilestones.includes(milestone.threshold)) {
            UI.showToast('Milestone Reached!', `${milestone.icon} ${milestone.message}`, 'success');
            completedMilestones.push(milestone.threshold);
            localStorage.setItem(`milestones-${todayDate}`, JSON.stringify(completedMilestones));
          }
        });
      },

      getProgressStreak() {
        const today = new Date();
        let streak = 0;
        let currentDate = new Date(today);

        // Check backwards from today
        while (true) {
          const dateStr = currentDate.toISOString().slice(0, 10);
          const dayPlan = state.DayPlans[dateStr];

          // Consider a day "successful" if progress >= 70%
          if (dayPlan && dayPlan.final_progress >= 70) {
            streak++;
            currentDate.setDate(currentDate.getDate() - 1);
          } else if (dateStr === stateManager.getTodayDate()) {
            // Today doesn't break the streak yet
            currentDate.setDate(currentDate.getDate() - 1);
          } else {
            break;
          }

          // Safety limit
          if (streak > 365) break;
        }

        return streak;
      },

      getProgressHistory(days = 7) {
        const history = [];
        const today = new Date();

        for (let i = days - 1; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(today.getDate() - i);
          const dateStr = date.toISOString().slice(0, 10);
          const dayPlan = state.DayPlans[dateStr];

          history.push({
            date: dateStr,
            dateFormatted: this.formatDate(dateStr),
            progress: dayPlan ? (dayPlan.final_progress || 0) : 0,
            hasData: !!dayPlan
          });
        }

        return history;
      },

      getAverageProgress(days = 7) {
        const history = this.getProgressHistory(days);
        const validDays = history.filter(day => day.hasData);

        if (validDays.length === 0) return 0;

        const sum = validDays.reduce((acc, day) => acc + day.progress, 0);
        return Math.round(sum / validDays.length);
      }
    };

    const screens = [
      { id: 'Home', label: 'Home', icon: 'fa-home' },
      { id: 'Daily', label: 'Daily', icon: 'fa-calendar-day' },
      { id: 'AtoZ', label: 'Aâ€“Z', icon: 'fa-tasks' },
      { id: 'WeeklyFocus', label: 'Weekly Focus', icon: 'fa-bullseye' },
      { id: 'Reflections', label: 'Reflections', icon: 'fa-lightbulb' },
      { id: 'Timeline', label: 'Timeline', icon: 'fa-history' },
      { id: 'Routines', label: 'Routines', icon: 'fa-clock' },
      { id: 'Journal', label: 'Journal', icon: 'fa-book' },
      { id: 'Statistics', label: 'Statistics', icon: 'fa-chart-line' },
      { id: 'Settings', label: 'Settings', icon: 'fa-cog' }
    ];

    function renderNav() {
      const nav = document.getElementById('nav');
      if (!nav) return;
      
      nav.innerHTML = screens.map(s => `
        <button
          onclick="navigate('${s.id}')"
          class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm w-full text-left transition-colors ${state.screen === s.id ? 'bg-blue-50 text-blue-700 border border-blue-200 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-300' : 'hover:bg-slate-50 dark:hover:bg-gray-700 text-slate-700 dark:text-gray-300'}"
        >
          <i class="fas ${s.icon} w-5 h-5"></i>
          <span>${s.label}</span>
          ${s.id === 'Home' && Helpers.calculateCompletionPercentage() > 0 ? `
            <span class="ml-auto text-xs font-semibold px-2 py-1 rounded-full ${Helpers.calculateCompletionPercentage() >= 70 ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300'}">
              ${Helpers.calculateCompletionPercentage()}%
            </span>
          ` : ''}
        </button>
      `).join('');
      
      const weeklyStats = Helpers.getWeeklyStats();
      const weeklyTasksEl = document.getElementById('weekly-tasks');
      const weeklyProgressBarEl = document.getElementById('weekly-progress-bar');
      if (weeklyTasksEl) weeklyTasksEl.textContent = `${weeklyStats.completed}/${weeklyStats.total}`;
      if (weeklyProgressBarEl) weeklyProgressBarEl.style.width = `${weeklyStats.percentage}%`;
    }

    function navigate(screen) {
      state.screen = screen;
      stateManager.update({ screen: state.screen });
      render();
      
      const sidebar = document.getElementById('sidebar');
      if (sidebar && sidebar.classList.contains('block')) {
        sidebar.classList.remove('block');
        sidebar.classList.add('hidden');
      }
    }

    const ScreenRenderers = {
      Home() {
        const completionPct = Helpers.calculateCompletionPercentage();
        const weeklyStats = Helpers.getWeeklyStats();
        const todayPlan = Helpers.getDayPlan();
        
        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <h1 class="text-3xl font-bold tracking-tight dark:text-white">Welcome Back!</h1>
              <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">${Helpers.formatDate(stateManager.getTodayDate())} â€¢ Ready to make today productive?</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-slate-500 dark:text-gray-400">Aâ€“Z Completion</p>
                    <p class="text-2xl font-bold mt-1 dark:text-white">${completionPct}%</p>
                  </div>
                  <div>${UI.renderProgressRing(completionPct)}</div>
                </div>
                <div class="mt-4 text-sm text-slate-600 dark:text-gray-300">
                  ${state.AZTask.filter(t => t.status === 'Completed').length} of ${state.AZTask.length} tasks done
                </div>
              </div>

              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-slate-500 dark:text-gray-400">Weekly Progress</p>
                    <p class="text-2xl font-bold mt-1 dark:text-white">${weeklyStats.percentage}%</p>
                  </div>
                  <i class="fas fa-chart-line text-2xl text-blue-500"></i>
                </div>
                <div class="mt-4 text-sm text-slate-600 dark:text-gray-300">
                  ${weeklyStats.completed} of ${weeklyStats.total} days met baseline
                </div>
              </div>

              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-slate-500 dark:text-gray-400">Today's Focus</p>
                    <p class="text-2xl font-bold mt-1 dark:text-white">${todayPlan.day_type} Day</p>
                  </div>
                  <span class="text-2xl font-bold ${todayPlan.day_type === 'A' ? 'text-blue-600 dark:text-blue-400' : todayPlan.day_type === 'B' ? 'text-green-600 dark:text-green-400' : 'text-purple-600 dark:text-purple-400'}">
                    ${todayPlan.day_type}
                  </span>
                </div>
                <div class="mt-4">
                  <button onclick="navigate('Daily')" class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                    View daily plan â†’
                  </button>
                </div>
              </div>
            </div>

            ${(() => {
              const dailyProgress = Helpers.calculateDailyProgress();
              return `
                <div class="rounded-xl border dark:border-gray-700 bg-gradient-to-br from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-800 p-6 shadow-sm">
                  <div class="flex items-center justify-between mb-4">
                    <div>
                      <h2 class="text-xl font-bold dark:text-white">Today's Progress</h2>
                      <p class="text-sm text-slate-600 dark:text-gray-400">Track your daily completion</p>
                    </div>
                    <div class="text-right">
                      <div class="text-4xl font-bold ${
                        dailyProgress.overall >= 80 ? 'text-green-600 dark:text-green-400' :
                        dailyProgress.overall >= 50 ? 'text-blue-600 dark:text-blue-400' :
                        dailyProgress.overall >= 25 ? 'text-yellow-600 dark:text-yellow-400' :
                        'text-slate-400 dark:text-gray-500'
                      }">${dailyProgress.overall}%</div>
                      <p class="text-xs text-slate-500 dark:text-gray-400 mt-1">Overall</p>
                    </div>
                  </div>

                  <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-3 mb-6">
                    <div class="h-3 rounded-full transition-all ${
                      dailyProgress.overall >= 80 ? 'bg-gradient-to-r from-green-500 to-emerald-500' :
                      dailyProgress.overall >= 50 ? 'bg-gradient-to-r from-blue-500 to-cyan-500' :
                      dailyProgress.overall >= 25 ? 'bg-gradient-to-r from-yellow-500 to-orange-500' :
                      'bg-gradient-to-r from-slate-400 to-slate-500'
                    }" style="width: ${dailyProgress.overall}%"></div>
                  </div>

                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${dailyProgress.breakdown.map(item => `
                      <div class="text-center p-3 bg-white dark:bg-gray-700/50 rounded-lg">
                        <i class="fas ${item.icon} text-${item.color}-500 dark:text-${item.color}-400 text-lg mb-2"></i>
                        <p class="text-xs text-slate-600 dark:text-gray-400 mb-1">${item.label}</p>
                        <p class="text-lg font-bold dark:text-white">${item.percentage}%</p>
                        <p class="text-xs text-slate-500 dark:text-gray-500">${item.completed}/${item.total}</p>
                        <div class="w-full bg-slate-200 dark:bg-gray-600 rounded-full h-1.5 mt-2">
                          <div class="bg-${item.color}-500 h-1.5 rounded-full transition-all" style="width: ${item.percentage}%"></div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `;
            })()}

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <button onclick="openCreateModal()" class="rounded-lg border dark:border-gray-700 bg-white dark:bg-gray-800 p-4 text-center hover:bg-slate-50 dark:hover:bg-gray-700 transition-colors">
                <i class="fas fa-plus-circle text-blue-500 text-xl mb-2"></i>
                <p class="text-sm font-medium dark:text-gray-300">Add Task</p>
              </button>
              <button onclick="navigate('Daily')" class="rounded-lg border dark:border-gray-700 bg-white dark:bg-gray-800 p-4 text-center hover:bg-slate-50 dark:hover:bg-gray-700 transition-colors">
                <i class="fas fa-edit text-green-500 text-xl mb-2"></i>
                <p class="text-sm font-medium dark:text-gray-300">Plan Day</p>
              </button>
              <button onclick="completeAllTodayTasks()" class="rounded-lg border dark:border-gray-700 bg-white dark:bg-gray-800 p-4 text-center hover:bg-slate-50 dark:hover:bg-gray-700 transition-colors">
                <i class="fas fa-check-double text-purple-500 text-xl mb-2"></i>
                <p class="text-sm font-medium dark:text-gray-300">Complete All</p>
              </button>
              <button onclick="navigate('Statistics')" class="rounded-lg border dark:border-gray-700 bg-white dark:bg-gray-800 p-4 text-center hover:bg-slate-50 dark:hover:bg-gray-700 transition-colors">
                <i class="fas fa-chart-bar text-yellow-500 text-xl mb-2"></i>
                <p class="text-sm font-medium dark:text-gray-300">Statistics</p>
              </button>
            </div>

            ${(() => {
              const streak = Helpers.getProgressStreak();
              const history = Helpers.getProgressHistory(7);
              const avgProgress = Helpers.getAverageProgress(7);

              return `
                <div class="grid md:grid-cols-2 gap-4">
                  <!-- Streak Tracker -->
                  <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                      <h2 class="text-lg font-bold dark:text-white">Productivity Streak</h2>
                      <i class="fas fa-fire text-2xl ${streak > 0 ? 'text-orange-500' : 'text-slate-300 dark:text-gray-600'}"></i>
                    </div>
                    <div class="text-center mb-4">
                      <div class="text-5xl font-bold ${streak > 0 ? 'text-orange-500' : 'text-slate-400 dark:text-gray-500'} mb-2">${streak}</div>
                      <p class="text-sm text-slate-600 dark:text-gray-400">${streak === 1 ? 'day' : 'days'} with 70%+ progress</p>
                    </div>
                    ${streak > 0 ? `
                      <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                        <p class="text-sm font-medium ${
                          streak >= 7 ? 'text-orange-700 dark:text-orange-300' : 'text-orange-600 dark:text-orange-400'
                        }">
                          ${streak >= 30 ? 'ðŸ”¥ Legendary! Keep it going!' :
                            streak >= 14 ? 'ðŸ’ª Outstanding streak!' :
                            streak >= 7 ? 'âš¡ One week strong!' :
                            'ðŸŒŸ Great momentum!'}
                        </p>
                      </div>
                    ` : `
                      <div class="text-center p-3 bg-slate-50 dark:bg-gray-700/50 rounded-lg">
                        <p class="text-sm text-slate-600 dark:text-gray-400">Complete today at 70%+ to start your streak!</p>
                      </div>
                    `}
                  </div>

                  <!-- 7-Day Progress History -->
                  <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                      <h2 class="text-lg font-bold dark:text-white">7-Day Overview</h2>
                      <span class="text-sm font-medium ${
                        avgProgress >= 70 ? 'text-green-600 dark:text-green-400' :
                        avgProgress >= 50 ? 'text-blue-600 dark:text-blue-400' :
                        'text-slate-500 dark:text-gray-400'
                      }">${avgProgress}% avg</span>
                    </div>
                    <div class="space-y-2">
                      ${history.map(day => `
                        <div class="flex items-center gap-3">
                          <span class="text-xs text-slate-500 dark:text-gray-400 w-16">${day.dateFormatted.split(',')[0]}</span>
                          <div class="flex-1 bg-slate-200 dark:bg-gray-700 rounded-full h-6 relative overflow-hidden">
                            <div class="${
                              day.progress >= 80 ? 'bg-green-500' :
                              day.progress >= 70 ? 'bg-blue-500' :
                              day.progress >= 50 ? 'bg-yellow-500' :
                              day.progress > 0 ? 'bg-slate-400' :
                              'bg-slate-200 dark:bg-gray-700'
                            } h-6 rounded-full transition-all flex items-center justify-end pr-2"
                                 style="width: ${day.progress}%">
                              ${day.progress > 15 ? `<span class="text-xs font-medium text-white">${day.progress}%</span>` : ''}
                            </div>
                            ${day.progress <= 15 && day.progress > 0 ? `
                              <span class="absolute right-2 top-1 text-xs font-medium text-slate-600 dark:text-gray-300">${day.progress}%</span>
                            ` : ''}
                            ${!day.hasData ? `
                              <span class="absolute inset-0 flex items-center justify-center text-xs text-slate-400 dark:text-gray-500">No data</span>
                            ` : ''}
                          </div>
                          ${day.progress >= 70 ? '<i class="fas fa-check-circle text-green-500 text-sm"></i>' : '<div class="w-4"></div>'}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              `;
            })()}

            ${Object.keys(state.Routine).length > 0 ? `
              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
                <div class="p-6 border-b dark:border-gray-700">
                  <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold dark:text-white">Today's Routines</h2>
                    <button onclick="navigate('Routines')" class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
                      View All â†’
                    </button>
                  </div>
                </div>
                <div class="p-6">
                  <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    ${Object.keys(state.Routine).map(routineName => {
                      const routine = state.Routine[routineName];
                      const completionData = todayPlan.routines_completed?.[routineName] || { completed: false, steps: {} };
                      const completedSteps = Object.values(completionData.steps || {}).filter(Boolean).length;
                      const isComplete = completionData.completed;

                      const colorSchemes = {
                        'Morning': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
                        'Commute': 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300',
                        'Evening': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
                        'Afternoon': 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
                        'Workout': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
                        'Work': 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300'
                      };
                      const colors = colorSchemes[routineName] || 'bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-300';

                      return `
                        <button onclick="navigate('Routines')"
                                class="p-4 rounded-lg border dark:border-gray-700 hover:shadow-md transition-all text-left ${isComplete ? 'ring-2 ring-green-500' : ''}">
                          <div class="flex items-center justify-between mb-2">
                            <span class="px-2 py-1 ${colors} rounded-full text-xs font-medium">
                              ${UI.sanitize(routineName)}
                            </span>
                            ${isComplete ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                          </div>
                          <div class="text-sm text-slate-600 dark:text-gray-400 mb-2">
                            ${completedSteps}/${routine.length} steps
                          </div>
                          <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-1.5">
                            <div class="bg-green-500 h-1.5 rounded-full transition-all"
                                 style="width: ${routine.length ? (completedSteps / routine.length) * 100 : 0}%"></div>
                          </div>
                        </button>
                      `;
                    }).join('')}
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Momentum Wins Tracker -->
            ${(() => {
              const todayDate = stateManager.getTodayDate();
              const todayWins = state.MomentumWins.filter(w => w.date === todayDate);
              const recentWins = state.MomentumWins
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);

              return `
                <div class="rounded-xl border dark:border-gray-700 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-gray-800 dark:to-gray-800 shadow-sm">
                  <div class="p-6 border-b border-green-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                      <div>
                        <h2 class="text-xl font-bold dark:text-white">Momentum Wins</h2>
                        <p class="text-sm text-green-700 dark:text-gray-400 mt-1">Build momentum with small victories</p>
                      </div>
                      <button onclick="addMomentumWin()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-trophy mr-2"></i>Log Win
                      </button>
                    </div>
                  </div>
                  <div class="p-6">
                    <div class="flex items-center gap-4 mb-4">
                      <div class="text-center">
                        <div class="text-3xl font-bold text-green-600 dark:text-green-400">${todayWins.length}</div>
                        <p class="text-xs text-green-700 dark:text-gray-400">Today's Wins</p>
                      </div>
                      <div class="text-center">
                        <div class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">${state.MomentumWins.length}</div>
                        <p class="text-xs text-emerald-700 dark:text-gray-400">Total Wins</p>
                      </div>
                    </div>

                    ${recentWins.length === 0 ? `
                      <div class="text-center py-4">
                        <i class="fas fa-trophy text-3xl text-green-300 dark:text-gray-600 mb-2"></i>
                        <p class="text-green-700 dark:text-gray-400 text-sm">Log your first win to build momentum!</p>
                      </div>
                    ` : `
                      <div class="space-y-2">
                        ${recentWins.map(win => `
                          <div class="flex items-center gap-3 p-3 bg-white dark:bg-gray-700 rounded-lg group">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <div class="flex-1">
                              <p class="text-sm font-medium dark:text-gray-300">${UI.sanitize(win.text)}</p>
                              <p class="text-xs text-slate-500 dark:text-gray-400">
                                ${new Date(win.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                at ${new Date(win.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                              </p>
                            </div>
                            <button onclick="deleteMomentumWin('${win.id}')"
                                    class="p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                              <i class="fas fa-times text-xs"></i>
                            </button>
                          </div>
                        `).join('')}
                      </div>
                    `}
                  </div>
                </div>
              `;
            })()}

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6 border-b dark:border-gray-700">
                <div class="flex items-center justify-between">
                  <h2 class="text-xl font-bold dark:text-white">Recent Aâ€“Z Tasks</h2>
                  <button onclick="navigate('AtoZ')" class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
                    View All â†’
                  </button>
                </div>
              </div>
              <div class="p-6">
                ${state.AZTask.length === 0 ? `
                  <div class="text-center py-8">
                    <i class="fas fa-tasks text-4xl text-slate-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-slate-500 dark:text-gray-400">No tasks yet. Create your first Aâ€“Z task!</p>
                    <button onclick="openCreateModal()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                      Create Task
                    </button>
                  </div>
                ` : `
                  <div class="space-y-3">
                    ${state.AZTask.slice(0, 5).map(task => `
                      <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold
                          ${task.status === 'Completed' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                            task.status === 'In Progress' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' :
                            'bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-300'}">
                          ${task.letter}
                        </div>
                        <div class="flex-1">
                          <p class="font-medium dark:text-gray-300">${UI.sanitize(task.task)}</p>
                          <p class="text-xs text-slate-500 dark:text-gray-400">${UI.sanitize(task.status)}</p>
                        </div>
                        <button onclick="completeTask('${task.id}')" class="p-2 hover:bg-slate-200 dark:hover:bg-gray-600 rounded-lg">
                          <i class="fas fa-check ${task.status === 'Completed' ? 'text-green-600 dark:text-green-400' : 'text-slate-400 dark:text-gray-500'}"></i>
                        </button>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      },
      
      Daily() {
        const todayPlan = Helpers.getDayPlan();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().slice(0, 10);
        const yesterdayPlan = state.DayPlans[yesterdayStr];
        const dailyProgress = Helpers.calculateDailyProgress();

        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <div class="flex items-center justify-between">
                <div>
                  <h1 class="text-3xl font-bold tracking-tight dark:text-white">Daily Plan</h1>
                  <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">${Helpers.formatDate(todayPlan.date)}</p>
                </div>
                <div class="flex items-center gap-4">
                  <div class="text-right hidden md:block">
                    <div class="text-2xl font-bold ${
                      dailyProgress.overall >= 80 ? 'text-green-600 dark:text-green-400' :
                      dailyProgress.overall >= 50 ? 'text-blue-600 dark:text-blue-400' :
                      'text-slate-400 dark:text-gray-500'
                    }">${dailyProgress.overall}%</div>
                    <p class="text-xs text-slate-500 dark:text-gray-400">Progress</p>
                  </div>
                  <button onclick="addTimeBlock()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Add Block
                  </button>
                </div>
              </div>
            </div>

            <div class="rounded-xl border-2 ${
              dailyProgress.overall >= 80 ? 'border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20' :
              dailyProgress.overall >= 50 ? 'border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20' :
              'border-slate-200 dark:border-gray-700 bg-white dark:bg-gray-800'
            } p-5 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold dark:text-white">Today's Completion</h3>
                <span class="text-xl font-bold ${
                  dailyProgress.overall >= 80 ? 'text-green-600 dark:text-green-400' :
                  dailyProgress.overall >= 50 ? 'text-blue-600 dark:text-blue-400' :
                  'text-slate-500 dark:text-gray-400'
                }">${dailyProgress.overall}%</span>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                ${dailyProgress.breakdown.map(item => `
                  <div class="flex items-center gap-2">
                    <i class="fas ${item.icon} text-${item.color}-500 dark:text-${item.color}-400"></i>
                    <span class="text-slate-700 dark:text-gray-300">${item.label}:</span>
                    <span class="font-semibold dark:text-white">${item.completed}/${item.total}</span>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
              <h2 class="text-xl font-bold mb-4 dark:text-white">Day Mode</h2>
              <div class="flex flex-wrap gap-2">
                ${['A', 'B', 'C'].map(type => `
                  <button
                    onclick="setDayType('${type}')"
                    class="px-6 py-3 rounded-lg font-medium transition-all ${
                      todayPlan.day_type === type 
                        ? 'bg-blue-600 text-white shadow-md' 
                        : 'bg-slate-100 text-slate-700 hover:bg-slate-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600'
                    }"
                  >
                    ${type} Day
                    ${type === 'A' ? ' (Deep Focus)' : type === 'B' ? ' (Balanced)' : ' (Recovery)'}
                  </button>
                `).join('')}
              </div>
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6 border-b dark:border-gray-700">
                <h2 class="text-xl font-bold dark:text-white">Time Blocks</h2>
                <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Schedule your day</p>
              </div>
              <div class="p-6">
                <div class="space-y-3">
                  ${todayPlan.time_blocks.map((block, index) => `
                    <div class="flex items-center gap-3 p-3 rounded-lg border dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-500 transition-colors">
                      <input
                        type="time"
                        value="${convertTo24Hour(block.time)}"
                        onchange="updateTimeBlock('${block.id}', 'time', this.value)"
                        class="font-mono text-sm border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1"
                      />
                      <input
                        type="text"
                        value="${UI.sanitize(block.title)}"
                        onchange="updateTimeBlock('${block.id}', 'title', this.value)"
                        class="flex-1 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2"
                        placeholder="What are you doing?"
                      />
                      <button 
                        onclick="toggleTimeBlockCompletion('${block.id}')"
                        class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                          block.completed ? 'bg-green-500 border-green-500' : 'border-slate-300 dark:border-gray-500'
                        }"
                      >
                        ${block.completed ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                      </button>
                      <button onclick="removeTimeBlock('${block.id}')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                <h2 class="text-xl font-bold mb-4 dark:text-white">Baseline Goal (X)</h2>
                <p class="text-slate-600 dark:text-gray-300 mb-4">Minimum accomplishment for today</p>
                <textarea
                  id="baseline-goal"
                  class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg p-3 min-h-[100px]"
                  placeholder="What's the minimum you want to achieve today?"
                >${todayPlan.baseline_goal.text}</textarea>
                <div class="flex items-center justify-between mt-4">
                  <button onclick="toggleGoalCompletion('baseline')" class="flex items-center gap-2 dark:text-gray-300">
                    <div class="w-5 h-5 rounded border flex items-center justify-center ${
                      todayPlan.baseline_goal.completed ? 'bg-green-500 border-green-500' : 'border-slate-300 dark:border-gray-500'
                    }">
                      ${todayPlan.baseline_goal.completed ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                    </div>
                    <span>${todayPlan.baseline_goal.completed ? 'Completed' : 'Mark as done'}</span>
                  </button>
                  <button onclick="saveGoals()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save
                  </button>
                </div>
              </div>

              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                <h2 class="text-xl font-bold mb-4 dark:text-white">Stretch Goal (Y)</h2>
                <p class="text-slate-600 dark:text-gray-300 mb-4">Ambitious target for today</p>
                <textarea
                  id="stretch-goal"
                  class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg p-3 min-h-[100px]"
                  placeholder="What would make today amazing?"
                >${todayPlan.stretch_goal.text}</textarea>
                <div class="flex items-center justify-between mt-4">
                  <button onclick="toggleGoalCompletion('stretch')" class="flex items-center gap-2 dark:text-gray-300">
                    <div class="w-5 h-5 rounded border flex items-center justify-center ${
                      todayPlan.stretch_goal.completed ? 'bg-green-500 border-green-500' : 'border-slate-300 dark:border-gray-500'
                    }">
                      ${todayPlan.stretch_goal.completed ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                    </div>
                    <span>${todayPlan.stretch_goal.completed ? 'Completed' : 'Mark as done'}</span>
                  </button>
                  <button onclick="saveGoals()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Save
                  </button>
                </div>
              </div>
            </div>

            <!-- 8 Steps to Success -->
            ${(() => {
              const todayDate = stateManager.getTodayDate();
              const eightSteps = state.EightSteps[todayDate] || {};
              const steps = [
                { id: 'positiveAttitude', name: 'Positive Attitude', desc: 'Morning affirmation written', icon: 'fa-smile' },
                { id: 'beOnTime', name: 'Be on Time', desc: 'Left 15 min early', icon: 'fa-clock' },
                { id: 'bePrepared', name: 'Be Prepared', desc: 'Top 3 tasks listed', icon: 'fa-list-check' },
                { id: 'workFullDay', name: 'Work Full Day', desc: '4x 90-min blocks planned', icon: 'fa-briefcase' },
                { id: 'workTerritory', name: 'Work Territory', desc: 'High-impact tasks prioritized', icon: 'fa-bullseye' },
                { id: 'greatAttitude', name: 'Great Attitude', desc: 'Gratitude entry written', icon: 'fa-heart' },
                { id: 'knowWhy', name: 'Know Your Why', desc: 'Purpose for top task', icon: 'fa-lightbulb' },
                { id: 'takeControl', name: 'Take Control', desc: '2-hour focus block scheduled', icon: 'fa-crown' }
              ];
              const completedCount = steps.filter(s => eightSteps[s.id]).length;

              return `
                <div class="rounded-xl border dark:border-gray-700 bg-gradient-to-br from-amber-50 to-orange-50 dark:from-gray-800 dark:to-gray-800 shadow-sm">
                  <div class="p-6 border-b border-amber-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                      <div>
                        <h2 class="text-xl font-bold dark:text-white">8 Steps to Success</h2>
                        <p class="text-sm text-amber-700 dark:text-gray-400 mt-1">SMART goal framework for daily excellence</p>
                      </div>
                      <div class="text-right">
                        <div class="text-2xl font-bold ${completedCount === 8 ? 'text-green-600 dark:text-green-400' : 'text-amber-600 dark:text-amber-400'}">${completedCount}/8</div>
                        <p class="text-xs text-amber-700 dark:text-gray-400">Steps Done</p>
                      </div>
                    </div>
                  </div>
                  <div class="p-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                      ${steps.map((step, index) => `
                        <button onclick="toggleEightStep('${step.id}')"
                                class="p-3 rounded-lg border-2 transition-all text-left ${
                                  eightSteps[step.id]
                                    ? 'border-green-500 bg-green-50 dark:bg-green-900/20'
                                    : 'border-amber-200 dark:border-gray-600 hover:border-amber-400 dark:hover:border-gray-500'
                                }">
                          <div class="flex items-center gap-2 mb-1">
                            <i class="fas ${step.icon} ${eightSteps[step.id] ? 'text-green-600 dark:text-green-400' : 'text-amber-600 dark:text-amber-400'}"></i>
                            <span class="text-xs font-bold ${eightSteps[step.id] ? 'text-green-700 dark:text-green-300' : 'text-amber-800 dark:text-gray-300'}">${index + 1}</span>
                          </div>
                          <p class="text-xs font-medium ${eightSteps[step.id] ? 'text-green-700 dark:text-green-300' : 'text-slate-700 dark:text-gray-300'}">${step.name}</p>
                          <p class="text-xs ${eightSteps[step.id] ? 'text-green-600 dark:text-green-400' : 'text-slate-500 dark:text-gray-400'}">${step.desc}</p>
                          ${eightSteps[step.id] ? '<i class="fas fa-check-circle text-green-500 absolute top-2 right-2"></i>' : ''}
                        </button>
                      `).join('')}
                    </div>
                  </div>
                </div>
              `;
            })()}

            <!-- Contingency Quick Actions -->
            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6 border-b dark:border-gray-700">
                <h2 class="text-xl font-bold dark:text-white">Contingency Actions</h2>
                <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Quick adjustments when plans change</p>
              </div>
              <div class="p-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <button onclick="activateContingency('runningLate')" class="p-4 rounded-lg border dark:border-gray-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all text-center">
                    <i class="fas fa-running text-2xl text-red-500 mb-2"></i>
                    <p class="text-sm font-medium dark:text-gray-300">Running Late</p>
                    <p class="text-xs text-slate-500 dark:text-gray-400">Skip non-essentials</p>
                  </button>
                  <button onclick="activateContingency('lowEnergy')" class="p-4 rounded-lg border dark:border-gray-600 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-all text-center">
                    <i class="fas fa-battery-quarter text-2xl text-yellow-500 mb-2"></i>
                    <p class="text-sm font-medium dark:text-gray-300">Low Energy</p>
                    <p class="text-xs text-slate-500 dark:text-gray-400">Switch to B-Day</p>
                  </button>
                  <button onclick="activateContingency('freeTime')" class="p-4 rounded-lg border dark:border-gray-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition-all text-center">
                    <i class="fas fa-gift text-2xl text-green-500 mb-2"></i>
                    <p class="text-sm font-medium dark:text-gray-300">Free Time</p>
                    <p class="text-xs text-slate-500 dark:text-gray-400">Quick wins</p>
                  </button>
                  <button onclick="activateContingency('disruption')" class="p-4 rounded-lg border dark:border-gray-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all text-center">
                    <i class="fas fa-bolt text-2xl text-purple-500 mb-2"></i>
                    <p class="text-sm font-medium dark:text-gray-300">Disruption</p>
                    <p class="text-xs text-slate-500 dark:text-gray-400">Reassess priorities</p>
                  </button>
                </div>
              </div>
            </div>

            ${yesterdayPlan ? `
              <div class="rounded-xl border border-blue-100 dark:border-blue-900 bg-blue-50 dark:bg-blue-900/20 p-6">
                <h3 class="text-lg font-bold text-blue-800 dark:text-blue-300 mb-2">
                  <i class="fas fa-history mr-2"></i>Yesterday's Reflection
                </h3>
                <p class="text-blue-700 dark:text-blue-300">You set "${yesterdayPlan.baseline_goal.text}" as your baseline goal.</p>
                ${yesterdayPlan.baseline_goal.completed ?
                  '<p class="text-green-700 dark:text-green-400 mt-2"><i class="fas fa-check mr-1"></i>Great job completing it!</p>' :
                  '<p class="text-orange-700 dark:text-orange-400 mt-2"><i class="fas fa-lightbulb mr-1"></i>Consider adjusting today\'s goals.</p>'
                }
              </div>
            ` : ''}
          </div>
        `;
      },

      AtoZ() {
        const filteredTasks = state.AZTask.filter(task => {
          const matchesStatus = azFilter === 'all' ||
            (azFilter === 'completed' && task.status === 'Completed') ||
            (azFilter === 'in-progress' && task.status === 'In Progress') ||
            (azFilter === 'not-started' && task.status === 'Not Started');
            
          const searchLower = azSearch.toLowerCase();
          const matchesSearch = !azSearch || 
            task.task.toLowerCase().includes(searchLower) ||
            task.letter.toLowerCase().includes(searchLower) ||
            (task.notes && task.notes.toLowerCase().includes(searchLower));
            
          return matchesStatus && matchesSearch;
        });

        const stats = {
          total: state.AZTask.length,
          completed: state.AZTask.filter(t => t.status === 'Completed').length,
          inProgress: state.AZTask.filter(t => t.status === 'In Progress').length,
          notStarted: state.AZTask.filter(t => t.status === 'Not Started').length
        };
        
        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <h1 class="text-3xl font-bold tracking-tight dark:text-white">Aâ€“Z Tasks</h1>
              <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Plan and track lettered monthly goals</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              ${[
                { label: 'Total Tasks', value: stats.total, color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' },
                { label: 'Completed', value: stats.completed, color: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' },
                { label: 'In Progress', value: stats.inProgress, color: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300' },
                { label: 'Not Started', value: stats.notStarted, color: 'bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-300' }
              ].map(stat => `
                <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-4">
                  <p class="text-sm text-slate-500 dark:text-gray-400">${stat.label}</p>
                  <p class="text-2xl font-bold mt-1 dark:text-white">${stat.value}</p>
                  <div class="mt-2 w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="h-2 rounded-full ${stat.color.split(' ')[0]}" 
                         style="width: ${stats.total ? (stat.value / stats.total) * 100 : 0}%">
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="flex flex-wrap gap-2 justify-between items-center">
              <div class="flex gap-2">
                <button onclick="openCreateModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <i class="fas fa-plus mr-2"></i>Add Task
                </button>
                <button onclick="sortTasks()" class="px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
                  <i class="fas fa-sort-alpha-down mr-2"></i>Sort
                </button>
              </div>
              <div class="flex gap-2">
                <select onchange="filterTasks(this.value)" class="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2">
                  <option value="all" ${azFilter === 'all' ? 'selected' : ''}>All Tasks</option>
                  <option value="completed" ${azFilter === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="in-progress" ${azFilter === 'in-progress' ? 'selected' : ''}>In Progress</option>
                  <option value="not-started" ${azFilter === 'not-started' ? 'selected' : ''}>Not Started</option>
                </select>
                <input 
                  type="text" 
                  id="az-search-input"
                  value="${azSearch}"
                  placeholder="Search tasks..." 
                  onkeyup="searchTasks(this.value)"
                  class="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
                />
              </div>
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6">
                ${filteredTasks.length === 0 ? `
                  <div class="text-center py-12">
                    <i class="fas fa-search text-5xl text-slate-300 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-xl font-semibold text-slate-700 dark:text-gray-300 mb-2">No tasks found</h3>
                    <p class="text-slate-500 dark:text-gray-400 mb-6">Try adjusting your filters or search query</p>
                    ${state.AZTask.length === 0 ? `<button onclick="openCreateModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create First Task</button>` : ''}
                  </div>
                ` : `
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${filteredTasks.map(task => `
                      <div class="border dark:border-gray-700 rounded-xl p-4 hover:shadow-md transition-shadow ${
                        task.status === 'Completed' ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800' :
                        task.status === 'In Progress' ? 'bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800' :
                        'bg-white border-slate-200 dark:bg-gray-800 dark:border-gray-700'
                      }">
                        <div class="flex items-start justify-between mb-3">
                          <div class="flex items-center gap-2">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${
                              task.status === 'Completed' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                              task.status === 'In Progress' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' :
                              'bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-300'
                            }">
                              ${task.letter}
                            </div>
                            <span class="font-medium dark:text-gray-300">${UI.sanitize(task.task)}</span>
                          </div>
                          <span class="text-xs px-2 py-1 rounded-full ${
                            task.status === 'Completed' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                            task.status === 'In Progress' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' :
                            'bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-300'
                          }">
                            ${UI.sanitize(task.status)}
                          </span>
                        </div>

                        ${task.notes ? `
                          <p class="text-sm text-slate-600 dark:text-gray-400 mb-3">${UI.sanitize(task.notes)}</p>
                        ` : ''}
                        
                        <div class="flex justify-between items-center mt-4">
                          <div class="flex gap-1">
                            <button onclick="completeTask('${task.id}')" class="p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg text-green-600 dark:text-green-400">
                              <i class="fas fa-check"></i>
                            </button>
                            <button onclick="openEditModal('${task.id}')" class="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTask('${task.id}')" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg text-red-600 dark:text-red-400">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                          <span class="text-xs text-slate-500 dark:text-gray-400">
                            ${new Date(task.createdAt).toLocaleDateString()}
                          </span>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      },
      
      WeeklyFocus() {
        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <h1 class="text-3xl font-bold tracking-tight dark:text-white">Weekly Focus Areas</h1>
              <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Balance your efforts across these key areas</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${state.FocusArea.map(area => {
                const areaTasks = area.tasks || [];
                const completedTasks = areaTasks.filter(t => t.completed).length;
                const progress = areaTasks.length ? Math.round((completedTasks / areaTasks.length) * 100) : 0;
                
                return `
                  <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                      <h3 class="text-lg font-bold dark:text-white">${UI.sanitize(area.name)}</h3>
                      <div class="w-3 h-3 rounded-full" style="background-color: ${area.color}"></div>
                    </div>
                    <p class="text-slate-600 dark:text-gray-300 mb-4">${UI.sanitize(area.definition)}</p>
                    
                    <div class="space-y-2">
                      <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-500 dark:text-gray-400">This Week</span>
                        <span class="font-medium dark:text-gray-300">${completedTasks}/${areaTasks.length} tasks</span>
                      </div>
                      <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all" style="background-color: ${area.color}; width: ${progress}%"></div>
                      </div>
                    </div>
                    
                    ${areaTasks.length > 0 ? `
                      <div class="mt-4 space-y-2">
                        ${areaTasks.map(task => `
                          <div class="flex items-center gap-2 p-2 rounded-lg bg-slate-50 dark:bg-gray-700">
                            <button onclick="toggleFocusTask('${area.id}', '${task.id}')" class="w-5 h-5 rounded border-2 flex items-center justify-center ${
                              task.completed ? 'bg-green-500 border-green-500' : 'border-slate-300 dark:border-gray-500'
                            }">
                              ${task.completed ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                            </button>
                            <span class="flex-1 text-sm dark:text-gray-300 ${task.completed ? 'line-through opacity-60' : ''}">${UI.sanitize(task.text)}</span>
                            <button onclick="removeFocusTask('${area.id}', '${task.id}')" class="p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-600 dark:text-red-400">
                              <i class="fas fa-times text-xs"></i>
                            </button>
                          </div>
                        `).join('')}
                      </div>
                    ` : ''}
                    
                    <button onclick="addFocusTask('${area.id}')" class="mt-4 w-full text-center py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
                      <i class="fas fa-plus mr-2"></i>Add Task
                    </button>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
              <h3 class="text-xl font-bold mb-4 dark:text-white">Focus Distribution</h3>
              <p class="text-slate-600 dark:text-gray-300 mb-6">Aim for balanced attention across all areas each week</p>
              
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                ${state.FocusArea.map(area => {
                  const taskCount = (area.tasks || []).length;
                  return `
                    <div class="text-center">
                      <div class="w-12 h-12 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold" 
                           style="background-color: ${area.color}">
                        ${taskCount}
                      </div>
                      <p class="text-sm font-medium dark:text-gray-300">${UI.sanitize(area.name)}</p>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        `;
      },
      
      Routines() {
        const routineTypes = Object.keys(state.Routine);
        const todayPlan = Helpers.getDayPlan();
        if (!todayPlan.routines_completed) todayPlan.routines_completed = {};

        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <div class="flex items-center justify-between">
                <div>
                  <h1 class="text-3xl font-bold tracking-tight dark:text-white">Routines</h1>
                  <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Build consistency with daily routines</p>
                </div>
                <button onclick="addNewRoutineType()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <i class="fas fa-plus mr-2"></i>New Routine
                </button>
              </div>
            </div>

            <!-- Today's Routine Tracker -->
            <div class="rounded-xl border-2 border-blue-200 dark:border-blue-800 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 shadow-sm">
              <div class="p-6 border-b border-blue-200 dark:border-blue-800">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="text-xl font-bold text-blue-900 dark:text-blue-100">Today's Routine Log</h2>
                    <p class="text-sm text-blue-700 dark:text-blue-300 mt-1">
                      ${Helpers.formatDate(todayPlan.date)} â€¢ Track your daily routine completion
                    </p>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">
                      ${Object.values(todayPlan.routines_completed).filter(r => r.completed).length}/${routineTypes.length}
                    </div>
                    <p class="text-xs text-blue-700 dark:text-blue-300">Routines Done</p>
                  </div>
                </div>
              </div>
              <div class="p-6">
                ${routineTypes.length === 0 ? `
                  <p class="text-center text-blue-700 dark:text-blue-300 py-8">
                    <i class="fas fa-info-circle mb-2"></i><br>
                    Create your first routine to start tracking
                  </p>
                ` : `
                  <div class="grid md:grid-cols-2 gap-4">
                    ${routineTypes.map(routineName => {
                      const routine = state.Routine[routineName];
                      const completionData = todayPlan.routines_completed[routineName] || { completed: false, steps: {} };
                      const completedSteps = Object.values(completionData.steps || {}).filter(Boolean).length;
                      const isFullyComplete = completionData.completed;

                      const colorSchemes = {
                        'Morning': { bg: 'bg-blue-100 dark:bg-blue-900/30', text: 'text-blue-700 dark:text-blue-300', icon: 'fa-sun' },
                        'Commute': { bg: 'bg-cyan-100 dark:bg-cyan-900/30', text: 'text-cyan-700 dark:text-cyan-300', icon: 'fa-car' },
                        'Evening': { bg: 'bg-purple-100 dark:bg-purple-900/30', text: 'text-purple-700 dark:text-purple-300', icon: 'fa-moon' },
                        'Afternoon': { bg: 'bg-orange-100 dark:bg-orange-900/30', text: 'text-orange-700 dark:text-orange-300', icon: 'fa-cloud-sun' },
                        'Workout': { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-300', icon: 'fa-dumbbell' },
                        'Work': { bg: 'bg-indigo-100 dark:bg-indigo-900/30', text: 'text-indigo-700 dark:text-indigo-300', icon: 'fa-briefcase' }
                      };
                      const colors = colorSchemes[routineName] || {
                        bg: 'bg-slate-100 dark:bg-gray-700',
                        text: 'text-slate-700 dark:text-gray-300',
                        icon: 'fa-list-check'
                      };

                      return `
                        <div class="bg-white dark:bg-gray-800 rounded-lg border dark:border-gray-700 p-4 ${isFullyComplete ? 'ring-2 ring-green-500' : ''}">
                          <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                              <i class="fas ${colors.icon} ${colors.text}"></i>
                              <h3 class="font-bold dark:text-white">${UI.sanitize(routineName)}</h3>
                            </div>
                            <button onclick="toggleRoutineComplete('${routineName}')"
                                    class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${
                                      isFullyComplete
                                        ? 'bg-green-500 border-green-500'
                                        : 'border-slate-300 dark:border-gray-500 hover:border-green-500'
                                    }">
                              ${isFullyComplete ? '<i class="fas fa-check text-white"></i>' : ''}
                            </button>
                          </div>
                          <div class="space-y-1">
                            ${routine.map((step, index) => {
                              const stepCompleted = completionData.steps?.[index] || false;
                              return `
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-50 dark:hover:bg-gray-700 cursor-pointer group">
                                  <input
                                    type="checkbox"
                                    ${stepCompleted ? 'checked' : ''}
                                    onchange="toggleRoutineStep('${routineName}', ${index}, this.checked)"
                                    class="w-4 h-4 rounded border-slate-300 dark:border-gray-600 text-green-600 focus:ring-green-500"
                                  />
                                  <span class="text-sm dark:text-gray-300 flex-1 ${stepCompleted ? 'line-through opacity-60' : ''}">
                                    ${UI.sanitize(step)}
                                  </span>
                                </label>
                              `;
                            }).join('')}
                          </div>
                          <div class="mt-3 pt-3 border-t dark:border-gray-700">
                            <div class="flex items-center justify-between text-xs">
                              <span class="text-slate-600 dark:text-gray-400">Progress</span>
                              <span class="${completedSteps === routine.length ? 'text-green-600 dark:text-green-400 font-bold' : 'text-slate-600 dark:text-gray-400'}">
                                ${completedSteps}/${routine.length} steps
                              </span>
                            </div>
                            <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2 mt-2">
                              <div class="bg-green-500 h-2 rounded-full transition-all"
                                   style="width: ${routine.length ? (completedSteps / routine.length) * 100 : 0}%"></div>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                `}
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              ${routineTypes.map((routineType, typeIndex) => {
                const colorSchemes = {
                  'Morning': { bg: 'bg-blue-100 dark:bg-blue-900/30', text: 'text-blue-700 dark:text-blue-300', icon: 'fa-sun' },
                  'Commute': { bg: 'bg-cyan-100 dark:bg-cyan-900/30', text: 'text-cyan-700 dark:text-cyan-300', icon: 'fa-car' },
                  'Evening': { bg: 'bg-purple-100 dark:bg-purple-900/30', text: 'text-purple-700 dark:text-purple-300', icon: 'fa-moon' },
                  'Afternoon': { bg: 'bg-orange-100 dark:bg-orange-900/30', text: 'text-orange-700 dark:text-orange-300', icon: 'fa-cloud-sun' },
                  'Workout': { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-300', icon: 'fa-dumbbell' },
                  'Work': { bg: 'bg-indigo-100 dark:bg-indigo-900/30', text: 'text-indigo-700 dark:text-indigo-300', icon: 'fa-briefcase' }
                };
                const colors = colorSchemes[routineType] || {
                  bg: 'bg-slate-100 dark:bg-gray-700',
                  text: 'text-slate-700 dark:text-gray-300',
                  icon: 'fa-list-check'
                };

                return `
                  <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
                    <div class="p-6 border-b dark:border-gray-700">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                          <i class="fas ${colors.icon} ${colors.text}"></i>
                          <h2 class="text-xl font-bold dark:text-white">${UI.sanitize(routineType)} Routine</h2>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="px-3 py-1 ${colors.bg} ${colors.text} rounded-full text-sm">
                            ${state.Routine[routineType].length} steps
                          </span>
                          <button onclick="deleteRoutineType('${routineType}')" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg text-red-600 dark:text-red-400">
                            <i class="fas fa-trash text-sm"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="p-6">
                      <div class="space-y-2">
                        ${state.Routine[routineType].map((step, index) => `
                          <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700 group">
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                              <button onclick="moveRoutineStep('${routineType}', ${index}, 'up')"
                                      class="p-1 hover:bg-slate-200 dark:hover:bg-gray-600 rounded ${index === 0 ? 'invisible' : ''}"
                                      title="Move up">
                                <i class="fas fa-chevron-up text-xs text-slate-600 dark:text-gray-400"></i>
                              </button>
                              <button onclick="moveRoutineStep('${routineType}', ${index}, 'down')"
                                      class="p-1 hover:bg-slate-200 dark:hover:bg-gray-600 rounded ${index === state.Routine[routineType].length - 1 ? 'invisible' : ''}"
                                      title="Move down">
                                <i class="fas fa-chevron-down text-xs text-slate-600 dark:text-gray-400"></i>
                              </button>
                            </div>
                            <div class="w-7 h-7 rounded-full ${colors.bg} ${colors.text} flex items-center justify-center font-bold text-sm flex-shrink-0">
                              ${index + 1}
                            </div>
                            <input
                              type="text"
                              value="${UI.sanitize(step)}"
                              onchange="updateRoutineStep('${routineType}', ${index}, this.value)"
                              class="flex-1 bg-transparent border-0 dark:text-gray-300 focus:outline-none focus:bg-white dark:focus:bg-gray-700 px-2 py-1 rounded"
                              placeholder="Routine step..."
                            />
                            <button onclick="deleteRoutineStep('${routineType}', ${index})"
                                    class="p-1 opacity-0 group-hover:opacity-100 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-600 dark:text-red-400 transition-opacity">
                              <i class="fas fa-times text-sm"></i>
                            </button>
                          </div>
                        `).join('')}

                        <button onclick="addRoutineStep('${routineType}')"
                                class="w-full mt-3 p-3 border-2 border-dashed dark:border-gray-600 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700 ${colors.text} transition-colors">
                          <i class="fas fa-plus mr-2"></i>Add Step
                        </button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
              <h3 class="text-xl font-bold mb-4 dark:text-white">Routine Overview</h3>
              <div class="grid md:grid-cols-3 gap-4">
                <div class="text-center p-4">
                  <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-1">
                    ${Object.values(state.Routine).reduce((sum, routine) => sum + routine.length, 0)}
                  </div>
                  <p class="text-slate-600 dark:text-gray-300">Total Steps</p>
                </div>
                <div class="text-center p-4">
                  <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-1">
                    ${Object.keys(state.Routine).length}
                  </div>
                  <p class="text-slate-600 dark:text-gray-300">Routines</p>
                </div>
                <div class="text-center p-4">
                  <div class="text-3xl font-bold text-purple-600 dark:text-purple-400 mb-1">
                    ${Math.round(Object.values(state.Routine).reduce((sum, routine) => sum + routine.length, 0) / Object.keys(state.Routine).length) || 0}
                  </div>
                  <p class="text-slate-600 dark:text-gray-300">Avg Steps/Routine</p>
                </div>
              </div>
            </div>
          </div>
        `;
      },
      
      Journal() {
        const sortedEntries = [...state.Journal].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <div class="flex items-center justify-between">
                <div>
                  <h1 class="text-3xl font-bold tracking-tight dark:text-white">Journal</h1>
                  <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Log your thoughts, progress, and reflections</p>
                </div>
                <button onclick="openJournalModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <i class="fas fa-plus mr-2"></i>New Entry
                </button>
              </div>
            </div>

            ${sortedEntries.length === 0 ? `
              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-12 text-center">
                <i class="fas fa-book text-5xl text-slate-300 dark:text-gray-600 mb-4"></i>
                <h3 class="text-xl font-semibold text-slate-700 dark:text-gray-300 mb-2">No Journal Entries Yet</h3>
                <p class="text-slate-500 dark:text-gray-400 mb-6">Start documenting your journey, wins, and lessons learned</p>
                <button onclick="openJournalModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  Create First Entry
                </button>
              </div>
            ` : `
              <div class="space-y-4">
                ${sortedEntries.map(entry => `
                  <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                      <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                          <h3 class="text-lg font-bold dark:text-white">${entry.title || 'Untitled Entry'}</h3>
                          ${entry.mood ? `<span class="text-2xl">${entry.mood}</span>` : ''}
                        </div>
                        <p class="text-xs text-slate-500 dark:text-gray-400">
                          ${new Date(entry.timestamp).toLocaleString('en-US', { 
                            weekday: 'short', 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          })}
                        </p>
                      </div>
                      <div class="flex gap-2">
                        <button onclick="editJournalEntry('${entry.id}')" class="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteJournalEntry('${entry.id}')" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg text-red-600 dark:text-red-400">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                    
                    ${entry.tags && entry.tags.length > 0 ? `
                      <div class="flex flex-wrap gap-2 mb-3">
                        ${entry.tags.map(tag => `
                          <span class="px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full text-xs">
                            ${tag}
                          </span>
                        `).join('')}
                      </div>
                    ` : ''}
                    
                    <div class="prose dark:prose-invert max-w-none">
                      <p class="text-slate-700 dark:text-gray-300 whitespace-pre-wrap">${entry.content}</p>
                    </div>
                    
                    ${entry.linkedTasks && entry.linkedTasks.length > 0 ? `
                      <div class="mt-4 pt-4 border-t dark:border-gray-700">
                        <p class="text-sm font-medium text-slate-600 dark:text-gray-400 mb-2">Linked Tasks:</p>
                        <div class="flex flex-wrap gap-2">
                          ${entry.linkedTasks.map(taskId => {
                            const task = state.AZTask.find(t => t.id === taskId);
                            return task ? `
                              <span class="px-2 py-1 bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded text-xs">
                                ${task.letter}: ${task.task}
                              </span>
                            ` : '';
                          }).join('')}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        `;
      },
      
      Statistics() {
        const weeklyStats = Helpers.getWeeklyStats();
        const monthlyStats = {
          tasks: state.AZTask.length,
          completed: state.AZTask.filter(t => t.status === 'Completed').length,
          days: Object.keys(state.DayPlans).length
        };
        
        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <h1 class="text-3xl font-bold tracking-tight dark:text-white">Statistics</h1>
              <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Track your productivity and progress</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="rounded-xl gradient-bg text-white p-6 shadow-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-white/80">Monthly Tasks</p>
                    <p class="text-3xl font-bold mt-1">${monthlyStats.completed}/${monthlyStats.tasks}</p>
                  </div>
                  <i class="fas fa-tasks text-3xl opacity-80"></i>
                </div>
                <div class="mt-4">
                  <div class="w-full bg-white/20 rounded-full h-2">
                    <div class="h-2 rounded-full bg-white" style="width: ${monthlyStats.tasks ? (monthlyStats.completed / monthlyStats.tasks) * 100 : 0}%"></div>
                  </div>
                </div>
              </div>

              <div class="rounded-xl bg-white dark:bg-gray-800 p-6 shadow-sm border dark:border-gray-700">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-slate-500 dark:text-gray-400">Active Days</p>
                    <p class="text-3xl font-bold mt-1 dark:text-white">${monthlyStats.days}</p>
                  </div>
                  <i class="fas fa-calendar-check text-3xl text-blue-500"></i>
                </div>
                <p class="text-sm text-slate-600 dark:text-gray-300 mt-2">${Math.round(monthlyStats.days / 30 * 100)}% of days planned</p>
              </div>

              <div class="rounded-xl bg-white dark:bg-gray-800 p-6 shadow-sm border dark:border-gray-700">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-slate-500 dark:text-gray-400">Weekly Success</p>
                    <p class="text-3xl font-bold mt-1 dark:text-white">${weeklyStats.percentage}%</p>
                  </div>
                  <i class="fas fa-chart-line text-3xl text-green-500"></i>
                </div>
                <p class="text-sm text-slate-600 dark:text-gray-300 mt-2">${weeklyStats.completed}/${weeklyStats.total} days met goals</p>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                <h3 class="text-lg font-bold mb-4 dark:text-white">Task Status Distribution</h3>
                <div class="space-y-3">
                  ${[
                    { label: 'Completed', value: state.AZTask.filter(t => t.status === 'Completed').length, color: 'bg-green-500' },
                    { label: 'In Progress', value: state.AZTask.filter(t => t.status === 'In Progress').length, color: 'bg-blue-500' },
                    { label: 'Not Started', value: state.AZTask.filter(t => t.status === 'Not Started').length, color: 'bg-slate-500 dark:bg-gray-500' }
                  ].map(item => `
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full ${item.color}"></div>
                        <span class="dark:text-gray-300">${item.label}</span>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class="font-medium dark:text-gray-300">${item.value}</span>
                        <div class="w-32 bg-slate-200 dark:bg-gray-700 rounded-full h-2">
                          <div class="h-2 rounded-full ${item.color}" 
                               style="width: ${state.AZTask.length ? (item.value / state.AZTask.length) * 100 : 0}%">
                          </div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                <h3 class="text-lg font-bold mb-4 dark:text-white">Day Type Usage</h3>
                <div class="space-y-3">
                  ${['A', 'B', 'C'].map(type => {
                    const count = Object.values(state.DayPlans).filter(p => p.day_type === type).length;
                    const total = Object.keys(state.DayPlans).length;
                    return `
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                          <div class="w-8 h-8 rounded-lg ${
                            type === 'A' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' :
                            type === 'B' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                            'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300'
                          } flex items-center justify-center font-bold">
                            ${type}
                          </div>
                          <span class="dark:text-gray-300">${type} Days</span>
                        </div>
                        <div class="flex items-center gap-3">
                          <span class="font-medium dark:text-gray-300">${count}</span>
                          <div class="w-32 bg-slate-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="h-2 rounded-full ${
                              type === 'A' ? 'bg-blue-500' :
                              type === 'B' ? 'bg-green-500' :
                              'bg-purple-500'
                            }" style="width: ${total ? (count / total) * 100 : 0}%"></div>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
              <h3 class="text-lg font-bold mb-4 dark:text-white">Recent Activity</h3>
              <div class="space-y-3">
                ${state.AZTask
                  .filter(t => t.status === 'Completed')
                  .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                  .slice(0, 5)
                  .map(task => `
                    <div class="flex items-center gap-3 p-3 rounded-lg bg-green-50 dark:bg-green-900/20">
                      <div class="w-8 h-8 rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300 flex items-center justify-center">
                        <i class="fas fa-check"></i>
                      </div>
                      <div class="flex-1">
                        <p class="font-medium dark:text-gray-300">Completed: ${task.letter} - ${UI.sanitize(task.task)}</p>
                        <p class="text-sm text-slate-500 dark:text-gray-400">${new Date(task.createdAt).toLocaleDateString()}</p>
                      </div>
                    </div>
                  `).join('')}
                
                ${state.AZTask.filter(t => t.status === 'Completed').length === 0 ? `
                  <p class="text-center text-slate-500 dark:text-gray-400 py-4">No completed tasks yet</p>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      },

      Reflections() {
        const tabs = [
          { id: 'weekly', label: 'Weekly', icon: 'fa-calendar-week', color: 'blue' },
          { id: 'monthly', label: 'Monthly', icon: 'fa-calendar-alt', color: 'green' },
          { id: 'quarterly', label: 'Quarterly', icon: 'fa-chart-bar', color: 'purple' },
          { id: 'yearly', label: 'Yearly', icon: 'fa-star', color: 'amber' }
        ];

        const activeTab = state.reflectionTab || 'weekly';
        const reflections = state.Reflections[activeTab] || [];
        const sortedReflections = [...reflections].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        const promptLabels = {
          weekly: { wins: '3 Biggest Wins', challenges: 'Challenges', lessons: 'Lessons Learned', priorities: 'Next Week Priorities' },
          monthly: { accomplishments: 'Accomplishments', goals_progress: 'Goal Progress', improvements: 'Improvements', focus: 'Next Month Focus' },
          quarterly: { milestones: 'Milestones', trends: 'Trends', growth: 'Growth Areas', strategy: 'Strategy' },
          yearly: { top5: 'Top 5 Achievements', transformation: 'Transformation', gratitude: 'Gratitude', vision: 'Vision' }
        };

        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <div class="flex items-center justify-between">
                <div>
                  <h1 class="text-3xl font-bold tracking-tight dark:text-white">Reflections</h1>
                  <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Review your progress and plan ahead</p>
                </div>
                <button onclick="openReflectionModal('${activeTab}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <i class="fas fa-plus mr-2"></i>New ${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)} Review
                </button>
              </div>
            </div>

            <!-- Tabs -->
            <div class="flex gap-2 border-b dark:border-gray-700 pb-2 overflow-x-auto">
              ${tabs.map(tab => `
                <button onclick="setReflectionTab('${tab.id}')"
                        class="flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
                          activeTab === tab.id
                            ? `bg-${tab.color}-100 text-${tab.color}-700 dark:bg-${tab.color}-900/30 dark:text-${tab.color}-300 font-medium`
                            : 'text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700'
                        }">
                  <i class="fas ${tab.icon}"></i>
                  <span>${tab.label}</span>
                  <span class="ml-1 px-2 py-0.5 rounded-full text-xs ${
                    activeTab === tab.id
                      ? `bg-${tab.color}-200 dark:bg-${tab.color}-800`
                      : 'bg-slate-200 dark:bg-gray-600'
                  }">${(state.Reflections[tab.id] || []).length}</span>
                </button>
              `).join('')}
            </div>

            <!-- Reflection List -->
            ${sortedReflections.length === 0 ? `
              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-12 text-center">
                <i class="fas fa-lightbulb text-5xl text-slate-300 dark:text-gray-600 mb-4"></i>
                <h3 class="text-xl font-semibold text-slate-700 dark:text-gray-300 mb-2">No ${activeTab} reflections yet</h3>
                <p class="text-slate-500 dark:text-gray-400 mb-6">Take time to review your progress and set intentions</p>
                <button onclick="openReflectionModal('${activeTab}')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  Start Your First ${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)} Review
                </button>
              </div>
            ` : `
              <div class="space-y-4">
                ${sortedReflections.map(reflection => `
                  <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                    <div class="flex items-start justify-between mb-4">
                      <div>
                        <div class="flex items-center gap-2">
                          <span class="text-lg font-bold dark:text-white">
                            ${new Date(reflection.timestamp).toLocaleDateString('en-US', {
                              year: 'numeric',
                              month: 'long',
                              day: 'numeric'
                            })}
                          </span>
                          ${reflection.mood ? `
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                              reflection.mood === 'excellent' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                              reflection.mood === 'good' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' :
                              reflection.mood === 'neutral' ? 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300' :
                              reflection.mood === 'challenging' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300' :
                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'
                            }">${reflection.mood}</span>
                          ` : ''}
                        </div>
                        <p class="text-xs text-slate-500 dark:text-gray-400 mt-1">
                          ${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)} Reflection
                        </p>
                      </div>
                      <button onclick="deleteReflection('${activeTab}', '${reflection.id}')"
                              class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg text-red-600 dark:text-red-400">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>

                    <div class="space-y-4">
                      ${Object.entries(reflection.responses).map(([key, value]) => `
                        <div class="border-l-4 border-blue-500 pl-4">
                          <h4 class="text-sm font-semibold text-slate-600 dark:text-gray-400 mb-1">
                            ${promptLabels[activeTab][key] || key}
                          </h4>
                          <p class="text-slate-700 dark:text-gray-300 whitespace-pre-wrap">${UI.sanitize(value)}</p>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `).join('')}
              </div>
            `}

            <!-- Reflection Summary -->
            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
              <h3 class="text-lg font-bold mb-4 dark:text-white">Reflection Summary</h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${tabs.map(tab => `
                  <div class="text-center p-4 rounded-lg bg-${tab.color}-50 dark:bg-${tab.color}-900/20">
                    <div class="text-2xl font-bold text-${tab.color}-600 dark:text-${tab.color}-400 mb-1">
                      ${(state.Reflections[tab.id] || []).length}
                    </div>
                    <p class="text-sm text-${tab.color}-700 dark:text-${tab.color}-300">${tab.label} Reviews</p>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      },

      Timeline() {
        const sortedActivities = (state.History.timeline || [])
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        // Group by date
        const groupedByDate = {};
        sortedActivities.forEach(activity => {
          const date = new Date(activity.timestamp).toISOString().slice(0, 10);
          if (!groupedByDate[date]) groupedByDate[date] = [];
          groupedByDate[date].push(activity);
        });

        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <div class="flex items-center justify-between">
                <div>
                  <h1 class="text-3xl font-bold tracking-tight dark:text-white">Activity Timeline</h1>
                  <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Your complete activity history</p>
                </div>
                <button onclick="exportTimeline()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <i class="fas fa-download mr-2"></i>Export Timeline
                </button>
              </div>
            </div>

            ${sortedActivities.length === 0 ? `
              <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-12 text-center">
                <i class="fas fa-history text-5xl text-slate-300 dark:text-gray-600 mb-4"></i>
                <h3 class="text-xl font-semibold text-slate-700 dark:text-gray-300 mb-2">No Activity Yet</h3>
                <p class="text-slate-500 dark:text-gray-400">Your actions will appear here as you use CycleBoard</p>
              </div>
            ` : `
              <div class="space-y-6">
                ${Object.keys(groupedByDate).map(date => {
                  const dateObj = new Date(date);
                  const activities = groupedByDate[date];

                  return `
                    <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
                      <div class="p-4 border-b dark:border-gray-700 bg-slate-50 dark:bg-gray-700/50">
                        <h3 class="font-bold dark:text-white">
                          ${dateObj.toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                          })}
                        </h3>
                      </div>
                      <div class="p-6">
                        <div class="space-y-4">
                          ${activities.map(activity => {
                            const time = new Date(activity.timestamp).toLocaleTimeString('en-US', {
                              hour: '2-digit',
                              minute: '2-digit'
                            });

                            const iconMap = {
                              'task_created': 'fa-plus-circle text-blue-600 dark:text-blue-400',
                              'task_updated': 'fa-edit text-yellow-600 dark:text-yellow-400',
                              'task_completed': 'fa-check-circle text-green-600 dark:text-green-400',
                              'task_deleted': 'fa-trash text-red-600 dark:text-red-400',
                              'time_block_completed': 'fa-clock text-purple-600 dark:text-purple-400',
                              'focus_task_added': 'fa-bullseye text-indigo-600 dark:text-indigo-400',
                              'focus_task_completed': 'fa-star text-yellow-600 dark:text-yellow-400',
                              'note_added': 'fa-sticky-note text-pink-600 dark:text-pink-400'
                            };

                            const icon = iconMap[activity.type] || 'fa-circle text-slate-600 dark:text-gray-400';

                            return `
                              <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-gray-700 flex items-center justify-center flex-shrink-0 mt-1">
                                  <i class="fas ${icon} text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                  <div class="flex items-baseline gap-2">
                                    <span class="text-xs text-slate-500 dark:text-gray-400 font-mono">${time}</span>
                                    <p class="text-sm dark:text-gray-300">${UI.sanitize(activity.description)}</p>
                                  </div>
                                  ${activity.details && Object.keys(activity.details).length > 0 ? `
                                    <div class="mt-1 text-xs text-slate-500 dark:text-gray-400">
                                      ${Object.entries(activity.details).map(([key, value]) =>
                                        `<span class="mr-3">${key}: ${UI.sanitize(String(value))}</span>`
                                      ).join('')}
                                    </div>
                                  ` : ''}
                                </div>
                                <button onclick="deleteActivity('${activity.id}')" class="p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-600 dark:text-red-400 opacity-0 hover:opacity-100 transition-opacity">
                                  <i class="fas fa-times text-xs"></i>
                                </button>
                              </div>
                            `;
                          }).join('')}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        `;
      },

      Settings() {
        return `
          <div class="space-y-6 fade-in">
            <div class="mb-6">
              <h1 class="text-3xl font-bold tracking-tight dark:text-white">Settings</h1>
              <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Customize your experience</p>
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6 border-b dark:border-gray-700">
                <h2 class="text-xl font-bold dark:text-white">Preferences</h2>
              </div>
              <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-medium dark:text-gray-300">Dark Mode</p>
                    <p class="text-sm text-slate-500 dark:text-gray-400">Switch to dark theme</p>
                  </div>
                  <button onclick="toggleDarkMode()" class="relative inline-flex h-6 w-11 items-center rounded-full ${
                    state.Settings.darkMode ? 'bg-blue-600' : 'bg-slate-300'
                  }">
                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition ${
                      state.Settings.darkMode ? 'translate-x-6' : 'translate-x-1'
                    }"></span>
                  </button>
                </div>
                
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-medium dark:text-gray-300">Notifications</p>
                    <p class="text-sm text-slate-500 dark:text-gray-400">Get reminder notifications</p>
                  </div>
                  <button onclick="toggleSetting('notifications')" class="relative inline-flex h-6 w-11 items-center rounded-full ${
                    state.Settings.notifications ? 'bg-blue-600' : 'bg-slate-300'
                  }">
                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition ${
                      state.Settings.notifications ? 'translate-x-6' : 'translate-x-1'
                    }"></span>
                  </button>
                </div>
                
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-medium dark:text-gray-300">Auto-save</p>
                    <p class="text-sm text-slate-500 dark:text-gray-400">Automatically save changes</p>
                  </div>
                  <button onclick="toggleSetting('autoSave')" class="relative inline-flex h-6 w-11 items-center rounded-full ${
                    state.Settings.autoSave ? 'bg-blue-600' : 'bg-slate-300'
                  }">
                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition ${
                      state.Settings.autoSave ? 'translate-x-6' : 'translate-x-1'
                    }"></span>
                  </button>
                </div>
                
                <div>
                  <label class="font-medium block mb-2 dark:text-gray-300">Default Day Type</label>
                  <select onchange="updateSetting('defaultDayType', this.value)" class="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 w-full">
                    ${['A', 'B', 'C'].map(type => `
                      <option value="${type}" ${state.Settings.defaultDayType === type ? 'selected' : ''}>
                        ${type} Day ${type === 'A' ? '(Deep Focus)' : type === 'B' ? '(Balanced)' : '(Recovery)'}
                      </option>
                    `).join('')}
                  </select>
                </div>
              </div>
            </div>

            <!-- Day Type Templates -->
            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6 border-b dark:border-gray-700">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="text-xl font-bold dark:text-white">Day Type Templates</h2>
                    <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Customize schedules for each day type</p>
                  </div>
                </div>
              </div>
              <div class="p-6">
                <div class="grid md:grid-cols-3 gap-4">
                  ${['A', 'B', 'C'].map(type => {
                    const template = state.DayTypeTemplates?.[type] || {};
                    const colors = {
                      A: { bg: 'bg-green-50 dark:bg-green-900/20', border: 'border-green-200 dark:border-green-800', text: 'text-green-700 dark:text-green-300', badge: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' },
                      B: { bg: 'bg-yellow-50 dark:bg-yellow-900/20', border: 'border-yellow-200 dark:border-yellow-800', text: 'text-yellow-700 dark:text-yellow-300', badge: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' },
                      C: { bg: 'bg-red-50 dark:bg-red-900/20', border: 'border-red-200 dark:border-red-800', text: 'text-red-700 dark:text-red-300', badge: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' }
                    };
                    const color = colors[type];

                    return `
                      <div class="rounded-xl border ${color.border} ${color.bg} p-4">
                        <div class="flex items-center gap-3 mb-3">
                          <div class="w-10 h-10 rounded-full ${color.badge} flex items-center justify-center text-xl font-bold">
                            ${type}
                          </div>
                          <div>
                            <h3 class="font-bold ${color.text}">${template.name || type + ' Day'}</h3>
                            <p class="text-xs text-slate-500 dark:text-gray-400">${template.description || ''}</p>
                          </div>
                        </div>

                        <div class="space-y-2 text-sm">
                          <div class="flex items-center gap-2 text-slate-600 dark:text-gray-400">
                            <i class="fas fa-clock w-4"></i>
                            <span>${template.timeBlocks?.length || 0} time blocks</span>
                          </div>
                          <div class="flex items-center gap-2 text-slate-600 dark:text-gray-400">
                            <i class="fas fa-list-check w-4"></i>
                            <span>${template.routines?.join(', ') || 'No routines'}</span>
                          </div>
                          <div class="flex items-center gap-2 text-slate-600 dark:text-gray-400">
                            <i class="fas fa-bullseye w-4"></i>
                            <span class="truncate" title="${template.goals?.baseline || ''}">${template.goals?.baseline || 'No baseline'}</span>
                          </div>
                        </div>

                        <button onclick="openDayTypeTemplateEditor('${type}')" class="mt-4 w-full px-3 py-2 border ${color.border} rounded-lg hover:bg-white dark:hover:bg-gray-700 transition text-sm font-medium ${color.text}">
                          <i class="fas fa-edit mr-1"></i> Edit Template
                        </button>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6 border-b dark:border-gray-700">
                <h2 class="text-xl font-bold dark:text-white">Data Management</h2>
              </div>
              <div class="p-6 space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                  <button onclick="exportState()" class="flex items-center gap-3 p-4 border dark:border-gray-600 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400 flex items-center justify-center">
                      <i class="fas fa-download"></i>
                    </div>
                    <div class="text-left">
                      <p class="font-medium dark:text-gray-300">Export Data</p>
                      <p class="text-sm text-slate-500 dark:text-gray-400">Download as JSON file</p>
                    </div>
                  </button>
                  
                  <button onclick="showImportModal()" class="flex items-center gap-3 p-4 border dark:border-gray-600 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 flex items-center justify-center">
                      <i class="fas fa-upload"></i>
                    </div>
                    <div class="text-left">
                      <p class="font-medium dark:text-gray-300">Import Data</p>
                      <p class="text-sm text-slate-500 dark:text-gray-400">Restore from backup</p>
                    </div>
                  </button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                  <button onclick="clearData()" class="flex items-center gap-3 p-4 border border-red-200 dark:border-red-800 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                    <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 flex items-center justify-center">
                      <i class="fas fa-trash-alt"></i>
                    </div>
                    <div class="text-left">
                      <p class="font-medium text-red-600 dark:text-red-400">Clear All Data</p>
                      <p class="text-sm text-red-500 dark:text-red-400">Permanently delete everything</p>
                    </div>
                  </button>
                  
                  <button onclick="resetToDefaults()" class="flex items-center gap-3 p-4 border dark:border-gray-600 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
                    <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400 flex items-center justify-center">
                      <i class="fas fa-redo"></i>
                    </div>
                    <div class="text-left">
                      <p class="font-medium dark:text-gray-300">Reset to Defaults</p>
                      <p class="text-sm text-slate-500 dark:text-gray-400">Restore initial settings</p>
                    </div>
                  </button>
                </div>
              </div>
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6 border-b dark:border-gray-700">
                <h2 class="text-xl font-bold dark:text-white">Backup Statistics</h2>
              </div>
              <div class="p-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="text-center p-4 bg-slate-50 dark:bg-gray-700/50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600 dark:text-green-400 mb-1">
                      ${parseInt(localStorage.getItem('cycleboard-export-count') || '0')}
                    </div>
                    <p class="text-sm text-slate-600 dark:text-gray-400">Total Exports</p>
                  </div>
                  <div class="text-center p-4 bg-slate-50 dark:bg-gray-700/50 rounded-lg">
                    <div class="text-sm font-medium text-slate-700 dark:text-gray-300 mb-1">
                      ${localStorage.getItem('cycleboard-last-export') ? new Date(localStorage.getItem('cycleboard-last-export')).toLocaleDateString() : 'Never'}
                    </div>
                    <p class="text-sm text-slate-600 dark:text-gray-400">Last Export</p>
                  </div>
                  <div class="text-center p-4 bg-slate-50 dark:bg-gray-700/50 rounded-lg">
                    <div class="text-sm font-medium text-slate-700 dark:text-gray-300 mb-1">
                      ${localStorage.getItem('cycleboard-last-import') ? new Date(localStorage.getItem('cycleboard-last-import')).toLocaleDateString() : 'Never'}
                    </div>
                    <p class="text-sm text-slate-600 dark:text-gray-400">Last Import</p>
                  </div>
                  <div class="text-center p-4 bg-slate-50 dark:bg-gray-700/50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-1">
                      ${(JSON.stringify(state).length / 1024).toFixed(1)}
                    </div>
                    <p class="text-sm text-slate-600 dark:text-gray-400">KB Data Size</p>
                  </div>
                </div>
                <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                  <div class="flex items-start gap-2">
                    <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mt-1"></i>
                    <div class="text-sm text-blue-800 dark:text-blue-300">
                      <p class="font-medium">Regular backups recommended</p>
                      <p class="text-blue-700 dark:text-blue-400 mt-1">Export your data weekly to prevent data loss. Your data is stored locally in your browser.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
              <div class="p-6 border-b dark:border-gray-700">
                <h2 class="text-xl font-bold dark:text-white">About CycleBoard</h2>
              </div>
              <div class="p-6 space-y-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white">
                    <i class="fas fa-sync-alt"></i>
                  </div>
                  <div>
                    <p class="font-medium dark:text-gray-300">in-PACT Self-Sustaining Bullet Journal</p>
                    <p class="text-sm text-slate-500 dark:text-gray-400">Version 2.0</p>
                  </div>
                </div>
                
                <div class="space-y-2">
                  <p class="text-slate-600 dark:text-gray-300">
                    CycleBoard helps you plan, execute, and review your monthly goals using the A-Z methodology.
                    All data is stored locally in your browser.
                  </p>
                  <p class="text-sm text-slate-500 dark:text-gray-400">
                    Last saved: ${new Date().toLocaleString()}
                  </p>
                </div>
                
                <div class="flex gap-2 pt-4">
                  <button onclick="navigate('Home')" class="px-4 py-2 bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-300 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-600">
                    <i class="fas fa-question-circle mr-2"></i>Help
                  </button>
                  <button onclick="exportState()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-save mr-2"></i>Backup Now
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    };

    function completeTask(id) {
      const task = state.AZTask.find(t => t.id === id);
      if (task) {
        task.status = 'Completed';
        state.History.completedTasks.push({
          taskId: task.id,
          completedAt: new Date().toISOString()
        });
        Helpers.logActivity('task_completed', `Completed A-Z Task: ${task.letter} - ${task.task}`, { taskId: task.id });
        stateManager.update({ AZTask: state.AZTask, History: state.History });
        render();
        UI.showToast('Task Completed', `${task.letter} â€“ ${task.task}`, 'success');
      }
    }

    function deleteTask(id) {
      const task = state.AZTask.find(t => t.id === id);
      if (task && confirm(`Delete task ${task.letter} â€“ ${task.task}?`)) {
        Helpers.logActivity('task_deleted', `Deleted A-Z Task: ${task.letter} - ${task.task}`, { taskId: task.id });
        state.AZTask = state.AZTask.filter(t => t.id !== id);
        stateManager.update({ AZTask: state.AZTask });
        render();
        UI.showToast('Task Deleted', `${task.letter} â€“ ${task.task}`, 'warning');
      }
    }

    function setDayType(type, applyTemplate = null) {
      const todayPlan = Helpers.getDayPlan();
      const oldType = todayPlan.day_type;

      // If no change in type and no template action pending, skip
      if (oldType === type && applyTemplate === null) {
        return;
      }

      // If switching to a different day type and no template decision made, show modal
      if (oldType !== type && applyTemplate === null) {
        showApplyTemplateModal(type, oldType);
        return;
      }

      // Now actually change the type
      todayPlan.day_type = type;

      // Apply template if requested
      if (applyTemplate === true) {
        applyDayTypeTemplate(todayPlan, type);
      }

      // Log the change
      if (oldType !== type || applyTemplate !== null) {
        Helpers.logActivity('day_type_changed', `Changed day type to ${type}-Day`, { from: oldType, to: type, templateApplied: applyTemplate });
      }

      state.DayPlans[todayPlan.date] = todayPlan;
      stateManager.update({ DayPlans: state.DayPlans });
      render();
    }

    function showApplyTemplateModal(newType, oldType) {
      const template = state.DayTypeTemplates?.[newType];
      if (!template) {
        // No template, just apply the change
        setDayType(newType, false);
        return;
      }

      const content = `
        <div class="p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold ${
              newType === 'A' ? 'bg-green-100 text-green-700' :
              newType === 'B' ? 'bg-yellow-100 text-yellow-700' :
              'bg-red-100 text-red-700'
            }">
              ${newType}
            </div>
            <div>
              <h2 class="text-xl font-bold dark:text-white">${template.name}</h2>
              <p class="text-sm text-slate-500 dark:text-gray-400">${template.description}</p>
            </div>
          </div>

          <div class="bg-slate-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
            <h3 class="font-semibold text-sm mb-2 dark:text-gray-300">This template includes:</h3>
            <ul class="text-sm space-y-1 text-slate-600 dark:text-gray-400">
              <li><i class="fas fa-clock mr-2 text-blue-500"></i>${template.timeBlocks.length} time blocks</li>
              <li><i class="fas fa-list-check mr-2 text-green-500"></i>${template.routines.length} routines: ${template.routines.join(', ')}</li>
              <li><i class="fas fa-bullseye mr-2 text-purple-500"></i>Baseline: ${template.goals.baseline}</li>
              <li><i class="fas fa-rocket mr-2 text-amber-500"></i>Stretch: ${template.goals.stretch}</li>
            </ul>
          </div>

          <p class="text-sm text-slate-600 dark:text-gray-400 mb-4">
            Would you like to apply this schedule template? This will replace your current time blocks.
          </p>

          <div class="flex gap-3">
            <button onclick="setDayType('${newType}', true);UI.closeModal();" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              <i class="fas fa-check mr-2"></i>Apply Template
            </button>
            <button onclick="setDayType('${newType}', false);UI.closeModal();" class="flex-1 px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
              Just Change Type
            </button>
            <button onclick="UI.closeModal()" class="px-4 py-2 text-slate-500 dark:text-gray-400 hover:text-slate-700">
              Cancel
            </button>
          </div>
        </div>
      `;

      UI.showModal(content);
    }

    function applyDayTypeTemplate(dayPlan, type) {
      const template = state.DayTypeTemplates?.[type];
      if (!template) return;

      // Apply time blocks
      dayPlan.time_blocks = template.timeBlocks.map(block => ({
        id: stateManager.generateId(),
        time: block.time,
        title: block.title,
        duration: block.duration,
        completed: false
      }));

      // Apply goals
      dayPlan.baseline_goal = { text: template.goals.baseline, completed: false };
      dayPlan.stretch_goal = { text: template.goals.stretch, completed: false };

      // Mark which routines are active for this day type
      dayPlan.activeRoutines = template.routines;

      UI.showToast('Template Applied', `${template.name} schedule loaded`, 'success');
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function openDayTypeTemplateEditor(type) {
      console.log('Opening template editor for type:', type);

      const template = state.DayTypeTemplates?.[type] || {
        name: `${type}-Day`,
        description: '',
        timeBlocks: [],
        routines: [],
        goals: { baseline: '', stretch: '' }
      };

      console.log('Template data:', template);

      const colors = {
        A: { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-300', darkBg: 'dark:bg-green-900/30', darkText: 'dark:text-green-400' },
        B: { bg: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-yellow-300', darkBg: 'dark:bg-yellow-900/30', darkText: 'dark:text-yellow-400' },
        C: { bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-300', darkBg: 'dark:bg-red-900/30', darkText: 'dark:text-red-400' }
      };
      const color = colors[type];

      const allRoutineNames = Object.keys(state.Routine || {});

      const content = `
        <div class="p-6 max-h-[80vh] overflow-y-auto">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold ${color.bg} ${color.text} ${color.darkBg} ${color.darkText}">
              ${type}
            </div>
            <div class="flex-1">
              <h2 class="text-xl font-bold dark:text-white">Edit ${type}-Day Template</h2>
              <p class="text-sm text-slate-500 dark:text-gray-400">Customize schedule, routines, and goals</p>
            </div>
          </div>

          <!-- Basic Info -->
          <div class="mb-6">
            <h3 class="font-semibold text-sm mb-2 dark:text-gray-300">Template Info</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">Name</label>
                <input type="text" id="template-name" value="${escapeHtml(template.name)}"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">Description</label>
                <input type="text" id="template-description" value="${escapeHtml(template.description)}"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500" />
              </div>
            </div>
          </div>

          <!-- Goals -->
          <div class="mb-6">
            <h3 class="font-semibold text-sm mb-2 dark:text-gray-300">Goals</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1"><i class="fas fa-bullseye mr-1 text-purple-500"></i>Baseline Goal</label>
                <input type="text" id="template-baseline" value="${escapeHtml(template.goals?.baseline || '')}"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1"><i class="fas fa-rocket mr-1 text-amber-500"></i>Stretch Goal</label>
                <input type="text" id="template-stretch" value="${escapeHtml(template.goals?.stretch || '')}"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500" />
              </div>
            </div>
          </div>

          <!-- Routines -->
          <div class="mb-6">
            <h3 class="font-semibold text-sm mb-2 dark:text-gray-300">Active Routines</h3>
            <div class="flex flex-wrap gap-2" id="template-routines">
              ${allRoutineNames.map(name => `
                <label class="flex items-center gap-2 px-3 py-2 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-gray-700">
                  <input type="checkbox" value="${name}" ${template.routines?.includes(name) ? 'checked' : ''}
                    class="rounded text-blue-600 focus:ring-blue-500" />
                  <span class="text-sm dark:text-gray-300">${name}</span>
                </label>
              `).join('')}
            </div>
          </div>

          <!-- Time Blocks -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-semibold text-sm dark:text-gray-300">Time Blocks</h3>
              <button onclick="addTemplateTimeBlock('${type}')" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 rounded hover:bg-blue-200">
                <i class="fas fa-plus mr-1"></i>Add Block
              </button>
            </div>
            <div id="template-time-blocks" class="space-y-2 max-h-64 overflow-y-auto">
              ${(template.timeBlocks || []).map((block, idx) => `
                <div class="flex items-center gap-2 p-2 bg-slate-50 dark:bg-gray-700 rounded-lg" data-block-idx="${idx}">
                  <input type="time" value="${convertTo24Hour(block.time)}"
                    class="time-input px-2 py-1 border dark:border-gray-600 rounded text-sm dark:bg-gray-600 dark:text-white w-24" />
                  <input type="text" value="${escapeHtml(block.title)}"
                    class="title-input flex-1 px-2 py-1 border dark:border-gray-600 rounded text-sm dark:bg-gray-600 dark:text-white" />
                  <input type="number" value="${block.duration || 60}" min="15" step="15"
                    class="duration-input px-2 py-1 border dark:border-gray-600 rounded text-sm dark:bg-gray-600 dark:text-white w-16" placeholder="min" />
                  <button onclick="removeTemplateTimeBlock(${idx}, '${type}')" class="text-red-500 hover:text-red-700 px-2">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Actions -->
          <div class="flex gap-3 pt-4 border-t dark:border-gray-700">
            <button onclick="saveDayTypeTemplate('${type}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              <i class="fas fa-save mr-2"></i>Save Template
            </button>
            <button onclick="resetDayTypeTemplate('${type}')" class="px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
              <i class="fas fa-undo mr-2"></i>Reset to Default
            </button>
            <button onclick="UI.closeModal()" class="px-4 py-2 text-slate-500 dark:text-gray-400 hover:text-slate-700">
              Cancel
            </button>
          </div>
        </div>
      `;

      UI.showModal(content);
    }

    function convertTo24Hour(timeStr) {
      // Convert "6:00 AM" to "06:00" for input[type=time]
      if (!timeStr) return '09:00';
      const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
      if (!match) return '09:00';

      let hours = parseInt(match[1]);
      const minutes = match[2];
      const period = match[3]?.toUpperCase();

      if (period === 'PM' && hours < 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;

      return `${hours.toString().padStart(2, '0')}:${minutes}`;
    }

    function convertTo12Hour(time24) {
      // Convert "06:00" to "6:00 AM"
      const [hours, minutes] = time24.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    function addTemplateTimeBlock(type) {
      const container = document.getElementById('template-time-blocks');
      const idx = container.children.length;
      const blockHtml = `
        <div class="flex items-center gap-2 p-2 bg-slate-50 dark:bg-gray-700 rounded-lg" data-block-idx="${idx}">
          <input type="time" value="09:00"
            class="time-input px-2 py-1 border dark:border-gray-600 rounded text-sm dark:bg-gray-600 dark:text-white w-24" />
          <input type="text" value="New Block"
            class="title-input flex-1 px-2 py-1 border dark:border-gray-600 rounded text-sm dark:bg-gray-600 dark:text-white" />
          <input type="number" value="60" min="15" step="15"
            class="duration-input px-2 py-1 border dark:border-gray-600 rounded text-sm dark:bg-gray-600 dark:text-white w-16" placeholder="min" />
          <button onclick="removeTemplateTimeBlock(${idx}, '${type}')" class="text-red-500 hover:text-red-700 px-2">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', blockHtml);
    }

    function removeTemplateTimeBlock(idx, type) {
      const container = document.getElementById('template-time-blocks');
      const block = container.querySelector(`[data-block-idx="${idx}"]`);
      if (block) block.remove();
      // Re-index remaining blocks
      Array.from(container.children).forEach((el, i) => {
        el.setAttribute('data-block-idx', i);
        const btn = el.querySelector('button');
        btn.onclick = () => removeTemplateTimeBlock(i, type);
      });
    }

    function saveDayTypeTemplate(type) {
      const name = document.getElementById('template-name').value;
      const description = document.getElementById('template-description').value;
      const baseline = document.getElementById('template-baseline').value;
      const stretch = document.getElementById('template-stretch').value;

      // Get selected routines
      const routineCheckboxes = document.querySelectorAll('#template-routines input[type="checkbox"]:checked');
      const routines = Array.from(routineCheckboxes).map(cb => cb.value);

      // Get time blocks
      const blockElements = document.querySelectorAll('#template-time-blocks > div');
      const timeBlocks = Array.from(blockElements).map(el => {
        const timeInput = el.querySelector('.time-input');
        const titleInput = el.querySelector('.title-input');
        const durationInput = el.querySelector('.duration-input');
        return {
          time: convertTo12Hour(timeInput.value),
          title: titleInput.value,
          duration: parseInt(durationInput.value) || 60
        };
      }).sort((a, b) => {
        // Sort by time
        return convertTo24Hour(a.time).localeCompare(convertTo24Hour(b.time));
      });

      // Update template
      if (!state.DayTypeTemplates) state.DayTypeTemplates = {};
      state.DayTypeTemplates[type] = {
        name,
        description,
        timeBlocks,
        routines,
        goals: { baseline, stretch }
      };

      stateManager.update({ DayTypeTemplates: state.DayTypeTemplates });
      Helpers.logActivity('template_updated', `Updated ${type}-Day template`, { type, name });

      UI.closeModal();
      UI.showToast('Template Saved', `${name} template updated`, 'success');
      render();
    }

    function resetDayTypeTemplate(type) {
      if (!confirm(`Reset ${type}-Day template to default? This cannot be undone.`)) return;

      const defaults = {
        A: {
          name: 'Optimal Day',
          description: 'Full energy, maximum output',
          timeBlocks: [
            { time: '6:00 AM', title: 'Morning Routine', duration: 60 },
            { time: '7:00 AM', title: 'Commute / Prep', duration: 30 },
            { time: '7:30 AM', title: 'Deep Work Block 1', duration: 90 },
            { time: '9:00 AM', title: 'Break / Recharge', duration: 15 },
            { time: '9:15 AM', title: 'Deep Work Block 2', duration: 90 },
            { time: '10:45 AM', title: 'Admin / Email', duration: 45 },
            { time: '11:30 AM', title: 'Deep Work Block 3', duration: 90 },
            { time: '1:00 PM', title: 'Lunch Break', duration: 60 },
            { time: '2:00 PM', title: 'Deep Work Block 4', duration: 90 },
            { time: '3:30 PM', title: 'Meetings / Collaboration', duration: 90 },
            { time: '5:00 PM', title: 'Wrap-up / Plan Tomorrow', duration: 30 },
            { time: '5:30 PM', title: 'Evening Routine', duration: 90 }
          ],
          routines: ['Morning', 'Commute', 'Evening'],
          goals: { baseline: 'Complete 4 deep work blocks', stretch: 'Clear inbox + bonus task' }
        },
        B: {
          name: 'Low Energy Day',
          description: 'Conserve energy, focus on essentials',
          timeBlocks: [
            { time: '7:00 AM', title: 'Gentle Morning Routine', duration: 60 },
            { time: '8:00 AM', title: 'Light Admin Tasks', duration: 60 },
            { time: '9:00 AM', title: 'Focus Block 1', duration: 60 },
            { time: '10:00 AM', title: 'Break / Movement', duration: 30 },
            { time: '10:30 AM', title: 'Focus Block 2', duration: 60 },
            { time: '11:30 AM', title: 'Email / Communication', duration: 30 },
            { time: '12:00 PM', title: 'Lunch + Rest', duration: 90 },
            { time: '1:30 PM', title: 'Focus Block 3', duration: 60 },
            { time: '2:30 PM', title: 'Light Tasks / Review', duration: 90 },
            { time: '4:00 PM', title: 'Wrap-up', duration: 30 },
            { time: '4:30 PM', title: 'Evening Routine', duration: 60 }
          ],
          routines: ['Morning', 'Evening'],
          goals: { baseline: 'Complete 3 focus blocks', stretch: 'One bonus task if energy allows' }
        },
        C: {
          name: 'Chaos Day',
          description: 'Survival mode - one priority only',
          timeBlocks: [
            { time: '7:00 AM', title: 'Basic Morning', duration: 30 },
            { time: '7:30 AM', title: 'Identify ONE Priority', duration: 15 },
            { time: '7:45 AM', title: 'Work on Priority', duration: 120 },
            { time: '9:45 AM', title: 'Break', duration: 15 },
            { time: '10:00 AM', title: 'Continue Priority', duration: 120 },
            { time: '12:00 PM', title: 'Lunch', duration: 60 },
            { time: '1:00 PM', title: 'Priority Push', duration: 120 },
            { time: '3:00 PM', title: 'Essential Only', duration: 120 },
            { time: '5:00 PM', title: 'Minimal Evening Routine', duration: 30 }
          ],
          routines: ['Evening'],
          goals: { baseline: 'Complete ONE priority task', stretch: 'Survive and reset for tomorrow' }
        }
      };

      state.DayTypeTemplates[type] = defaults[type];
      stateManager.update({ DayTypeTemplates: state.DayTypeTemplates });

      UI.closeModal();
      UI.showToast('Template Reset', `${type}-Day template restored to default`, 'success');
      openDayTypeTemplateEditor(type); // Reopen with fresh data
    }

    function addTimeBlock() {
      const todayPlan = Helpers.getDayPlan();
      const newBlock = {
        id: stateManager.generateId(),
        time: '09:00',
        title: 'New Time Block',
        completed: false
      };
      todayPlan.time_blocks.push(newBlock);
      state.DayPlans[todayPlan.date] = todayPlan;
      stateManager.update({ DayPlans: state.DayPlans });
      render();
    }

    function updateTimeBlock(id, field, value) {
      const todayPlan = Helpers.getDayPlan();
      const block = todayPlan.time_blocks.find(b => b.id === id);
      if (block) {
        block[field] = value;
        state.DayPlans[todayPlan.date] = todayPlan;
        stateManager.update({ DayPlans: state.DayPlans });
      }
    }

    function removeTimeBlock(id) {
      const todayPlan = Helpers.getDayPlan();
      todayPlan.time_blocks = todayPlan.time_blocks.filter(b => b.id !== id);
      state.DayPlans[todayPlan.date] = todayPlan;
      stateManager.update({ DayPlans: state.DayPlans });
      render();
    }

    function toggleTimeBlockCompletion(id) {
      const todayPlan = Helpers.getDayPlan();
      const block = todayPlan.time_blocks.find(b => b.id === id);
      if (block) {
        block.completed = !block.completed;
        if (block.completed) {
          Helpers.logActivity('time_block_completed', `Completed time block: ${block.title}`, { blockId: block.id });
        }
        state.DayPlans[todayPlan.date] = todayPlan;
        stateManager.update({ DayPlans: state.DayPlans });
        Helpers.saveProgressSnapshot();
        render();
      }
    }

    function saveGoals() {
      const todayPlan = Helpers.getDayPlan();
      const baseline = document.getElementById('baseline-goal')?.value || todayPlan.baseline_goal.text;
      const stretch = document.getElementById('stretch-goal')?.value || todayPlan.stretch_goal.text;
      
      todayPlan.baseline_goal.text = baseline;
      todayPlan.stretch_goal.text = stretch;
      state.DayPlans[todayPlan.date] = todayPlan;
      stateManager.update({ DayPlans: state.DayPlans });
      UI.showToast('Goals Saved', 'Your daily goals have been updated', 'success');
    }

    function toggleGoalCompletion(type) {
      const todayPlan = Helpers.getDayPlan();
      todayPlan[`${type}_goal`].completed = !todayPlan[`${type}_goal`].completed;
      if (todayPlan[`${type}_goal`].completed) {
        const goalType = type === 'baseline' ? 'Baseline' : 'Stretch';
        Helpers.logActivity('goal_achieved', `Achieved ${goalType} Goal: ${todayPlan[`${type}_goal`].text}`, { goalType: type });
      }
      state.DayPlans[todayPlan.date] = todayPlan;
      stateManager.update({ DayPlans: state.DayPlans });
      Helpers.saveProgressSnapshot();
      render();
    }

    function openCreateModal() {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const usedLetters = state.AZTask.map(t => t.letter);
      const availableLetters = letters.filter(l => !usedLetters.includes(l));
      
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Create Aâ€“Z Task</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Letter</label>
              <select id="modal-letter" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2">
                ${availableLetters.map(l => `<option value="${l}">${l}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Task Description</label>
              <input
                id="modal-task"
                type="text"
                placeholder="What needs to be done?"
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Notes (Optional)</label>
              <textarea
                id="modal-notes"
                placeholder="Additional details..."
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
                rows="3"
              ></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button onclick="UI.closeModal()" class="px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
              Cancel
            </button>
            <button onclick="createTask()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Create Task
            </button>
          </div>
        </div>
      `;
      
      UI.showModal(content);
    }

    function openEditModal(id) {
      const task = state.AZTask.find(t => t.id === id);
      if (!task) return;
      
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Edit Task ${task.letter}</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Task Description</label>
              <input
                id="edit-task"
                type="text"
                value="${UI.sanitize(task.task)}"
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Notes</label>
              <textarea
                id="edit-notes"
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
                rows="3"
              >${UI.sanitize(task.notes || '')}</textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Status</label>
              <select id="edit-status" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2">
                <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button onclick="UI.closeModal()" class="px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
              Cancel
            </button>
            <button onclick="updateTask('${task.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Update Task
            </button>
          </div>
        </div>
      `;
      
      UI.showModal(content);
    }

    function createTask() {
      const letter = document.getElementById('modal-letter').value;
      const task = document.getElementById('modal-task').value;
      const notes = document.getElementById('modal-notes').value;

      const newTask = {
        id: stateManager.generateId(),
        letter,
        task: task.trim(),
        notes: notes.trim(),
        status: 'Not Started',
        createdAt: new Date().toISOString()
      };

      // Validate task data
      const validationErrors = DataValidator.validateTask(newTask);
      if (validationErrors.length > 0) {
        UI.showToast('Validation Error', validationErrors[0], 'error');
        return;
      }

      state.AZTask.push(newTask);
      state.AZTask.sort((a, b) => a.letter.localeCompare(b.letter));
      Helpers.logActivity('task_created', `Created A-Z Task: ${letter} - ${task.trim()}`, { taskId: newTask.id });
      stateManager.update({ AZTask: state.AZTask });
      UI.closeModal();
      render();
      UI.showToast('Task Created', `${letter} â€“ ${task}`, 'success');
    }

    function updateTask(id) {
      const task = state.AZTask.find(t => t.id === id);
      if (!task) return;

      const oldStatus = task.status;
      task.task = document.getElementById('edit-task').value.trim();
      task.notes = document.getElementById('edit-notes').value.trim();
      task.status = document.getElementById('edit-status').value;

      // Validate updated task data
      const validationErrors = DataValidator.validateTask(task);
      if (validationErrors.length > 0) {
        UI.showToast('Validation Error', validationErrors[0], 'error');
        return;
      }

      if (oldStatus !== task.status && task.status === 'Completed') {
        Helpers.logActivity('task_completed', `Completed A-Z Task: ${task.letter} - ${task.task}`, { taskId: task.id });
      } else if (oldStatus !== task.status) {
        Helpers.logActivity('task_updated', `Updated A-Z Task: ${task.letter} - ${task.task} (${task.status})`, { taskId: task.id });
      }

      stateManager.update({ AZTask: state.AZTask });
      UI.closeModal();
      render();
      UI.showToast('Task Updated', `${task.letter} â€“ ${task.task}`, 'success');
    }

    function exportState() {
      const dataStr = JSON.stringify(state, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `cycleboard-backup-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // Track export statistics
      localStorage.setItem('cycleboard-last-export', new Date().toISOString());
      const exportCount = parseInt(localStorage.getItem('cycleboard-export-count') || '0');
      localStorage.setItem('cycleboard-export-count', (exportCount + 1).toString());

      const dataSize = (JSON.stringify(state).length / 1024).toFixed(1);
      UI.showToast('Export Successful', `Data backed up (${dataSize} KB)`, 'success');
    }

    function showImportModal() {
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Import Data</h2>
          <p class="text-slate-600 dark:text-gray-300 mb-6">
            Import a previously exported JSON file. This will replace your current data.
          </p>
          <div class="border-2 border-dashed border-slate-300 dark:border-gray-600 rounded-lg p-8 text-center">
            <i class="fas fa-file-import text-4xl text-slate-400 dark:text-gray-500 mb-4"></i>
            <p class="text-slate-600 dark:text-gray-300 mb-4">Drag and drop your JSON file here, or click to browse</p>
            <input
              type="file"
              id="import-file"
              accept=".json"
              class="hidden"
              onchange="handleFileImport(event)"
            />
            <label for="import-file" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer">
              Browse Files
            </label>
          </div>
          <div class="flex justify-end mt-6">
            <button onclick="UI.closeModal()" class="px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      UI.showModal(content);
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);

          // Validate imported data
          const validationErrors = DataValidator.validateImportData(imported);
          if (validationErrors.length > 0) {
            UI.showToast('Validation Error', validationErrors[0], 'error');
            return;
          }

          // Migrate data to fill in missing features from older backups
          const defaultState = stateManager.getDefaultState();
          const { migrated, migratedFeatures } = DataValidator.migrateImportData(imported, defaultState);

          // Build confirmation message
          let confirmMsg = 'This will replace all your current data.';
          if (migratedFeatures.length > 0) {
            confirmMsg += `\n\nNote: ${migratedFeatures.length} missing feature(s) will be initialized with defaults:\nâ€¢ ${migratedFeatures.join('\nâ€¢ ')}`;
          }
          confirmMsg += '\n\nContinue?';

          if (confirm(confirmMsg)) {
            // Reset state and apply migrated data
            Object.keys(state).forEach(key => delete state[key]);
            Object.assign(state, migrated);
            stateManager.update(state);

            // Track import statistics
            localStorage.setItem('cycleboard-last-import', new Date().toISOString());

            UI.closeModal();
            render();

            const dataSize = (JSON.stringify(migrated).length / 1024).toFixed(1);
            let successMsg = `Data restored (${dataSize} KB)`;
            if (migratedFeatures.length > 0) {
              successMsg += ` - ${migratedFeatures.length} feature(s) migrated`;
            }
            UI.showToast('Import Successful', successMsg, 'success');
          }
        } catch (err) {
          console.error('Import error:', err);
          UI.showToast('Import Failed', 'The file is not a valid CycleBoard backup', 'error');
        }
      };
      reader.readAsText(file);
    }

    function clearData() {
      if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
        localStorage.removeItem('cycleboard-state');
        state = stateManager.getDefaultState();
        stateManager.update(state);
        render();
        UI.showToast('Data Cleared', 'All data has been deleted', 'warning');
      }
    }

    function resetToDefaults() {
      if (confirm('Reset all settings to defaults?')) {
        state.Settings = stateManager.getDefaultState().Settings;
        stateManager.update({ Settings: state.Settings });
        render();
        UI.showToast('Settings Reset', 'All settings restored to defaults', 'success');
      }
    }

    function toggleSetting(setting) {
      state.Settings[setting] = !state.Settings[setting];
      stateManager.update({ Settings: state.Settings });
      render();
    }

    function updateSetting(setting, value) {
      state.Settings[setting] = value;
      stateManager.update({ Settings: state.Settings });
    }

    function toggleDarkMode() {
      state.Settings.darkMode = !state.Settings.darkMode;
      stateManager.update({ Settings: state.Settings });
      
      if (state.Settings.darkMode) {
        document.documentElement.classList.add('dark');
        document.body.classList.add('bg-gray-900', 'text-white');
        document.body.classList.remove('bg-slate-50');
      } else {
        document.documentElement.classList.remove('dark');
        document.body.classList.remove('bg-gray-900', 'text-white');
        document.body.classList.add('bg-slate-50');
      }
      
      render();
    }

    // Routine Management Functions
    function addNewRoutineType() {
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Create New Routine</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Routine Name</label>
              <input
                id="new-routine-name"
                type="text"
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
                placeholder="e.g., Workout, Afternoon, Work"
              />
            </div>
            <div class="text-sm text-slate-500 dark:text-gray-400">
              <p class="mb-2">Suggested routines:</p>
              <div class="flex flex-wrap gap-2">
                <button onclick="document.getElementById('new-routine-name').value='Workout'; document.getElementById('new-routine-name').focus();"
                        class="px-3 py-1 bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded-full text-xs hover:bg-green-200 dark:hover:bg-green-900/50">
                  Workout
                </button>
                <button onclick="document.getElementById('new-routine-name').value='Afternoon'; document.getElementById('new-routine-name').focus();"
                        class="px-3 py-1 bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 rounded-full text-xs hover:bg-orange-200 dark:hover:bg-orange-900/50">
                  Afternoon
                </button>
                <button onclick="document.getElementById('new-routine-name').value='Work'; document.getElementById('new-routine-name').focus();"
                        class="px-3 py-1 bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300 rounded-full text-xs hover:bg-indigo-200 dark:hover:bg-indigo-900/50">
                  Work
                </button>
                <button onclick="document.getElementById('new-routine-name').value='Bedtime'; document.getElementById('new-routine-name').focus();"
                        class="px-3 py-1 bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 rounded-full text-xs hover:bg-purple-200 dark:hover:bg-purple-900/50">
                  Bedtime
                </button>
              </div>
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="createNewRoutine()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Create Routine
            </button>
            <button onclick="UI.closeModal()" class="flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-slate-300 dark:hover:bg-gray-600">
              Cancel
            </button>
          </div>
        </div>
      `;
      UI.showModal(content);
      setTimeout(() => document.getElementById('new-routine-name').focus(), 100);
    }

    function createNewRoutine() {
      const name = document.getElementById('new-routine-name').value.trim();
      if (!name) {
        UI.showToast('Error', 'Please enter a routine name', 'error');
        return;
      }

      if (state.Routine[name]) {
        UI.showToast('Error', 'A routine with this name already exists', 'error');
        return;
      }

      state.Routine[name] = [];
      stateManager.update({ Routine: state.Routine });
      UI.closeModal();
      render();
      UI.showToast('Routine Created', `${name} routine has been created`, 'success');
      Helpers.logActivity('routine_created', `Created new routine: ${name}`);
    }

    function deleteRoutineType(routineName) {
      if (!confirm(`Delete "${routineName}" routine and all its steps?`)) return;

      delete state.Routine[routineName];
      stateManager.update({ Routine: state.Routine });
      render();
      UI.showToast('Routine Deleted', `${routineName} routine has been deleted`, 'warning');
      Helpers.logActivity('routine_deleted', `Deleted routine: ${routineName}`);
    }

    function addRoutineStep(routineName) {
      if (!state.Routine[routineName]) return;

      state.Routine[routineName].push('New step');
      stateManager.update({ Routine: state.Routine });
      render();

      // Focus on the new input
      setTimeout(() => {
        const inputs = document.querySelectorAll(`input[type="text"]`);
        if (inputs.length > 0) {
          const lastInput = inputs[inputs.length - 1];
          lastInput.focus();
          lastInput.select();
        }
      }, 100);
    }

    function updateRoutineStep(routineName, index, value) {
      if (!state.Routine[routineName]) return;

      const trimmedValue = value.trim();

      // Validate routine step
      const validationErrors = DataValidator.validateRoutineStep(trimmedValue);
      if (validationErrors.length > 0) {
        UI.showToast('Validation Error', validationErrors[0], 'error');
        render(); // Reset to previous value
        return;
      }

      state.Routine[routineName][index] = trimmedValue;
      stateManager.update({ Routine: state.Routine });
      Helpers.logActivity('routine_step_updated', `Updated step in ${routineName} routine`);
    }

    function deleteRoutineStep(routineName, index) {
      if (!state.Routine[routineName]) return;

      state.Routine[routineName].splice(index, 1);
      stateManager.update({ Routine: state.Routine });
      render();
      UI.showToast('Step Deleted', 'Routine step removed', 'info');
      Helpers.logActivity('routine_step_deleted', `Deleted step from ${routineName} routine`);
    }

    function moveRoutineStep(routineName, index, direction) {
      if (!state.Routine[routineName]) return;

      const routine = state.Routine[routineName];
      const newIndex = direction === 'up' ? index - 1 : index + 1;

      if (newIndex < 0 || newIndex >= routine.length) return;

      // Swap items
      [routine[index], routine[newIndex]] = [routine[newIndex], routine[index]];

      stateManager.update({ Routine: state.Routine });
      render();
    }

    function toggleRoutineStep(routineName, stepIndex, completed) {
      const todayPlan = Helpers.getDayPlan();
      if (!todayPlan.routines_completed) todayPlan.routines_completed = {};
      if (!todayPlan.routines_completed[routineName]) {
        todayPlan.routines_completed[routineName] = { completed: false, steps: {} };
      }

      todayPlan.routines_completed[routineName].steps[stepIndex] = completed;

      // Auto-complete routine if all steps are done
      const routine = state.Routine[routineName];
      const completedSteps = Object.values(todayPlan.routines_completed[routineName].steps).filter(Boolean).length;
      if (completedSteps === routine.length) {
        todayPlan.routines_completed[routineName].completed = true;
        UI.showToast('Routine Complete!', `${routineName} routine finished ðŸŽ‰`, 'success');
        Helpers.logActivity('routine_completed', `Completed ${routineName} routine`, { routine: routineName });
      } else {
        todayPlan.routines_completed[routineName].completed = false;
      }

      state.DayPlans[todayPlan.date] = todayPlan;
      stateManager.update({ DayPlans: state.DayPlans });
      render();
    }

    function toggleRoutineComplete(routineName) {
      const todayPlan = Helpers.getDayPlan();
      if (!todayPlan.routines_completed) todayPlan.routines_completed = {};
      if (!todayPlan.routines_completed[routineName]) {
        todayPlan.routines_completed[routineName] = { completed: false, steps: {} };
      }

      const newCompleteState = !todayPlan.routines_completed[routineName].completed;
      todayPlan.routines_completed[routineName].completed = newCompleteState;

      // Mark all steps as completed/uncompleted
      const routine = state.Routine[routineName];
      routine.forEach((step, index) => {
        todayPlan.routines_completed[routineName].steps[index] = newCompleteState;
      });

      state.DayPlans[todayPlan.date] = todayPlan;
      stateManager.update({ DayPlans: state.DayPlans });
      Helpers.saveProgressSnapshot();
      render();

      if (newCompleteState) {
        UI.showToast('Routine Complete!', `${routineName} routine marked as done ðŸŽ‰`, 'success');
        Helpers.logActivity('routine_completed', `Completed ${routineName} routine`, { routine: routineName });
      } else {
        UI.showToast('Routine Unchecked', `${routineName} routine marked as incomplete`, 'info');
      }
    }

    // Journal Management Functions
    function openJournalModal(entryId = null, entryType = 'free') {
      const entry = entryId ? state.Journal.find(e => e.id === entryId) : null;
      const isEdit = !!entry;
      const type = entry ? (entry.entryType || 'free') : entryType;

      const content = `
        <div class="p-6 max-h-[85vh] overflow-y-auto">
          <h2 class="text-2xl font-bold mb-6 dark:text-white">${isEdit ? 'Edit' : 'New'} Journal Entry</h2>

          <div class="space-y-4">
            <!-- Entry Type Selector -->
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Entry Type</label>
              <div class="grid grid-cols-3 gap-2">
                <button type="button" onclick="switchJournalType('free', '${entryId || ''}')"
                        class="p-3 rounded-lg border-2 transition-all ${type === 'free' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-600'}">
                  <i class="fas fa-pen text-blue-500 mb-1"></i>
                  <p class="text-xs font-medium dark:text-gray-300">Free Entry</p>
                </button>
                <button type="button" onclick="switchJournalType('weekly', '${entryId || ''}')"
                        class="p-3 rounded-lg border-2 transition-all ${type === 'weekly' ? 'border-green-500 bg-green-50 dark:bg-green-900/20' : 'border-gray-200 dark:border-gray-600'}">
                  <i class="fas fa-calendar-week text-green-500 mb-1"></i>
                  <p class="text-xs font-medium dark:text-gray-300">Weekly Review</p>
                </button>
                <button type="button" onclick="switchJournalType('gratitude', '${entryId || ''}')"
                        class="p-3 rounded-lg border-2 transition-all ${type === 'gratitude' ? 'border-amber-500 bg-amber-50 dark:bg-amber-900/20' : 'border-gray-200 dark:border-gray-600'}">
                  <i class="fas fa-heart text-amber-500 mb-1"></i>
                  <p class="text-xs font-medium dark:text-gray-300">Gratitude</p>
                </button>
              </div>
            </div>

            <input type="hidden" id="journal-entry-type" value="${type}" />

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Title</label>
              <input
                type="text"
                id="journal-title"
                value="${entry ? UI.sanitize(entry.title) : ''}"
                placeholder="Entry title..."
                class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Content</label>
              <textarea
                id="journal-content"
                rows="8"
                placeholder="Write your thoughts..."
                class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
              >${entry ? UI.sanitize(entry.content) : ''}</textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Tags (comma-separated)</label>
              <input
                type="text"
                id="journal-tags"
                value="${entry && entry.tags ? entry.tags.join(', ') : ''}"
                placeholder="work, personal, reflection..."
                class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Mood (optional emoji)</label>
              <select
                id="journal-mood"
                class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
              >
                <option value="">No mood</option>
                <option value="ðŸ˜Š" ${entry && entry.mood === 'ðŸ˜Š' ? 'selected' : ''}>ðŸ˜Š Happy</option>
                <option value="ðŸ˜Œ" ${entry && entry.mood === 'ðŸ˜Œ' ? 'selected' : ''}>ðŸ˜Œ Peaceful</option>
                <option value="ðŸ¤”" ${entry && entry.mood === 'ðŸ¤”' ? 'selected' : ''}>ðŸ¤” Thoughtful</option>
                <option value="ðŸ’ª" ${entry && entry.mood === 'ðŸ’ª' ? 'selected' : ''}>ðŸ’ª Motivated</option>
                <option value="ðŸ˜“" ${entry && entry.mood === 'ðŸ˜“' ? 'selected' : ''}>ðŸ˜“ Tired</option>
                <option value="ðŸ˜”" ${entry && entry.mood === 'ðŸ˜”' ? 'selected' : ''}>ðŸ˜” Down</option>
                <option value="ðŸŽ‰" ${entry && entry.mood === 'ðŸŽ‰' ? 'selected' : ''}>ðŸŽ‰ Excited</option>
                <option value="ðŸ˜¤" ${entry && entry.mood === 'ðŸ˜¤' ? 'selected' : ''}>ðŸ˜¤ Determined</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Link to A-Z Tasks (optional)</label>
              <select
                id="journal-tasks"
                multiple
                class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                style="height: 120px"
              >
                ${state.AZTask.map(task => `
                  <option value="${task.id}" ${entry && entry.linkedTasks && entry.linkedTasks.includes(task.id) ? 'selected' : ''}>
                    ${task.letter}: ${UI.sanitize(task.task)}
                  </option>
                `).join('')}
              </select>
              <p class="text-xs text-slate-500 dark:text-gray-400 mt-1">Hold Ctrl/Cmd to select multiple</p>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button
              onclick="saveJournalEntry('${entryId || ''}')"
              class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              ${isEdit ? 'Update' : 'Create'} Entry
            </button>
            <button
              onclick="UI.closeModal()"
              class="px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700"
            >
              Cancel
            </button>
          </div>
        </div>
      `;

      UI.showModal(content);
    }

    function saveJournalEntry(entryId) {
      const title = document.getElementById('journal-title').value.trim();
      const content = document.getElementById('journal-content').value.trim();
      const tagsInput = document.getElementById('journal-tags').value.trim();
      const mood = document.getElementById('journal-mood').value;
      const taskSelect = document.getElementById('journal-tasks');
      const linkedTasks = Array.from(taskSelect.selectedOptions).map(opt => opt.value);
      const entryType = document.getElementById('journal-entry-type')?.value || 'free';

      if (!title) {
        UI.showToast('Validation Error', 'Please enter a title', 'error');
        return;
      }

      if (!content) {
        UI.showToast('Validation Error', 'Please enter some content', 'error');
        return;
      }

      if (title.length > 200) {
        UI.showToast('Validation Error', 'Title too long (max 200 characters)', 'error');
        return;
      }

      if (content.length > 5000) {
        UI.showToast('Validation Error', 'Content too long (max 5000 characters)', 'error');
        return;
      }

      const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

      if (entryId) {
        // Update existing entry
        const entryIndex = state.Journal.findIndex(e => e.id === entryId);
        if (entryIndex !== -1) {
          state.Journal[entryIndex] = {
            ...state.Journal[entryIndex],
            title,
            content,
            tags,
            mood,
            linkedTasks,
            entryType,
            updatedAt: new Date().toISOString()
          };
          Helpers.logActivity('journal_updated', `Updated journal entry: ${title}`, { entryId });
          UI.showToast('Entry Updated', 'Journal entry has been updated', 'success');
        }
      } else {
        // Create new entry
        const newEntry = {
          id: 'j' + Date.now(),
          title,
          content,
          tags,
          mood,
          linkedTasks,
          entryType,
          timestamp: new Date().toISOString(),
          createdAt: new Date().toISOString()
        };
        state.Journal.push(newEntry);
        Helpers.logActivity('journal_created', `Created journal entry: ${title}`, { entryId: newEntry.id });
        UI.showToast('Entry Created', 'New journal entry has been saved', 'success');
      }

      stateManager.update({ Journal: state.Journal });
      UI.closeModal();
      render();
    }

    function editJournalEntry(entryId) {
      openJournalModal(entryId);
    }

    function deleteJournalEntry(entryId) {
      const entry = state.Journal.find(e => e.id === entryId);
      if (!entry) return;

      if (confirm(`Delete journal entry "${entry.title}"?`)) {
        state.Journal = state.Journal.filter(e => e.id !== entryId);
        stateManager.update({ Journal: state.Journal });
        Helpers.logActivity('journal_deleted', `Deleted journal entry: ${entry.title}`, { entryId });
        UI.showToast('Entry Deleted', 'Journal entry has been removed', 'success');
        render();
      }
    }

    function sortTasks() {
      state.AZTask.sort((a, b) => a.letter.localeCompare(b.letter));
      stateManager.update({ AZTask: state.AZTask });
      render();
      UI.showToast('Tasks Sorted', 'A-Z tasks sorted alphabetically', 'info');
    }

    function filterTasks(status) {
      azFilter = status;
      render();
    }

    function searchTasks(query) {
      azSearch = query;
      render();
    }

    function completeAllTodayTasks() {
      state.AZTask.forEach(task => {
        if (task.status !== 'Completed') {
          task.status = 'Completed';
        }
      });
      stateManager.update({ AZTask: state.AZTask });
      render();
      UI.showToast('All Tasks Completed', 'Great job completing all tasks!', 'success');
    }

    function addFocusTask(areaId) {
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Add Focus Area Task</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Task Description</label>
              <input
                id="focus-task-text"
                type="text"
                placeholder="What do you want to accomplish?"
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
              />
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button onclick="UI.closeModal()" class="px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
              Cancel
            </button>
            <button onclick="createFocusTask('${areaId}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Add Task
            </button>
          </div>
        </div>
      `;
      UI.showModal(content);
    }

    function createFocusTask(areaId) {
      const text = document.getElementById('focus-task-text').value.trim();
      if (!text) {
        UI.showToast('Error', 'Task description is required', 'error');
        return;
      }
      
      const area = state.FocusArea.find(a => a.id === areaId);
      if (!area) return;
      
      if (!area.tasks) area.tasks = [];
      
      area.tasks.push({
        id: stateManager.generateId(),
        text: text,
        completed: false,
        createdAt: new Date().toISOString()
      });
      
      Helpers.logActivity('focus_task_added', `Added task to ${area.name}: ${text}`, { areaId: areaId });
      stateManager.update({ FocusArea: state.FocusArea });
      UI.closeModal();
      render();
      UI.showToast('Task Added', `Added to ${area.name}`, 'success');
    }

    function toggleFocusTask(areaId, taskId) {
      const area = state.FocusArea.find(a => a.id === areaId);
      if (!area || !area.tasks) return;

      const task = area.tasks.find(t => t.id === taskId);
      if (task) {
        task.completed = !task.completed;
        if (task.completed) {
          Helpers.logActivity('focus_task_completed', `Completed ${area.name} task: ${task.text}`, { areaId: areaId, taskId: taskId });
        }
        stateManager.update({ FocusArea: state.FocusArea });
        Helpers.saveProgressSnapshot();
        render();
      }
    }

    function removeFocusTask(areaId, taskId) {
      const area = state.FocusArea.find(a => a.id === areaId);
      if (!area || !area.tasks) return;
      
      if (confirm('Delete this task?')) {
        area.tasks = area.tasks.filter(t => t.id !== taskId);
        stateManager.update({ FocusArea: state.FocusArea });
        render();
        UI.showToast('Task Deleted', 'Focus task removed', 'warning');
      }
    }

    function addManualNote() {
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Add Manual Note</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">What happened?</label>
              <textarea
                id="manual-note-text"
                placeholder="Document anything not automatically captured..."
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
                rows="5"
              ></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button onclick="UI.closeModal()" class="px-4 py-2 border dark:border-gray-600 dark:text-gray-300 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700">
              Cancel
            </button>
            <button onclick="saveManualNote()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Save Note
            </button>
          </div>
        </div>
      `;
      UI.showModal(content);
    }

    function saveManualNote() {
      const text = document.getElementById('manual-note-text').value.trim();
      if (!text) {
        UI.showToast('Error', 'Note text is required', 'error');
        return;
      }

      Helpers.logActivity('manual_note', text, {});
      UI.closeModal();
      render();
      UI.showToast('Note Added', 'Manual note saved to timeline', 'success');
    }

    // 8 Steps to Success Functions
    function toggleEightStep(stepId) {
      const todayDate = stateManager.getTodayDate();
      if (!state.EightSteps[todayDate]) {
        state.EightSteps[todayDate] = {};
      }
      state.EightSteps[todayDate][stepId] = !state.EightSteps[todayDate][stepId];

      const stepNames = {
        positiveAttitude: 'Positive Attitude',
        beOnTime: 'Be on Time',
        bePrepared: 'Be Prepared',
        workFullDay: 'Work Full Day',
        workTerritory: 'Work Territory',
        greatAttitude: 'Great Attitude',
        knowWhy: 'Know Your Why',
        takeControl: 'Take Control'
      };

      if (state.EightSteps[todayDate][stepId]) {
        Helpers.logActivity('eight_step_completed', `Completed step: ${stepNames[stepId]}`, { step: stepId });

        // Check if all 8 steps completed
        const completedCount = Object.values(state.EightSteps[todayDate]).filter(Boolean).length;
        if (completedCount === 8) {
          UI.showToast('All Steps Complete!', 'You\'ve achieved daily excellence!', 'success');
        }
      }

      stateManager.update({ EightSteps: state.EightSteps });
      render();
    }

    // Contingency Functions
    function activateContingency(type) {
      const contingencyInfo = {
        runningLate: {
          title: 'Running Late Mode',
          icon: 'fa-running',
          color: 'red',
          actions: state.Contingencies.runningLate.actions,
          autoAction: () => {
            UI.showToast('Mode Activated', 'Focus on essentials only', 'warning');
          }
        },
        lowEnergy: {
          title: 'Low Energy Mode',
          icon: 'fa-battery-quarter',
          color: 'yellow',
          actions: state.Contingencies.lowEnergy.actions,
          autoAction: () => {
            setDayType('B');
            UI.showToast('Switched to B-Day', 'Take it easy, focus on baseline', 'info');
          }
        },
        freeTime: {
          title: 'Unexpected Free Time',
          icon: 'fa-gift',
          color: 'green',
          actions: state.Contingencies.freeTime.actions,
          autoAction: () => {
            UI.showToast('Bonus Time!', 'Check your quick wins list', 'success');
          }
        },
        disruption: {
          title: 'Major Disruption',
          icon: 'fa-bolt',
          color: 'purple',
          actions: state.Contingencies.disruption.actions,
          autoAction: () => {
            UI.showToast('Stay Calm', 'Focus on one priority', 'warning');
          }
        }
      };

      const info = contingencyInfo[type];

      const content = `
        <div class="p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-${info.color}-100 dark:bg-${info.color}-900/30 flex items-center justify-center">
              <i class="fas ${info.icon} text-${info.color}-600 dark:text-${info.color}-400 text-xl"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold dark:text-white">${info.title}</h2>
              <p class="text-sm text-slate-500 dark:text-gray-400">Contingency plan activated</p>
            </div>
          </div>

          <div class="bg-slate-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
            <h3 class="font-semibold text-sm text-slate-700 dark:text-gray-300 mb-2">Recommended Actions:</h3>
            <ul class="space-y-2">
              ${info.actions.map(action => `
                <li class="flex items-center gap-2 text-sm dark:text-gray-300">
                  <i class="fas fa-arrow-right text-${info.color}-500"></i>
                  ${action}
                </li>
              `).join('')}
            </ul>
          </div>

          <div class="flex gap-3">
            <button onclick="applyContingency('${type}');UI.closeModal();" class="flex-1 px-4 py-2 bg-${info.color}-600 text-white rounded-lg hover:bg-${info.color}-700">
              Apply & Continue
            </button>
            <button onclick="UI.closeModal()" class="flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 dark:text-white rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500">
              Cancel
            </button>
          </div>
        </div>
      `;

      UI.showModal(content);
    }

    function applyContingency(type) {
      const todayPlan = Helpers.getDayPlan();

      if (type === 'lowEnergy') {
        setDayType('B');
      }

      Helpers.logActivity('contingency_activated', `Activated ${type} contingency plan`, { type });
      UI.showToast('Contingency Applied', 'Your plan has been adjusted', 'success');
    }

    // Momentum Wins Functions
    function addMomentumWin() {
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Log a Win</h2>
          <p class="text-sm text-slate-500 dark:text-gray-400 mb-4">Capture small victories to build momentum</p>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">What did you accomplish?</label>
              <input
                id="momentum-win-text"
                type="text"
                placeholder="e.g., Finished report, had a great meeting..."
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
              />
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="saveMomentumWin()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
              <i class="fas fa-trophy mr-2"></i>Log Win
            </button>
            <button onclick="UI.closeModal()" class="flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-slate-300 dark:hover:bg-gray-600">
              Cancel
            </button>
          </div>
        </div>
      `;
      UI.showModal(content);
      setTimeout(() => document.getElementById('momentum-win-text').focus(), 100);
    }

    function saveMomentumWin() {
      const text = document.getElementById('momentum-win-text').value.trim();
      if (!text) {
        UI.showToast('Error', 'Please describe your win', 'error');
        return;
      }

      const win = {
        id: stateManager.generateId(),
        text: text,
        timestamp: new Date().toISOString(),
        date: stateManager.getTodayDate()
      };

      state.MomentumWins.push(win);
      stateManager.update({ MomentumWins: state.MomentumWins });
      Helpers.logActivity('momentum_win', `Logged win: ${text}`, { winId: win.id });
      UI.closeModal();
      render();
      UI.showToast('Win Logged!', 'Keep the momentum going!', 'success');
    }

    function deleteMomentumWin(winId) {
      if (confirm('Delete this win?')) {
        state.MomentumWins = state.MomentumWins.filter(w => w.id !== winId);
        stateManager.update({ MomentumWins: state.MomentumWins });
        render();
        UI.showToast('Win Removed', '', 'info');
      }
    }

    // Reflection Functions
    function openReflectionModal(type) {
      const templates = {
        weekly: {
          title: 'Weekly Reflection',
          prompts: [
            { id: 'wins', label: '3 Biggest Wins This Week', placeholder: 'What went well?' },
            { id: 'challenges', label: 'Challenges Faced', placeholder: 'What was difficult?' },
            { id: 'lessons', label: 'Lessons Learned', placeholder: 'What would you do differently?' },
            { id: 'priorities', label: 'Top 3 Priorities for Next Week', placeholder: 'What matters most?' }
          ]
        },
        monthly: {
          title: 'Monthly Reflection',
          prompts: [
            { id: 'accomplishments', label: 'Key Accomplishments', placeholder: 'What did you achieve?' },
            { id: 'goals_progress', label: 'Goal Progress', placeholder: 'How are your goals progressing?' },
            { id: 'improvements', label: 'Systems to Improve', placeholder: 'What processes need work?' },
            { id: 'focus', label: 'Next Month Focus', placeholder: 'What will you prioritize?' }
          ]
        },
        quarterly: {
          title: 'Quarterly Reflection',
          prompts: [
            { id: 'milestones', label: 'Major Milestones', placeholder: 'Big achievements this quarter?' },
            { id: 'trends', label: 'Trends & Patterns', placeholder: 'What patterns do you notice?' },
            { id: 'growth', label: 'Growth Areas', placeholder: 'How have you grown?' },
            { id: 'strategy', label: 'Next Quarter Strategy', placeholder: 'Strategic focus going forward?' }
          ]
        },
        yearly: {
          title: 'Year-End Review',
          prompts: [
            { id: 'top5', label: 'Top 5 Achievements', placeholder: 'Your biggest wins this year?' },
            { id: 'transformation', label: 'Personal Transformation', placeholder: 'How have you changed?' },
            { id: 'gratitude', label: 'Gratitude', placeholder: 'What are you grateful for?' },
            { id: 'vision', label: 'Vision for Next Year', placeholder: 'What do you want to accomplish?' }
          ]
        }
      };

      const template = templates[type];
      const content = `
        <div class="p-6 max-h-[80vh] overflow-y-auto">
          <h2 class="text-xl font-bold mb-4 dark:text-white">${template.title}</h2>
          <p class="text-sm text-slate-500 dark:text-gray-400 mb-6">Take time to reflect on your progress</p>

          <div class="space-y-4">
            ${template.prompts.map(prompt => `
              <div>
                <label class="block text-sm font-medium mb-1 dark:text-gray-300">${prompt.label}</label>
                <textarea
                  id="reflection-${prompt.id}"
                  placeholder="${prompt.placeholder}"
                  class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
                  rows="3"
                ></textarea>
              </div>
            `).join('')}

            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Overall Mood</label>
              <select id="reflection-mood" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2">
                <option value="">Select mood...</option>
                <option value="excellent">Excellent</option>
                <option value="good">Good</option>
                <option value="neutral">Neutral</option>
                <option value="challenging">Challenging</option>
                <option value="difficult">Difficult</option>
              </select>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button onclick="saveReflection('${type}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Save Reflection
            </button>
            <button onclick="UI.closeModal()" class="flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-slate-300 dark:hover:bg-gray-600">
              Cancel
            </button>
          </div>
        </div>
      `;

      UI.showModal(content);
    }

    function saveReflection(type) {
      const prompts = {
        weekly: ['wins', 'challenges', 'lessons', 'priorities'],
        monthly: ['accomplishments', 'goals_progress', 'improvements', 'focus'],
        quarterly: ['milestones', 'trends', 'growth', 'strategy'],
        yearly: ['top5', 'transformation', 'gratitude', 'vision']
      };

      const reflection = {
        id: stateManager.generateId(),
        type: type,
        timestamp: new Date().toISOString(),
        mood: document.getElementById('reflection-mood').value,
        responses: {}
      };

      prompts[type].forEach(promptId => {
        const value = document.getElementById(`reflection-${promptId}`).value.trim();
        if (value) {
          reflection.responses[promptId] = value;
        }
      });

      if (Object.keys(reflection.responses).length === 0) {
        UI.showToast('Error', 'Please fill in at least one field', 'error');
        return;
      }

      state.Reflections[type].push(reflection);
      stateManager.update({ Reflections: state.Reflections });
      Helpers.logActivity('reflection_created', `Created ${type} reflection`, { type });
      UI.closeModal();
      render();
      UI.showToast('Reflection Saved', `Your ${type} reflection has been recorded`, 'success');
    }

    function deleteReflection(type, reflectionId) {
      if (confirm('Delete this reflection?')) {
        state.Reflections[type] = state.Reflections[type].filter(r => r.id !== reflectionId);
        stateManager.update({ Reflections: state.Reflections });
        render();
        UI.showToast('Reflection Deleted', '', 'warning');
      }
    }

    function setReflectionTab(tab) {
      state.reflectionTab = tab;
      render();
    }

    function switchJournalType(type, entryId) {
      UI.closeModal();
      setTimeout(() => openJournalModal(entryId || null, type), 100);
    }

    function deleteActivity(activityId) {
      if (confirm('Delete this activity from your timeline?')) {
        state.History.timeline = state.History.timeline.filter(a => a.id !== activityId);
        stateManager.update({ History: state.History });
        render();
        UI.showToast('Activity Deleted', 'Removed from timeline', 'warning');
      }
    }

    function exportTimeline() {
      if (!state.History.timeline || state.History.timeline.length === 0) {
        UI.showToast('No Data', 'Timeline is empty', 'warning');
        return;
      }
      
      const sortedActivities = [...state.History.timeline].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );
      
      let text = 'CYCLEBOARD ACTIVITY TIMELINE\n';
      text += '='.repeat(50) + '\n\n';
      
      const groupedByDate = {};
      sortedActivities.forEach(activity => {
        const date = new Date(activity.timestamp).toISOString().slice(0, 10);
        if (!groupedByDate[date]) groupedByDate[date] = [];
        groupedByDate[date].push(activity);
      });
      
      Object.keys(groupedByDate).forEach(date => {
        const dateObj = new Date(date);
        text += `ðŸ“… ${dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n`;
        text += '-'.repeat(50) + '\n';
        
        groupedByDate[date].forEach(activity => {
          const time = new Date(activity.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
          text += `${time} - ${activity.description}\n`;
          if (activity.details.note) {
            text += `  Note: ${activity.details.note}\n`;
          }
        });
        
        text += '\n';
      });
      
      const dataBlob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `cycleboard-timeline-${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      UI.showToast('Timeline Exported', 'Downloaded as text file', 'success');
    }

    function init() {
      const menuToggle = document.getElementById('mobile-menu-toggle');
      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          const sidebar = document.getElementById('sidebar');
          const isHidden = sidebar.classList.contains('hidden');
          if (isHidden) {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('block');
          } else {
            sidebar.classList.add('hidden');
            sidebar.classList.remove('block');
          }
        });
      }
      
      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('mobile-menu-toggle');
        if (sidebar && !sidebar.contains(e.target) && !menuToggle.contains(e.target) && window.innerWidth < 768) {
          sidebar.classList.add('hidden');
          sidebar.classList.remove('block');
        }
      });
      
      UI.updateDateDisplay();
      
      if (state.Settings.darkMode) {
        document.documentElement.classList.add('dark');
        document.body.classList.add('bg-gray-900', 'text-white');
        document.body.classList.remove('bg-slate-50');
      }
      
      render();

      // Periodic backup save every 5 minutes (in case debounce fails)
      setInterval(() => {
        if (state.Settings.autoSave) {
          stateManager.saveToStorage();
        }
      }, 300000);

      // Save before page unload
      window.addEventListener('beforeunload', () => {
        stateManager.saveToStorage();
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Skip if user is typing in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          // Allow Ctrl+S even in input fields
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            e.stopPropagation();
            stateManager.saveToStorage();
            UI.showToast('Saved', 'Data saved successfully', 'success');
          }
          return;
        }

        // Global shortcuts
        if (e.ctrlKey || e.metaKey) {
          switch(e.key.toLowerCase()) {
            case 's':
              e.preventDefault();
              e.stopPropagation();
              stateManager.saveToStorage();
              UI.showToast('Saved', 'Data saved successfully', 'success');
              break;
            case 'e':
              e.preventDefault();
              e.stopPropagation();
              exportState();
              break;
            case 'n':
            case 'k':
              e.preventDefault();
              e.stopPropagation();
              if (state.screen === 'AtoZ') {
                openCreateModal();
              } else if (state.screen === 'Daily') {
                addTimeBlock();
              } else {
                UI.showToast('Quick Add', 'Navigate to A-Z or Daily to use this shortcut', 'info');
              }
              break;
            case 'z':
              e.preventDefault();
              if (e.shiftKey) {
                // Redo with Ctrl+Shift+Z
                if (stateManager.redo()) {
                  UI.showToast('Redone', 'Action redone', 'info');
                  render();
                } else {
                  UI.showToast('Nothing to Redo', '', 'warning');
                }
              } else {
                // Undo with Ctrl+Z
                if (stateManager.undo()) {
                  UI.showToast('Undone', 'Action undone', 'info');
                  render();
                } else {
                  UI.showToast('Nothing to Undo', '', 'warning');
                }
              }
              break;
            case 'y':
              // Redo with Ctrl+Y (alternative)
              e.preventDefault();
              if (stateManager.redo()) {
                UI.showToast('Redone', 'Action redone', 'info');
                render();
              } else {
                UI.showToast('Nothing to Redo', '', 'warning');
              }
              break;
          }
        } else {
          // Navigation shortcuts (no modifier key)
          switch(e.key.toLowerCase()) {
            case 'h':
              navigate('Home');
              break;
            case 'd':
              navigate('Daily');
              break;
            case 'a':
              navigate('AtoZ');
              break;
            case 'w':
              navigate('WeeklyFocus');
              break;
            case 't':
              navigate('Timeline');
              break;
            case 'r':
              navigate('Routines');
              break;
            case 's':
              navigate('Statistics');
              break;
            case 'escape':
              UI.closeModal();
              break;
            case '?':
              showKeyboardShortcutsHelp();
              break;
            case 'q':
              openQuickEntryModal();
              break;
          }
        }
      });
    }

    function showKeyboardShortcutsHelp() {
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Keyboard Shortcuts</h2>
          <div class="space-y-4">
            <div>
              <h3 class="font-semibold text-sm text-slate-600 dark:text-gray-400 mb-2">Navigation</h3>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="flex justify-between"><span class="dark:text-gray-300">Home</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">H</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Daily</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">D</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">A-Z Tasks</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">A</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Weekly Focus</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">W</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Timeline</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">T</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Routines</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">R</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Statistics</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">S</kbd></div>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-sm text-slate-600 dark:text-gray-400 mb-2">Actions</h3>
              <div class="grid grid-cols-1 gap-2 text-sm">
                <div class="flex justify-between"><span class="dark:text-gray-300">Save Data</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">Ctrl+S</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Export Data</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">Ctrl+E</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">New Task/Block</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">Ctrl+K / Ctrl+N</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Undo</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">Ctrl+Z</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Redo</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">Ctrl+Y / Ctrl+Shift+Z</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Close Modal</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">Esc</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Quick Entry</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">Q</kbd></div>
                <div class="flex justify-between"><span class="dark:text-gray-300">Show Shortcuts</span><kbd class="px-2 py-1 bg-slate-100 dark:bg-gray-700 rounded">?</kbd></div>
              </div>
            </div>
          </div>
          <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
            <p class="text-xs text-yellow-800 dark:text-yellow-300">
              <i class="fas fa-info-circle mr-1"></i>
              <strong>Note:</strong> Some browsers may block Ctrl+N (opens new tab). Use Ctrl+K as an alternative.
            </p>
          </div>
          <div class="mt-6 flex justify-end">
            <button onclick="UI.closeModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Got it!
            </button>
          </div>
        </div>
      `;
      UI.showModal(content);
    }

    // Quick Entry Modal
    function openQuickEntryModal() {
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Quick Entry</h2>
          <p class="text-sm text-slate-500 dark:text-gray-400 mb-6">Choose an action to perform</p>
          <div class="space-y-3">
            <button onclick="quickAddTask();UI.closeModal();" class="w-full flex items-center gap-4 p-4 border dark:border-gray-600 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700 transition-colors text-left">
              <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-plus-circle text-xl"></i>
              </div>
              <div class="flex-1">
                <p class="font-medium dark:text-gray-300">Quick Task</p>
                <p class="text-sm text-slate-500 dark:text-gray-400">Add a simple A-Z task</p>
              </div>
              <i class="fas fa-chevron-right text-slate-400 dark:text-gray-500"></i>
            </button>

            <button onclick="quickAddTimeBlock();UI.closeModal();" class="w-full flex items-center gap-4 p-4 border dark:border-gray-600 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700 transition-colors text-left">
              <div class="w-12 h-12 rounded-full bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-clock text-xl"></i>
              </div>
              <div class="flex-1">
                <p class="font-medium dark:text-gray-300">Quick Time Block</p>
                <p class="text-sm text-slate-500 dark:text-gray-400">Add a time block to today</p>
              </div>
              <i class="fas fa-chevron-right text-slate-400 dark:text-gray-500"></i>
            </button>

            <button onclick="showRoutineSelector();UI.closeModal();" class="w-full flex items-center gap-4 p-4 border dark:border-gray-600 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700 transition-colors text-left">
              <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-check-circle text-xl"></i>
              </div>
              <div class="flex-1">
                <p class="font-medium dark:text-gray-300">Mark Routine Done</p>
                <p class="text-sm text-slate-500 dark:text-gray-400">Complete a routine</p>
              </div>
              <i class="fas fa-chevron-right text-slate-400 dark:text-gray-500"></i>
            </button>

            <button onclick="quickSetGoal();UI.closeModal();" class="w-full flex items-center gap-4 p-4 border dark:border-gray-600 rounded-lg hover:bg-slate-50 dark:hover:bg-gray-700 transition-colors text-left">
              <div class="w-12 h-12 rounded-full bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-bullseye text-xl"></i>
              </div>
              <div class="flex-1">
                <p class="font-medium dark:text-gray-300">Set Today's Goal</p>
                <p class="text-sm text-slate-500 dark:text-gray-400">Define today's focus</p>
              </div>
              <i class="fas fa-chevron-right text-slate-400 dark:text-gray-500"></i>
            </button>
          </div>
          <div class="mt-6 flex justify-end">
            <button onclick="UI.closeModal()" class="px-4 py-2 bg-slate-200 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-slate-300 dark:hover:bg-gray-600">
              Cancel
            </button>
          </div>
        </div>
      `;
      UI.showModal(content);
    }

    function quickAddTask() {
      openCreateModal();
    }

    function quickAddTimeBlock() {
      navigate('Daily');
      setTimeout(() => addTimeBlock(), 300);
    }

    function showRoutineSelector() {
      navigate('Routines');
    }

    function quickSetGoal() {
      const todayPlan = Helpers.getDayPlan();
      const content = `
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Set Today's Goal</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Baseline Goal</label>
              <input
                id="quick-baseline"
                type="text"
                value="${UI.sanitize(todayPlan.baseline_goal.text)}"
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
                placeholder="What's your minimum win for today?"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">Stretch Goal (Optional)</label>
              <input
                id="quick-stretch"
                type="text"
                value="${UI.sanitize(todayPlan.stretch_goal.text)}"
                class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2"
                placeholder="What would make today amazing?"
              />
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="saveQuickGoal()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Save Goals
            </button>
            <button onclick="UI.closeModal()" class="flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-slate-300 dark:hover:bg-gray-600">
              Cancel
            </button>
          </div>
        </div>
      `;
      UI.showModal(content);
      setTimeout(() => document.getElementById('quick-baseline').focus(), 100);
    }

    function saveQuickGoal() {
      const baseline = document.getElementById('quick-baseline').value.trim();
      const stretch = document.getElementById('quick-stretch').value.trim();

      if (!baseline) {
        UI.showToast('Error', 'Please set a baseline goal', 'error');
        return;
      }

      const todayPlan = Helpers.getDayPlan();
      todayPlan.baseline_goal.text = baseline;
      todayPlan.stretch_goal.text = stretch;

      state.DayPlans[todayPlan.date] = todayPlan;
      stateManager.update({ DayPlans: state.DayPlans });

      UI.closeModal();
      UI.showToast('Goals Set', 'Today\'s goals have been updated', 'success');
      Helpers.logActivity('goals_set', `Set goals: ${baseline}`, { baseline, stretch });
    }

    function render() {
      state = stateManager.getState();
      renderNav();
      UI.updateDateDisplay();
      
      const content = document.getElementById('main-content');
      if (content) {
        const screenContainer = content.querySelector('.max-w-6xl') || content;
        screenContainer.innerHTML = ScreenRenderers[state.screen]();

        if (state.screen === 'AtoZ') {
          const input = document.getElementById('az-search-input');
          if (input && azSearch !== '') {
            input.focus();
            const val = input.value;
            input.value = '';
            input.value = val;
          }
        }
      }
    }

    init();

    // ============================================
    // COGNITIVE CONTROLLER - Brain Integration
    // ============================================

    const CognitiveController = {
      payload: null,
      bannerVisible: true,
      API_BASE: 'http://localhost:3001',
      eventSource: null,
      pollInterval: null,
      pollMs: 30000,
      // Enforcement state
      buildAllowed: true,
      enforcementLevel: 0,
      violationsCount: 0,
      overridesCount: 0,
      overrideAvailable: true,
      primaryOrder: '',

      async init() {
        const loadedUnified = await this.loadUnifiedState();

        // Fallback: Try to load cognitive state from local file
        if (!loadedUnified) {
          try {
            const response = await fetch('cognitive_state.json');
            if (!response.ok) throw new Error('Not found');
            this.payload = await response.json();
            this.applyGovernance();
            console.log('[CognitiveController] Loaded from local file (fallback)');
          } catch (error) {
            console.log('Cognitive system offline. Banner hidden. Run: python refresh.py');
          }
        }

        this.startUnifiedSubscription();
      },

      applyUnifiedPayload(data) {
        if (!data || !data.ok) return;

        // Store enforcement state
        this.buildAllowed = data.derived.build_allowed;
        this.enforcementLevel = data.derived.enforcement_level;
        this.violationsCount = data.derived.violations_count;
        this.overridesCount = data.derived.overrides_count;
        this.overrideAvailable = data.derived.override_available;
        this.primaryOrder = data.derived.primary_order;

        // Build payload from unified data
        this.payload = {
          closure: {
            open: data.derived.open_loops,
            ratio: data.derived.closure_ratio
          },
          loops: data.cognitive?.loops_latest || []
        };
        this.mode = data.derived.mode;
        this.risk = data.derived.risk;
        this.applyGovernance();
      },

      async loadUnifiedState() {
        try {
          const response = await fetch(`${this.API_BASE}/api/state/unified`);
          if (!response.ok) return false;
          const data = await response.json();
          if (!data.ok) return false;
          this.applyUnifiedPayload(data);
          console.log('[CognitiveController] Loaded from unified API');
          return true;
        } catch (e) {
          console.log('[CognitiveController] Unified API unavailable:', e.message);
          return false;
        }
      },

      startUnifiedPolling() {
        if (this.pollInterval) return;
        this.loadUnifiedState();
        this.pollInterval = setInterval(() => {
          this.loadUnifiedState();
        }, this.pollMs);
      },

      startUnifiedSubscription() {
        if (!('EventSource' in window)) {
          this.startUnifiedPolling();
          return;
        }

        const streamUrl = `${this.API_BASE}/api/state/unified/stream`;
        this.eventSource = new EventSource(streamUrl);

        this.eventSource.addEventListener('unified_state', (event) => {
          try {
            const data = JSON.parse(event.data);
            this.applyUnifiedPayload(data);
          } catch (error) {
            console.log('[CognitiveController] Stream parse error:', error);
          }
        });

        this.eventSource.onerror = () => {
          if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
          }
          this.startUnifiedPolling();
        };
      },

      /**
       * Guard build actions. If build not allowed, log violation and show enforcement UI.
       * @param {string} actionName - Name of the action being attempted
       * @param {function} fn - The actual action function to execute if allowed
       * @returns {boolean} - Whether the action was allowed
       */
      async guardBuild(actionName, fn) {
        // If build is allowed, proceed
        if (this.buildAllowed) {
          if (fn) fn();
          return true;
        }

        // If override is pending, allow one action then clear
        if (this.pendingOverride) {
          this.pendingOverride = false;
          console.log(`[Enforcement] Override used for: ${actionName}`);
          if (fn) fn();
          return true;
        }

        // Build not allowed - log violation
        await this.logViolation(actionName);

        // Show enforcement UI based on level
        if (this.enforcementLevel >= 3) {
          this.showHardLockOverlay();
        } else {
          const message = this.showEnforcementMessage(actionName);
          UI.showToast('Build Blocked', message.split('\n')[0], 'error');

          if (this.enforcementLevel >= 2) {
            this.disableBuildControls();
          }
        }

        return false;
      },

      applyGovernance() {
        if (!this.payload) return;

        // Calculate mode from payload
        const closureData = this.payload.closure || {};
        const mode = closureData.ratio < 15 ? 'CLOSURE' :
                     closureData.open > 10 ? 'MAINTENANCE' : 'BUILD';
        const risk = closureData.ratio < 15 ? 'HIGH' :
                     closureData.open > 10 ? 'MEDIUM' : 'LOW';

        // Store for other functions
        this.mode = mode;
        this.risk = risk;

        // Show and update banner
        this.updateDirectiveBanner(mode, risk, closureData);

        // Apply mode-specific policies
        if (mode === 'CLOSURE') {
          this.enforceClosure();
        }

        // Apply risk indicators
        this.applyRiskIndicators(risk);
      },

      updateDirectiveBanner(mode, risk, closureData) {
        const banner = document.getElementById('cognitive-directive');
        const indicator = document.getElementById('cognitive-indicator');
        const indicatorDot = document.getElementById('cognitive-indicator-dot');

        if (!banner) return;

        // Update content
        document.getElementById('directive-mode').textContent = mode;
        document.getElementById('directive-risk').textContent = risk;
        document.getElementById('directive-loops').textContent = closureData.open || '--';

        const topLoop = this.payload.loops?.[0]?.title || 'No loops detected';
        const action = mode === 'CLOSURE' ? `Close or archive: ${topLoop}` :
                       mode === 'MAINTENANCE' ? `Review: ${topLoop}` :
                       'Focus on creation today';
        document.getElementById('directive-action').textContent = action;

        // Color-code by mode
        const colors = {
          'CLOSURE': 'bg-gradient-to-r from-red-600 to-orange-600',
          'MAINTENANCE': 'bg-gradient-to-r from-yellow-600 to-amber-600',
          'BUILD': 'bg-gradient-to-r from-green-600 to-emerald-600'
        };

        const dotColors = {
          'CLOSURE': 'bg-red-500',
          'MAINTENANCE': 'bg-yellow-500',
          'BUILD': 'bg-green-500'
        };

        banner.className = `w-full text-white shadow-lg ${colors[mode]}`;
        banner.style.position = 'sticky';
        banner.style.top = '0';
        banner.style.zIndex = '50';

        if (indicatorDot) {
          indicatorDot.className = `w-4 h-4 rounded-full animate-pulse shadow-lg ${dotColors[mode]}`;
        }

        // Show banner
        banner.style.display = 'block';
        if (indicator) indicator.style.display = 'none';
      },

      enforceClosure() {
        // In CLOSURE mode, apply enforcement based on level
        if (this.enforcementLevel >= 3) {
          this.showHardLockOverlay();
        } else if (this.enforcementLevel >= 2) {
          this.disableBuildControls();
        }
      },

      // === ENFORCEMENT SYSTEM ===

      async logViolation(actionName) {
        try {
          const response = await fetch(`${this.API_BASE}/api/law/violation`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: actionName, context: { screen: state?.screen || 'unknown' } })
          });
          const data = await response.json();
          if (data.success) {
            this.violationsCount = data.violations_count;
            this.enforcementLevel = data.enforcement_level;
            console.log(`[Enforcement] Violation logged: ${actionName} (level ${this.enforcementLevel})`);
          }
          return data;
        } catch (e) {
          console.error('[Enforcement] Failed to log violation:', e);
          return null;
        }
      },

      async logOverride(reason) {
        try {
          const response = await fetch(`${this.API_BASE}/api/law/override`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
          });
          const data = await response.json();
          if (data.success) {
            this.overridesCount = data.overrides_count;
            console.log(`[Enforcement] Override logged: ${reason}`);
          }
          return data;
        } catch (e) {
          console.error('[Enforcement] Failed to log override:', e);
          return null;
        }
      },

      async logClosureAction(title, outcome) {
        try {
          const response = await fetch(`${this.API_BASE}/api/law/close_loop`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, outcome })
          });
          const data = await response.json();
          if (data.success) {
            this.violationsCount = 0;
            this.enforcementLevel = 0;
            UI.showToast('Loop Closed', 'Violations reset. Build surfaces unlocked.', 'success');
            this.hideHardLockOverlay();
            this.enableBuildControls();
            await this.init(); // Refresh state
          }
          return data;
        } catch (e) {
          console.error('[Enforcement] Failed to log closure:', e);
          return null;
        }
      },

      showEnforcementMessage(actionName) {
        const messages = {
          0: `âš ï¸ WARNING: You are in CLOSURE mode.\n\nOrder: ${this.primaryOrder}\n\nClose a loop before building.`,
          1: `ðŸš« VIOLATION: Build attempt blocked.\n\nOrder: ${this.primaryOrder}\n\nPlease ACKNOWLEDGE ORDER or close a loop.`,
          2: `ðŸ”’ BUILD DISABLED: Too many violations (${this.violationsCount}).\n\nOrder: ${this.primaryOrder}\n\nClose or archive a loop to continue.`,
          3: `ðŸ”´ HARD LOCK: Build surfaces locked until compliance.\n\nOrder: ${this.primaryOrder}\n\nUse Override (logged) or close a loop.`
        };
        return messages[Math.min(this.enforcementLevel, 3)];
      },

      showHardLockOverlay() {
        if (document.getElementById('enforcement-overlay')) return;

        const overlay = document.createElement('div');
        overlay.id = 'enforcement-overlay';
        overlay.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[100]';
        overlay.innerHTML = `
          <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-lg mx-4 text-center">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-lock text-3xl text-red-600 dark:text-red-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-2">BUILD LOCKED</h2>
            <p class="text-slate-600 dark:text-gray-300 mb-4">Violations: ${this.violationsCount}</p>
            <p class="text-sm text-slate-500 dark:text-gray-400 mb-6">${this.primaryOrder}</p>
            <div class="space-y-3">
              <button onclick="CognitiveController.handleAcknowledgeOrder()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i class="fas fa-check mr-2"></i>ACKNOWLEDGE ORDER
              </button>
              <button onclick="CognitiveController.handleArchiveLoop()" class="w-full px-4 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                <i class="fas fa-archive mr-2"></i>ARCHIVE LOOP
              </button>
              <button onclick="CognitiveController.handleCloseLoop()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                <i class="fas fa-check-circle mr-2"></i>CLOSE LOOP
              </button>
              ${this.overrideAvailable ? `
              <button onclick="CognitiveController.handleOverride()" class="w-full px-4 py-3 border border-red-500 text-red-500 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                <i class="fas fa-exclamation-triangle mr-2"></i>OVERRIDE (Logged)
              </button>
              ` : ''}
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
      },

      hideHardLockOverlay() {
        const overlay = document.getElementById('enforcement-overlay');
        if (overlay) overlay.remove();
      },

      disableBuildControls() {
        // Add disabled styling to build buttons
        const buildButtons = document.querySelectorAll('[onclick*="openCreateModal"], [onclick*="addTimeBlock"], [onclick*="addFocusTask"], [onclick*="createNewRoutine"], [onclick*="addMomentumWin"]');
        buildButtons.forEach(btn => {
          btn.classList.add('opacity-50', 'cursor-not-allowed');
          btn.setAttribute('data-enforcement-disabled', 'true');
        });
      },

      enableBuildControls() {
        const disabledButtons = document.querySelectorAll('[data-enforcement-disabled="true"]');
        disabledButtons.forEach(btn => {
          btn.classList.remove('opacity-50', 'cursor-not-allowed');
          btn.removeAttribute('data-enforcement-disabled');
        });
      },

      async handleAcknowledgeOrder() {
        try {
          const response = await fetch(`${this.API_BASE}/api/law/acknowledge`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order: this.primaryOrder })
          });
          if (response.ok) {
            UI.showToast('Order Acknowledged', 'Now execute your primary action.', 'success');
            this.hideHardLockOverlay();
          }
        } catch (e) {
          UI.showToast('Error', 'Could not acknowledge order', 'error');
        }
      },

      async handleArchiveLoop() {
        const reason = prompt('Reason for archiving (optional):');
        if (reason === null) return;
        await this.logClosureAction(this.primaryOrder, 'archived');
      },

      async handleCloseLoop() {
        if (confirm('Mark this loop as CLOSED (completed)?')) {
          await this.logClosureAction(this.primaryOrder, 'closed');
        }
      },

      async handleOverride() {
        const reason = prompt('Reason for override (required):');
        if (!reason) {
          UI.showToast('Override Cancelled', 'A reason is required', 'error');
          return;
        }
        await this.logOverride(reason);
        this.hideHardLockOverlay();
        this.pendingOverride = true;
        UI.showToast('Override Granted', 'One build action allowed. Logged to delta ledger.', 'info');
      },

      pendingOverride: false,

      applyRiskIndicators(risk) {
        // Add risk badge to sidebar if not exists
        const sidebar = document.getElementById('sidebar');
        if (sidebar && !document.getElementById('cognitive-risk-badge')) {
          const badge = document.createElement('div');
          badge.id = 'cognitive-risk-badge';
          badge.className = `mx-4 mb-4 px-3 py-2 rounded-lg text-center text-sm font-bold ${
            risk === 'HIGH' ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' :
            risk === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' :
            'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
          }`;
          badge.innerHTML = `<i class="fas fa-brain mr-1"></i> ${risk} RISK`;
          sidebar.insertBefore(badge, sidebar.firstChild);
        }
      },

      getMode() {
        return this.mode || 'OFFLINE';
      },

      getRisk() {
        return this.risk || 'UNKNOWN';
      },

      getOpenLoops() {
        return this.payload?.loops || [];
      },

      isClosureMode() {
        return this.mode === 'CLOSURE';
      }
    };

    function toggleCognitiveBanner() {
      const banner = document.getElementById('cognitive-directive');
      const indicator = document.getElementById('cognitive-indicator');

      if (banner.style.display !== 'none') {
        banner.style.display = 'none';
        indicator.style.display = 'block';
      } else {
        banner.style.display = 'block';
        indicator.style.display = 'none';
      }
    }

    function openControlPanel() {
      window.open('control_panel.html', '_blank');
    }

    // === GUARDED BUILD WRAPPERS ===
    // These wrap build actions to enforce governance

    // Store original functions
    const _originalOpenCreateModal = openCreateModal;
    const _originalAddTimeBlock = addTimeBlock;
    const _originalAddFocusTask = addFocusTask;
    const _originalCreateNewRoutine = createNewRoutine;
    const _originalAddMomentumWin = addMomentumWin;

    // Override with guarded versions
    openCreateModal = function() {
      CognitiveController.guardBuild('openCreateModal', _originalOpenCreateModal);
    };

    addTimeBlock = function() {
      CognitiveController.guardBuild('addTimeBlock', _originalAddTimeBlock);
    };

    // addFocusTask takes a parameter, so we need a different approach
    const _guardedAddFocusTask = function(areaId) {
      CognitiveController.guardBuild('addFocusTask', () => _originalAddFocusTask(areaId));
    };
    addFocusTask = _guardedAddFocusTask;

    createNewRoutine = function() {
      CognitiveController.guardBuild('createNewRoutine', _originalCreateNewRoutine);
    };

    addMomentumWin = function() {
      CognitiveController.guardBuild('addMomentumWin', _originalAddMomentumWin);
    };

    // Initialize cognitive controller after main app
    CognitiveController.init();

  </script>
</body>
</html>
