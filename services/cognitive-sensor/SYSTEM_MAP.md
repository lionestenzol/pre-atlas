# System Map

## Complete File Inventory

```
services/cognitive-sensor/
│
├── DATA SOURCES
│   ├── memory_db.json (140 MB) - Source: ChatGPT export
│   └── conversations.json - Raw export from ChatGPT
│
├── DATABASE
│   └── results.db (SQLite)
│       ├── messages (93,898 rows)
│       ├── topics (13,934 rows)
│       ├── convo_time (1,397 rows)
│       ├── convo_titles (1,397 rows)
│       └── loop_decisions (1 row)
│
├── INITIALIZATION SCRIPTS (Run once or on data update)
│   ├── init_results_db.py - Creates messages table
│   ├── init_topics.py - Extracts topic keywords
│   ├── init_convo_time.py - Adds timestamps
│   └── init_titles.py - Loads conversation titles
│
├── INTELLIGENCE SCRIPTS (Run daily)
│   ├── loops.py - Detects unfinished conversations
│   ├── completion_stats.py - Calculates closure metrics
│   └── radar.py - Shows attention drift
│
├── EXPORT SCRIPTS (Run daily)
│   ├── cognitive_api.py - Query interface
│   ├── export_cognitive_state.py - Generates cognitive_state.json
│   ├── route_today.py - Generates daily_directive.txt
│   └── export_daily_payload.py - Generates daily_payload.json
│
├── INTEGRATION SCRIPTS (Run daily)
│   ├── wire_cycleboard.py - Copies files to CycleBoard
│   ├── reporter.py - Logs to STATE_HISTORY.md
│   └── build_dashboard.py - Generates dashboard.html
│
├── DECISION TOOLS (Run as needed)
│   ├── decide.py - Interactive loop closure
│   └── resurfacer.py - Weekly loop reminder
│
├── ORCHESTRATION
│   └── refresh.py - **MASTER SCRIPT - runs entire pipeline**
│
├── GENERATED STATE FILES
│   ├── cognitive_state.json - Current brain state
│   ├── daily_payload.json - Execution law
│   ├── daily_directive.txt - Human-readable routing
│   ├── loops_latest.json - Top 15 open loops
│   ├── completion_stats.json - Closure statistics
│   ├── STATE_HISTORY.md - Historical log
│   ├── RESURFACER_LOG.md - Weekly loop prompts
│   └── dashboard.html - Analytics interface
│
├── SELF-ANALYSIS PROFILES (Deep pattern analysis)
│   ├── THE_CYCLE.md - The 5-step stuck loop pattern
│   ├── DERAILMENT_FACTORS.md - What knocks you off course
│   ├── CONVERSATION_PATTERNS.md - How you talk, repetition
│   ├── EMOTIONAL_PROFILE.md - Emotional landscape
│   ├── DEEP_PSYCHOLOGICAL_PROFILE.md - Core wounds, attachment, values
│   └── GROWTH_REPORT.md - Fallacies, blindspots, growth opportunities
│
├── INTERFACES
│   └── control_panel.html - Master control interface
│
└── DOCUMENTATION
    ├── README.md - Complete system documentation
    ├── QUICKSTART.md - 5-minute setup guide
    ├── TECHNICAL.md - Architecture and algorithms
    └── SYSTEM_MAP.md - This file
```

## CycleBoard Integration

```
services/cognitive-sensor/cycleboard/
│
├── COGNITIVE BRIDGE
│   └── brain/
│       ├── daily_directive.txt (copied from workspace)
│       ├── cognitive_state.json (copied from workspace)
│       └── daily_payload.json (generated by export_daily_payload.py)
│
└── INTERFACES
    ├── cycleboard_app3.html - Main CycleBoard planning tool
    └── cycleboard_cognitive.html - Full integration with directive banner
```

## Data Flow Diagram

```
┌─────────────────────┐
│ conversations.json  │ (ChatGPT export)
└──────────┬──────────┘
           │
           ↓ init_results_db.py
           ↓ init_topics.py
           ↓ init_convo_time.py
           ↓ init_titles.py
           ↓
┌──────────────────────┐
│    results.db        │ (Single source of truth)
│ ┌──────────────────┐ │
│ │ messages         │ │ ← Message metadata
│ │ topics           │ │ ← Keyword frequency
│ │ convo_time       │ │ ← Timestamps
│ │ convo_titles     │ │ ← Conversation names
│ │ loop_decisions   │ │ ← User decisions
│ └──────────────────┘ │
└──────────┬───────────┘
           │
           ├─→ loops.py ──────────→ loops_latest.json
           │
           ├─→ completion_stats.py → completion_stats.json
           │
           ├─→ radar.py (prints to console)
           │
           └─→ cognitive_api.py
                    ↓
           ┌────────────────────┐
           │ cognitive_state.json│ (Nervous system)
           └────────┬───────────┘
                    │
                    ├─→ route_today.py ──→ daily_directive.txt
                    │
                    └─→ export_daily_payload.py
                             ↓
                    ┌────────────────────┐
                    │ daily_payload.json │ (Execution law)
                    └────────┬───────────┘
                             │
                             ├─→ wire_cycleboard.py
                             │        ↓
                             │   cycleboard/brain/*
                             │        ↓
                             │   CycleBoard HTML
                             │        ↓
                             │   Red/yellow/green banner
                             │   UI lockouts
                             │
                             ├─→ build_dashboard.py
                             │        ↓
                             │   dashboard.html
                             │
                             └─→ reporter.py
                                      ↓
                                 STATE_HISTORY.md
```

## Execution Order

### Initial Setup (One Time)
```
1. Export ChatGPT conversations → conversations.json
2. Run brain.py → creates memory_db.json
3. Run init_results_db.py → creates results.db + messages table
4. Run init_topics.py → adds topics table
5. Run init_convo_time.py → adds convo_time table
6. Run init_titles.py → adds convo_titles table
7. Create indexes (run once)
```

### Daily Refresh (Automated by refresh.py)
```
1. loops.py
   ↓ generates loops_latest.json
2. completion_stats.py
   ↓ generates completion_stats.json
3. export_cognitive_state.py
   ↓ generates cognitive_state.json
4. route_today.py
   ↓ generates daily_directive.txt
5. export_daily_payload.py
   ↓ generates daily_payload.json
6. wire_cycleboard.py
   ↓ copies files to cycleboard/brain/
7. reporter.py
   ↓ appends to STATE_HISTORY.md
8. build_dashboard.py
   ↓ generates dashboard.html
```

### User Actions (As Needed)
```
• decide.py → records decision in loop_decisions table
• resurfacer.py → adds entry to RESURFACER_LOG.md
• Open control_panel.html → view status and take action
• Open CycleBoard → see governed interface
```

## File Dependencies

```
refresh.py requires:
├── loops.py
│   └── requires: results.db (topics, convo_time, convo_titles)
├── completion_stats.py
│   └── requires: results.db (loop_decisions)
├── export_cognitive_state.py
│   └── requires: loops_latest.json
├── route_today.py
│   └── requires: cognitive_state.json
├── export_daily_payload.py
│   └── requires: cognitive_state.json
├── wire_cycleboard.py
│   └── requires: daily_directive.txt, cognitive_state.json, daily_payload.json
├── reporter.py
│   └── requires: radar.py output
└── build_dashboard.py
    └── requires: STATE_HISTORY.md, loops_latest.json, completion_stats.json, results.db
```

## Interface Communication

```
control_panel.html
    ↓ fetch('cognitive_state.json')
    ↓ displays mode, risk, loops, ratio
    ↓ provides action buttons
    ↓ links to other interfaces

dashboard.html
    ↓ reads STATE_HISTORY.md (embedded)
    ↓ reads loops_latest.json (embedded)
    ↓ reads completion_stats.json (embedded)
    ↓ queries results.db for anchors

cycleboard_working.html
    ↓ fetch('brain/daily_payload.json')
    ↓ displays floating directive
    ↓ color-codes by mode
    ↓ reads CycleBoard state from localStorage

cognitive_controller.js
    ↓ fetch('brain/daily_payload.json')
    ↓ updateDirectiveBanner()
    ↓ enforceBuildPolicy() (disables buttons)
    ↓ injectClosureTasks() (adds required tasks)
    ↓ applyRiskIndicators() (adds badges)
```

## State Transitions

```
CLOSURE (Red)
    ↓ User runs decide.py → CLOSE/ARCHIVE
    ↓ closure_ratio increases
    ↓ open_count decreases
    ↓
MAINTENANCE (Yellow)
    ↓ User continues closing loops
    ↓ open_count drops below 10
    ↓
BUILD (Green)
    ↓ User starts new project
    ↓ New loop detected
    ↓ open_count increases
    ↓
    ↓ If ignored, loops accumulate
    ↓
CLOSURE (Red) - cycle repeats
```

## Metrics Tracking

```
loop_decisions table
    ↓ INSERT on each decide.py run
    ↓ Used by completion_stats.py
    ↓
completion_stats.json
    {
      "closed_week": N,
      "archived_week": N,
      "closed_life": N,
      "archived_life": N,
      "closure_ratio": X.XX
    }
    ↓ Read by build_dashboard.py
    ↓ Read by control_panel.html
    ↓
STATE_HISTORY.md
    ↓ Append-only log
    ↓ Captures radar output over time
    ↓ Enables trend analysis
```

## Backup Strategy

### Critical Files (Irreplaceable)
```
memory_db.json - Your conversation history
results.db - Your analyzed data
loop_decisions - Your decision history
STATE_HISTORY.md - Your temporal log

SELF-ANALYSIS PROFILES (Personal insights):
THE_CYCLE.md - Your stuck loop pattern
DERAILMENT_FACTORS.md - What knocks you off course
CONVERSATION_PATTERNS.md - How you communicate
EMOTIONAL_PROFILE.md - Your emotional landscape
DEEP_PSYCHOLOGICAL_PROFILE.md - Core wounds, values, attachment
GROWTH_REPORT.md - Fallacies, blindspots, growth edges
```

**Backup command:**
```bash
tar -czf cognitive_backup_$(date +%Y%m%d).tar.gz \
  memory_db.json \
  results.db \
  STATE_HISTORY.md \
  RESURFACER_LOG.md
```

### Generated Files (Replaceable)
```
cognitive_state.json - Can regenerate from results.db
daily_payload.json - Can regenerate from cognitive_state.json
loops_latest.json - Can regenerate from results.db
completion_stats.json - Can regenerate from results.db
dashboard.html - Can regenerate from above
```

**Recovery:** Run `python refresh.py`

### Scripts (Version Controlled)
```
All *.py files
All *.html interface files
All *.md documentation
```

**Recovery:** Keep in git, or re-download from source

## Port Usage

```
:8080 - Control panel web server
  ↳ python -m http.server 8080
  ↳ Serves services/cognitive-sensor/

:3001 - Delta Kernel REST API
  ↳ npm run api (from services/delta-kernel/)
  ↳ Governance, enforcement, work admission
```

**Why two servers:**
- 8080: Static file serving for HTML interfaces
- 3001: REST API for state management and governance

## Security Boundaries

```
┌─────────────────────────────────────┐
│ Local Machine Only                  │
│ ┌─────────────────────────────────┐ │
│ │ Web Browser                     │ │
│ │ :8080/control_panel.html        │ │
│ │ :8000/cycleboard_working.html   │ │
│ └─────────────┬───────────────────┘ │
│               │ HTTP fetch()        │
│ ┌─────────────▼───────────────────┐ │
│ │ Python Web Servers              │ │
│ │ http.server (no auth)           │ │
│ └─────────────┬───────────────────┘ │
│               │ File read           │
│ ┌─────────────▼───────────────────┐ │
│ │ File System                     │ │
│ │ • Cognitive state files         │ │
│ │ • SQLite database              │ │
│ │ • Conversation history         │ │
│ └─────────────────────────────────┘ │
│                                     │
│ NO EXTERNAL NETWORK                 │
│ NO CLOUD SERVICES                   │
│ NO AUTHENTICATION                   │
└─────────────────────────────────────┘
```

## Extension Points

### Add New Data Source
```
1. Create init_newsource.py
   ↳ Parses external data
   ↳ Inserts into results.db (new table)

2. Update cognitive_api.py
   ↳ Add query function for new data

3. Update export_daily_payload.py
   ↳ Include new data in routing logic

4. Update control_panel.html
   ↳ Display new metrics
```

### Add New Interface
```
1. Create new_interface.html
   ↳ Fetch cognitive_state.json
   ↳ OR fetch daily_payload.json

2. Add to wire_cycleboard.py (if needed)
   ↳ Copy required files to interface location

3. Update refresh.py (if needed)
   ↳ Generate interface-specific data files
```

### Add New Routing Mode
```
1. Edit export_daily_payload.py
   ↳ Add new condition → new mode

2. Edit cognitive_controller.js
   ↳ Handle new mode (color, actions)

3. Edit control_panel.html
   ↳ Display new mode appropriately
```

## Troubleshooting Flow

```
Problem: Control panel shows OFFLINE
    ↓
Check: Does cognitive_state.json exist?
    YES → Is web server running?
        YES → Check browser console for errors
        NO → Run: python -m http.server 8080
    NO → Run: python refresh.py

Problem: Loops not updating after decision
    ↓
Check: Did decide.py complete successfully?
    YES → Did you run refresh.py after?
        YES → Check loop_decisions table
        NO → Run: python refresh.py
    NO → Check for Python errors

Problem: CycleBoard shows old directive
    ↓
Check: Is CycleBoard web server running?
    YES → Did wire_cycleboard.py run?
        YES → Check cycleboard/brain/daily_payload.json
        NO → Run: python wire_cycleboard.py
    NO → Run: START_CYCLEBOARD.bat

Problem: Dashboard not updating
    ↓
Check: Did build_dashboard.py run?
    YES → Is dashboard.html in workspace?
        YES → Hard refresh browser (Ctrl+Shift+R)
        NO → Run: python build_dashboard.py
    NO → Run: python refresh.py
```

---

**This map shows every file, every script, every connection.**

Use it to:
- Understand the complete system
- Debug issues
- Plan extensions
- Navigate the codebase

**Color key for mental model:**
- Data sources = INPUT
- Scripts = TRANSFORMATION
- Generated files = STATE
- Interfaces = OUTPUT
- User actions = FEEDBACK

The system is a closed loop. This map shows how it closes.
